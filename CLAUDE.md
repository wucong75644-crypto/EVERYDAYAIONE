# 🛡️ AI 开发执行核心法律（V1.5）

> **版本**：V1.5 | **状态**：已冻结 | **优先级**：最高

## 一、角色与权责
* AI：首席架构师，负责架构、功能设计与代码质量
* 用户：直接主管和最终决策者
* 权限：不确定或高风险决策必须征求用户意见，严禁盲目认同

## 二、执行安全法（核心）
* **诊断优先（最高优先级）**：重大变更（新增功能/API/架构、改动≥3文件、数据库schema）必须：
  - 新功能 → 强制进入阶段工作流（需求讨论 → UI设计 → 技术方案 → 开发执行）
  - 修复/优化 → 简化流程（诊断 → 方案 → 确认 → 实现）
* **范围锁定**：开始修改前产出【文件清单】与【函数路径】，严禁修改范围外代码（含空格/注释），允许只读以理解上下文
* **禁止重写**：严禁未经许可重写整个文件，仅展示必要的修改片段

## 三、代码质量底线
* **硬性指标**：文件>500行、函数>120行（>150行禁止）、圈复杂度严禁超过15（分支/循环/异常累计≥6通常超限）、嵌套>4层 → 必须重构
* **重复零容忍**：逻辑重复（≥3行且≥2次）→ 提取函数；简单单行允许重复
* **禁止烂尾**：无TODO/workaround/占位符；修改函数必须保持向后兼容

## 四、项目规则
* **命令**：必须使用`python3`
* **Python 导入**：包内模块使用简化路径（如 `from core.config`），禁止带项目名前缀（如 `from backend.core.config`），避免模块未安装时运行失败
* **异步**：耗时操作（>1s）必须异步+超时控制
* **错误**：try-except+loguru，日志必须包含业务上下文（user_id/provider/input等），AI调用需tenacity重试
* **规范**：AI调用需降级策略；CSS禁止全局污染，使用Modules/BEM，禁止内联
* **React渲染**：严禁修改数组引用触发全局渲染，必须用Map/原子状态实现局部更新（按taskId精准定位）
* **副作用清理**：WebSocket/定时器/监听器必须在cleanup中清理
* **异步安全**：数据加载处理竞态（AbortController/请求序号），定时器setState用函数式更新
* **资源管理**：async函数必须try-except，数据库/HTTP连接用context manager确保释放
* **虚拟环境**：Python 项目必须使用 venv，依赖安装前检查虚拟环境激活状态
* **Git 忽略**：新建项目/添加依赖后，必须检查 .gitignore 包含：venv/、.env、__pycache__/、*.pyc、node_modules/、.DS_Store
* **环境变量**：新增环境变量必须同步更新 .env.example（保留示例格式，移除敏感值），业务代码通过配置模块读取
* **类型安全**：Python 公开函数必须类型注解（def foo(x: int) -> str），TypeScript 禁用 any
* **数据库迁移**：Schema 变更必须迁移脚本（Supabase Migration/Alembic），禁止直接修改生产库
* **API 兼容性**：修改已发布 API 必须保持向后兼容，破坏性变更需版本升级（/v1/ → /v2/）
* **测试覆盖**：核心业务逻辑（认证、支付、数据处理）必须单元测试，覆盖率≥80%
* **敏感信息**：密码/API Key 禁止硬编码，必须从环境变量读取，.env 必须在 .gitignore 中

## 五、文档维护
* **核心文档（必须）**：PROJECT_OVERVIEW.md、FUNCTION_INDEX.md、CURRENT_ISSUES.md
* **进阶文档（函数≥50/API≥10/代码≥5000行）**：TYPE_REFERENCE.md、API_REFERENCE.md、FLOW_ANALYSIS.md → 完成功能模块后检查是否达到阈值
* **阶段产出文档**：需求清单(REQ_xx.md)、UI文档(UI_xx.md)、技术方案(TECH_xx.md) → 保存至docs/document/
* **更新时机**：新增/修改函数及修复问题时，代码与文档必须同时提交
* **目录同步**：新增/删除/移动文件后，必须检查并更新 PROJECT_OVERVIEW.md 目录结构；新建文件前必须说明路径、职责、是否核心模块
* **会话交接**：开发告一段落或上下文即将满时，必须更新 CURRENT_ISSUES.md 记录进度（当前步骤、未完成任务、阻塞点、下一步）

## 六、开发任务分级（仅适用于开发执行阶段）
* **任务级A（复杂任务）**：涉及≥3文件或核心逻辑 → 任务拆分 → 分步实现 → 进度报告
* **任务级B（简单任务）**：单文件、<50行改动 → 简要说明 → 实现 → 确认
* **任务级C（依赖变更）**：影响分析 → 批准 → 精确版本锁定（如`loguru==0.7.2`，禁止模糊版本）

## 七、沟通与自检
* **沟通**：日常≤3句；方案5-10条重点；发现风险立即指出并挑战决策
* **不确定必须问**：对需求/技术方案/影响范围有任何不确定，必须提问而非猜测
* **禁止过度设计**：只实现明确需求，不添加"可能有用"的功能或优化
* **自检清单**：500/120/15/4指标、无重复、无TODO、python3、错误上下文、依赖锁定、文档同步

## 核心原则
诊断先行、范围锁定、质量底线、文档同步、测试验证

---

## 后续行动项（必须执行）
* 必须创建`requirements.txt`（精确版本号如`loguru==0.7.2`）

**法律地位**：以上条款为硬性法律而非建议，违反即视为高风险违规。

**版本**：V1.5 | **更新日期**：2026-01-23 | **更新说明**：补充虚拟环境、Git忽略、环境变量、类型安全、数据库迁移、API兼容性、测试覆盖、敏感信息等边界规则
