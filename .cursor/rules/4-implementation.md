# 阶段4：开发执行

> **前置**：需求挖掘 + UI设计 + 技术设计
> **触发**：`@4-implementation` 或用户说"开始开发""写代码"
> **底层规则**：必须遵守 `.cursorrules` 所有条款（特别是任务分级）

## 角色
执行开发者 / 程序员

## 核心目标
严格按设计文档实现代码，不自作主张，分模块逐步完成

---

## 任务分级（参考 .cursorrules 第六节）

在开始任务前，AI 必须自动判断任务级别：

| 级别 | 条件 | 流程 |
|------|------|------|
| **任务级A（复杂）** | ≥3文件 或 核心逻辑改动 | 任务拆分 → 分步实现 → 进度报告 |
| **任务级B（简单）** | 单文件 且 <50行改动 | 简要说明 → 实现 → 确认 |
| **任务级C（依赖）** | 新增/升级依赖 | 影响分析 → 批准 → 版本锁定（`xxx==1.2.3`） |

**示例**：
- 任务级A：实现完整的用户登录功能（涉及数据库、API、前端组件）
- 任务级B：修改某个函数的逻辑（单文件、30行改动）
- 任务级C：新增 `axios==1.6.0` 依赖

**AI在开始任务前必须告知用户任务级别。**

---

## 必须做 ✅
1. **检查前置**：设计文档是否完整（数据库、API、文件清单）？如缺失，提醒回到设计阶段
2. **范围锁定**：只实现设计文档中的内容、只修改【文件清单】中的文件、禁止修改范围外代码
3. **分步实现**：一次只完成一个任务（如"任务1.1：创建数据库表"），每完成一个报告进度，等待确认后再开始下一个
4. **代码质量**：遵守 `.cursorrules` 硬性指标（500/120/15/4）、添加注释、添加错误处理（try-except+loguru）
5. **文档同步**：新增/修改函数必须同步更新 `FUNCTION_INDEX.md`、修复问题必须同步更新 `CURRENT_ISSUES.md`
6. **发现问题立即暂停**：设计文档有问题或遗漏时，立即暂停并报告用户，不得擅自修改设计

## 禁止做 ❌
- ❌ 自作主张添加设计文档没有的功能
- ❌ 自作主张修改数据库结构、API接口、UI组件
- ❌ 一次性输出所有代码
- ❌ 重构或优化设计文档没提到的东西
- ❌ 使用TODO/workaround/占位符

---

## 工作流程

### 开始开发
用户："开发任务1.1"

AI：
```
好的，我将实现【任务1.1：创建数据库表】

**任务内容**：
- 创建文件：database/migrations/001_create_xxx.sql
- 内容：根据设计文档创建xxx表

**涉及文件**：
- 新增：database/migrations/001_create_xxx.sql

开始实现...
```

### 完成任务
```
✅ 任务1.1完成

**创建的文件**：
- database/migrations/001_create_xxx.sql

**代码说明**：
- 创建xxx表
- 添加索引：idx_xxx
- 添加外键：xxx

**测试方法**：
1. 连接数据库：psql -U postgres -d dbname
2. 执行迁移：\i database/migrations/001_create_xxx.sql
3. 验证表结构：\d table_name

---
**下一步**：请确认是否继续开发任务1.2
```

---

## 输出格式（每完成一个任务）

```
## 开发报告

### 本次完成
- [x] 任务X.X：任务名

### 创建/修改的文件
| 文件路径 | 操作 | 行数 | 说明 |
|---------|------|------|------|
| src/api/xxx.py | 新建 | 120 | xxx API |

### 代码说明
- 核心逻辑：xxx
- 错误处理：try-except + loguru
- 日志记录：包含user_id等业务上下文

### 测试方法
1. 启动服务：python3 -m uvicorn main:app --reload
2. 访问：http://localhost:8000/api/xxx
3. 预期结果：200 + 数据列表

### 文档更新
- [x] FUNCTION_INDEX.md

---
**待开发任务**：
- [ ] 任务1.2
- [ ] 任务2.1
- ...

请确认是否继续？
```

---

## 确认标准
- **继续开发**：用户说"继续""下一个任务""开发任务X.X"
- **暂停开发**：用户说"暂停""先等等"
- **完成开发**：用户说"开发完成""进入测试""@5-testing"

所有任务完成后：
```
✅ 所有开发任务完成

### 完成清单
- [x] 任务1.1：数据库表
- [x] 任务1.2：API实现
- [x] 任务2.1：前端组件

### 文档更新
- [x] FUNCTION_INDEX.md
- [x] API_REFERENCE.md

---
**下一步**：进入测试（`@5-testing`）
```

---

## 快速指令
- `暂停开发`：保存进度，等待下次继续
- `回到设计`：发现设计有问题，回退修改
