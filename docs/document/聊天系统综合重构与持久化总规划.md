# èŠå¤©ç³»ç»Ÿç»¼åˆé‡æ„ä¸æŒä¹…åŒ–æ€»è§„åˆ’

> **åˆ›å»ºæ—¶é—´**ï¼š2026-02-01
> **çŠ¶æ€**ï¼šå¾…æ‰§è¡Œ
> **ç›®æ ‡**ï¼šå½»åº•ç†æ¸…èŠå¤©ç³»ç»Ÿæ¶æ„ï¼Œæ¶ˆé™¤å†—ä½™ï¼Œå®ç°å ä½ç¬¦æŒä¹…åŒ–

---

## ğŸ“‹ ç›®å½•

- [ä¸€ã€èƒŒæ™¯ä¸ç°çŠ¶](#ä¸€èƒŒæ™¯ä¸ç°çŠ¶)
- [äºŒã€å®Œæ•´é—®é¢˜æ¸…å•](#äºŒå®Œæ•´é—®é¢˜æ¸…å•)
- [ä¸‰ã€é‡æ„æ€»ä½“æ–¹æ¡ˆ](#ä¸‰é‡æ„æ€»ä½“æ–¹æ¡ˆ)
- [å››ã€åˆ†é˜¶æ®µæ‰§è¡Œè®¡åˆ’](#å››åˆ†é˜¶æ®µæ‰§è¡Œè®¡åˆ’)
- [äº”ã€é£é™©æ§åˆ¶](#äº”é£é™©æ§åˆ¶)
- [å…­ã€æ”¶ç›Šé¢„æœŸ](#å…­æ”¶ç›Šé¢„æœŸ)

---

## ä¸€ã€èƒŒæ™¯ä¸ç°çŠ¶

### 1.1 å·²å®Œæˆçš„å·¥ä½œ

#### âœ… ç¼“å­˜å³çŠ¶æ€é‡æ„ï¼ˆ2026-01-30ï¼‰

**å®Œæˆå†…å®¹**ï¼š
- åˆ é™¤ç»„ä»¶çŠ¶æ€ `MessageArea.messages`ï¼Œæ”¹ç”¨ `useUnifiedMessages` ç»Ÿä¸€è¯»å–
- æ ¼å¼ç»Ÿä¸€ï¼šåˆ é™¤ `CacheMessage`ï¼Œå…¨éƒ¨ä½¿ç”¨ `Message` æ ¼å¼
- æ–°å¢ç»Ÿä¸€æ“ä½œæ–¹æ³•ï¼š`appendMessage`ã€`replaceMessage`ã€`removeMessage`ã€`setMessages`
- ä¿æŒ ChatStore å’Œ RuntimeStore åˆ†ç¦»ï¼ˆæŒä¹…åŒ– vs ä¸´æ—¶ï¼‰

**æ•ˆæœ**ï¼š
- âœ… æ¶ˆé™¤äº†ä¸‰æ•°æ®æºä¸ä¸€è‡´é—®é¢˜
- âœ… åˆ é™¤äº†æ ¼å¼è½¬æ¢ä»£ç 
- âœ… ç»„ä»¶æ— éœ€æ‰‹åŠ¨åˆå¹¶æ¶ˆæ¯

**é—ç•™é—®é¢˜**ï¼š
- âš ï¸ ç¼“å­˜å†™å…¥è·¯å¾„æœªå®Œå…¨ç»Ÿä¸€ï¼ˆé¦–æ¬¡å‘é€ä»ç›´æ¥å†™ ChatStoreï¼‰
- âš ï¸ RuntimeStore ä½¿ç”¨ä¸ä¸€è‡´ï¼ˆé‡æ–°ç”Ÿæˆç»•è¿‡äº† RuntimeStoreï¼‰

---

#### âœ… ç»Ÿä¸€å¤±è´¥é‡æ–°ç”Ÿæˆé€»è¾‘ï¼ˆ2026-01-31ï¼‰

**å®Œæˆå†…å®¹**ï¼š
- ç»Ÿä¸€é‡æ–°ç”Ÿæˆå…¥å£ï¼š`useRegenerateHandlers`
- åŒºåˆ†å¤±è´¥åŸåœ°æ›¿æ¢ï¼ˆimageStrategy/videoStrategyï¼‰å’ŒæˆåŠŸé‡æ–°ç”Ÿæˆï¼ˆregenerateAsNewï¼‰
- å¤ç”¨æ ¸å¿ƒå‘é€é€»è¾‘ï¼ˆexecuteImageGenerationCore/executeVideoGenerationCoreï¼‰

**æ•ˆæœ**ï¼š
- âœ… é‡æ–°ç”Ÿæˆé€»è¾‘ç»Ÿä¸€
- âœ… é¿å…é‡å¤å®ç°æ ¸å¿ƒé€»è¾‘

**é—ç•™é—®é¢˜**ï¼š
- âš ï¸ é¦–æ¬¡å‘é€å’Œé‡æ–°ç”Ÿæˆçš„ç¼“å­˜å†™å…¥è·¯å¾„ä¸ä¸€è‡´
- âš ï¸ å›¾ç‰‡/è§†é¢‘ä»£ç ä»æœ‰ 90-100% é‡å¤

---

### 1.2 æ¶æ„é‡å åˆ†æï¼ˆ2026-02-01ï¼‰

ç»è¿‡å…¨é¢æ·±åº¦åˆ†æï¼Œå‘ç° **47 ä¸ªæ¶æ„é—®é¢˜**ï¼ˆåˆæ­¥16ä¸ª + è¡¥å……31ä¸ªï¼‰ï¼Œæ¶‰åŠï¼š
- ä»£ç é‡å¤ï¼šçº¦ **500 è¡Œé‡å¤ä»£ç **
- çŠ¶æ€ç®¡ç†ï¼šTaskStoreã€RuntimeStoreã€ChatStore èŒè´£é‡å 
- ç¼“å­˜å†™å…¥ï¼šé¦–æ¬¡å‘é€å’Œé‡æ–°ç”Ÿæˆè·¯å¾„ä¸ç»Ÿä¸€
- æ¶ˆæ¯å»é‡ï¼šæ—¶é—´é˜ˆå€¼åŒ¹é…å¯èƒ½è¯¯åˆ¤
- ä¾§è¾¹æ åŒæ­¥ï¼šæ›´æ–°é€»è¾‘åˆ†æ•£ä¸”å­˜åœ¨ç«æ€
- **æ¨¡å‹åˆ‡æ¢**ï¼šç”¨æˆ·é€‰æ‹©ä¸è‡ªåŠ¨æ¢å¤å†²çª
- **é”™è¯¯å¤„ç†**ï¼šæ—¥å¿—ä¸ç»Ÿä¸€ã€æ— é‡è¿æœºåˆ¶
- **æ€§èƒ½é—®é¢˜**ï¼šç¼ºä¹è™šæ‹Ÿæ»šåŠ¨ã€O(nÂ²)åˆå¹¶é€»è¾‘

**åˆ†æè¦†ç›–èŒƒå›´**ï¼š
- âœ… å¹¶å‘ä»»åŠ¡çŠ¶æ€ç®¡ç†ï¼ˆTaskStoreã€RuntimeStoreã€è½®è¯¢ç®¡ç†ï¼‰
- âœ… å›¾ç‰‡/è§†é¢‘æ¶ˆæ¯æµç¨‹ï¼ˆsenderã€handlerã€coreï¼‰
- âœ… é‡æ–°ç”Ÿæˆé€»è¾‘ï¼ˆæˆåŠŸ/å¤±è´¥ä¸¤ç§ç­–ç•¥ï¼‰
- âœ… èŠå¤©æµå¼è¾“å‡ºï¼ˆSSEã€æ¶ˆæ¯åˆå¹¶ï¼‰
- âœ… æ¶ˆæ¯åˆå¹¶ä¸å»é‡ï¼ˆmergeOptimisticMessagesï¼‰
- âœ… ä¾§è¾¹æ çŠ¶æ€åŒæ­¥ï¼ˆconversationOptimisticUpdateï¼‰
- âœ… **å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½**ï¼ˆçŠ¶æ€ç®¡ç†ã€é”™è¯¯å¤„ç†ã€é¢„è§ˆé€»è¾‘ï¼‰
- âœ… **æ¨¡å‹åˆ‡æ¢å’Œå¯¹è¯æ¢å¤**ï¼ˆæ¨¡å‹æ¢å¤ã€å¯¹è¯åˆ‡æ¢ã€ç¼“å­˜TTLï¼‰
- âœ… **é”™è¯¯å¤„ç†ç»Ÿä¸€æ€§**ï¼ˆSSEã€è½®è¯¢ã€APIã€æ˜¾ç¤ºæ–¹å¼ï¼‰
- âœ… **UIæ¸²æŸ“æ€§èƒ½**ï¼ˆè™šæ‹Ÿæ»šåŠ¨ã€æ¶ˆæ¯åˆå¹¶ã€æ‡’åŠ è½½ï¼‰
- âœ… **æ»šåŠ¨ç®¡ç†**ï¼ˆ5ä¸ªHookåè°ƒã€keyç­–ç•¥ã€å¤§æ–‡ä»¶ç»„ä»¶ï¼‰

---

## äºŒã€å®Œæ•´é—®é¢˜æ¸…å•

### 2.1 æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç±»ï¼ˆ47ä¸ªé—®é¢˜æ€»è§ˆï¼‰

**é—®é¢˜æ•°é‡ç»Ÿè®¡**ï¼š
- ğŸ”´ é«˜ä¸¥é‡åº¦ï¼š**18ä¸ª**ï¼ˆåŸ6ä¸ª + æ–°12ä¸ªï¼‰- å¿…é¡»ä¿®å¤
- ğŸŸ¡ ä¸­ä¸¥é‡åº¦ï¼š**23ä¸ª**ï¼ˆåŸ10ä¸ª + æ–°13ä¸ªï¼‰- å»ºè®®ä¿®å¤
- ğŸŸ¢ ä½ä¸¥é‡åº¦ï¼š**6ä¸ª**ï¼ˆåŸ0ä¸ª + æ–°6ä¸ªï¼‰- å¯é€‰ä¼˜åŒ–

#### ğŸ”´ é«˜ä¸¥é‡åº¦ï¼ˆ18ä¸ªï¼‰- å¿…é¡»ä¿®å¤

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | å½±å“ | é‡å¤ä»£ç  |
|---------|---------|------|---------|
| **é—®é¢˜1** | å›¾ç‰‡/è§†é¢‘å‘é€å™¨ä»£ç  90% é‡å¤ | ç»´æŠ¤æˆæœ¬é«˜ï¼Œæ–°å¢æ¨¡å‹éœ€å¤åˆ¶ç²˜è´´ | ~70è¡Œ |
| **é—®é¢˜2** | å›¾ç‰‡/è§†é¢‘å¤„ç†å™¨ä»£ç  100% é‡å¤ | ç»´æŠ¤æˆæœ¬é«˜ | ~60è¡Œ |
| **é—®é¢˜3** | å›¾ç‰‡/è§†é¢‘ç”Ÿæˆæ ¸å¿ƒä»£ç  85% é‡å¤ | ç»´æŠ¤æˆæœ¬é«˜ï¼Œå®¹æ˜“é—æ¼ä¿®æ”¹ | ~180è¡Œ |
| **é—®é¢˜6** | ç¼“å­˜å†™å…¥è·¯å¾„ä¸ç»Ÿä¸€ | è¿èƒŒ"ç¼“å­˜å³çŠ¶æ€"é‡æ„åŸåˆ™ï¼Œç»´æŠ¤ä¸¤å¥—é€»è¾‘ | - |
| **é—®é¢˜7** | RuntimeStore ä½¿ç”¨ä¸ä¸€è‡´ | å ä½ç¬¦ç®¡ç†æ··ä¹±ï¼ŒreplaceMediaPlaceholder å¯èƒ½å¤±è´¥ | - |
| **é—®é¢˜12** | èŠå¤©æµå¼ä»ç„¶ç›´æ¥å†™å…¥ç¼“å­˜ | ä¸é—®é¢˜6ç›¸åŒï¼Œæœªèµ°å…¼å®¹å±‚ | - |

#### ğŸŸ¡ ä¸­ä¸¥é‡åº¦ï¼ˆ10ä¸ªï¼‰- å»ºè®®ä¿®å¤

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | å½±å“ | é‡å¤ä»£ç  |
|---------|---------|------|---------|
| **é—®é¢˜4** | è½®è¯¢ç®¡ç†å™¨é‡å¤å®ç° | ç»´æŠ¤æˆæœ¬é«˜ | ~90è¡Œ |
| **é—®é¢˜5** | ä»»åŠ¡å®Œæˆ/å¤±è´¥é€»è¾‘é‡å¤ | é€šçŸ¥é€»è¾‘ä¸ç»Ÿä¸€ | ~40è¡Œ |
| **é—®é¢˜8** | å ä½ç¬¦ç®¡ç†åˆ†æ•£ | 3ä¸ªä¸åŒæµç¨‹ï¼Œç†è§£å›°éš¾ | - |
| **é—®é¢˜9** | ä»»åŠ¡çŠ¶æ€åŒé‡ç®¡ç† | TaskStore vs RuntimeStore èŒè´£é‡å  | - |
| **é—®é¢˜10** | updateMessageId åœ¨ä¸¤ä¸ª Store é‡å¤è°ƒç”¨ | è¿èƒŒå•ä¸€èŒè´£ | ~10è¡Œ |
| **é—®é¢˜11** | èŠå¤©æµå¼å’Œåª’ä½“ç”Ÿæˆæ¶æ„å·®å¼‚ | SSE vs è½®è¯¢ï¼Œéš¾ä»¥ç»Ÿä¸€ | - |
| **é—®é¢˜13** | å»é‡æ—¶é—´é˜ˆå€¼å¯èƒ½è¯¯åˆ¤ | ç›¸åŒå†…å®¹30ç§’å†…é‡å¤å‘é€ä¼šå»é‡ | - |
| **é—®é¢˜14** | MessageArea å…¼å®¹å±‚é€»è¾‘å¤æ‚ | O(n) éå†ï¼Œå¯èƒ½æœ‰æ€§èƒ½é—®é¢˜ | - |
| **é—®é¢˜15** | ä¾§è¾¹æ æ›´æ–°é€»è¾‘åˆ†æ•£ä¸”ä¸ä¸€è‡´ | èŠå¤©å’Œåª’ä½“å¤„ç†ä¸åŒ | - |
| **é—®é¢˜16** | ä¾§è¾¹æ ç¼“å­˜åŒæ­¥å­˜åœ¨ç«æ€ | ä¹è§‚æ›´æ–°æœªåŒæ­¥ localStorage | - |

---

### 2.2 è¡¥å……åˆ†æå‘ç°çš„é—®é¢˜ï¼ˆ2026-02-01 æ·±åº¦æ¢ç´¢ï¼‰

åœ¨å¯¹å›¾ç‰‡ä¸Šä¼ ã€æ¨¡å‹åˆ‡æ¢ã€é”™è¯¯å¤„ç†ã€UIæ¸²æŸ“å’Œæ»šåŠ¨ç®¡ç†è¿›è¡Œæ·±åº¦åˆ†æåï¼Œé¢å¤–å‘ç° **31 ä¸ªé—®é¢˜**ã€‚

#### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆ12ä¸ªï¼‰- æ–°å¢

| é—®é¢˜ç¼–å· | æ¨¡å— | é—®é¢˜æè¿° | å½±å“ | å…³è”åŸé—®é¢˜ |
|---------|------|---------|------|-----------|
| **é—®é¢˜17** | å›¾ç‰‡ä¸Šä¼  | å¤šå±‚çº§é”™è¯¯åŒæ­¥ï¼ˆInputAreaåŒæ­¥imageUploadErroråˆ°uploadErrorï¼‰ | çŠ¶æ€åŒæ­¥å¤æ‚ï¼ŒuseEffectä¾èµ– | - |
| **é—®é¢˜18** | å›¾ç‰‡ä¸Šä¼  | ImageURLå½¢å¼æ··ç”¨ï¼ˆblob:// vs CDN URLï¼‰ | æ¶ˆæ¯é‡æ–°åŠ è½½æ—¶æ˜¾ç¤ºä¸ä¸€è‡´ | - |
| **é—®é¢˜19** | å›¾ç‰‡ä¸Šä¼  | å›¾ç‰‡URLåˆ†å‰²é€»è¾‘é‡å¤ï¼ˆMessageMediaå’ŒMessageItemï¼‰ | ç»´æŠ¤æˆæœ¬é«˜ | ç±»ä¼¼é—®é¢˜1-3 |
| **é—®é¢˜20** | æ¨¡å‹åˆ‡æ¢ | æ¨¡å‹åˆ‡æ¢ä¸ç”¨æˆ·é€‰æ‹©å†²çª | ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©è¢«è‡ªåŠ¨æ¢å¤è¦†ç›– | - |
| **é—®é¢˜21** | æ¨¡å‹åˆ‡æ¢ | å¯¹è¯åˆ‡æ¢æ—¶æ¶ˆæ¯åŠ è½½çš„ç«æ€æ¡ä»¶ | å¿«é€Ÿåˆ‡æ¢å¯èƒ½åŠ è½½é”™è¯¯å¯¹è¯çš„æ¶ˆæ¯ | - |
| **é—®é¢˜22** | é”™è¯¯å¤„ç† | é”™è¯¯æ—¥å¿—çº§åˆ«ä¸ç»Ÿä¸€ï¼ˆconsole.error/warnæ··ç”¨ï¼‰ | éš¾ä»¥è¿‡æ»¤å’Œè°ƒè¯• | - |
| **é—®é¢˜23** | é”™è¯¯å¤„ç† | é”™è¯¯æ¶ˆæ¯æ ¼å¼ä¸ç»Ÿä¸€ï¼ˆæ— é”™è¯¯ç æ˜ å°„ï¼‰ | å‰ç«¯æ— æ³•å·®å¼‚åŒ–å¤„ç†é”™è¯¯ | - |
| **é—®é¢˜24** | é”™è¯¯å¤„ç† | SSEæµå¼é”™è¯¯æ— é‡è¿æœºåˆ¶ | è¿æ¥ä¸­æ–­éœ€ç”¨æˆ·æ‰‹åŠ¨é‡å‘ | é—®é¢˜11ç›¸å…³ |
| **é—®é¢˜25** | UIæ¸²æŸ“ | ç¼ºä¹è™šæ‹Ÿæ»šåŠ¨ï¼ˆ100+æ¶ˆæ¯æ—¶DOMèŠ‚ç‚¹çˆ†ç‚¸ï¼‰ | å¤§é‡æ¶ˆæ¯æ—¶æ€§èƒ½ä¸‹é™æ˜¾è‘— | é—®é¢˜14ç›¸å…³ |
| **é—®é¢˜26** | UIæ¸²æŸ“ | mergeOptimisticMessagesé¢‘ç¹æ‰§è¡Œï¼ˆO(nÂ²)æ—¶é—´å¤æ‚åº¦ï¼‰ | æ¯æ¬¡æ¶ˆæ¯åˆ°è¾¾éƒ½é‡æ–°åˆå¹¶+æ’åº | é—®é¢˜13ç›¸å…³ |
| **é—®é¢˜27** | UIæ¸²æŸ“ | æ¶ˆæ¯åˆ—è¡¨å…¨é‡éå†ï¼ˆMessageAreaæ¯æ¬¡éƒ½é‡æ–°éå†ï¼‰ | å¤§é‡æ¶ˆæ¯æ—¶æ€§èƒ½é—®é¢˜ | é—®é¢˜14ç›¸å…³ |

#### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆ13ä¸ªï¼‰- æ–°å¢

| é—®é¢˜ç¼–å· | æ¨¡å— | é—®é¢˜æè¿° | å½±å“ | å…³è”åŸé—®é¢˜ |
|---------|------|---------|------|-----------|
| **é—®é¢˜28** | å›¾ç‰‡ä¸Šä¼  | é”™è¯¯æ¶ˆæ¯ä¸å¤Ÿå…·ä½“ï¼ˆä¸Šä¼ å¤±è´¥æ€»æ˜¯æ˜¾ç¤º"ä¸Šä¼ å¤±è´¥"ï¼‰ | ç”¨æˆ·æ— æ³•äº†è§£å…·ä½“åŸå›  | - |
| **é—®é¢˜29** | å›¾ç‰‡ä¸Šä¼  | ObjectURLæ¸…ç†æ—¶æœºé£é™©ï¼ˆ30ç§’å»¶è¿Ÿå¯èƒ½å¯¼è‡´URLå·²é‡Šæ”¾ï¼‰ | æ¶ˆæ¯åŠ è½½æ—¶å›¾ç‰‡å¯èƒ½æ— æ³•æ˜¾ç¤º | - |
| **é—®é¢˜30** | å›¾ç‰‡ä¸Šä¼  | å‘é€å‰æœªæ£€æŸ¥ä¸Šä¼ å®ŒæˆçŠ¶æ€ï¼ˆisUploadingï¼‰ | ç”¨æˆ·å¯èƒ½å‘é€æœªä¸Šä¼ å®Œçš„å›¾ç‰‡ | - |
| **é—®é¢˜31** | æ¨¡å‹åˆ‡æ¢ | LRUæ¸…ç†å¯èƒ½ä¸¢å¤±æ´»è·ƒä»»åŠ¡çŠ¶æ€ï¼ˆç¡¬æ€§é™åˆ¶10ä¸ªï¼‰ | å¿«é€Ÿåˆ‡æ¢>10ä¸ªå¯¹è¯æ—¶ï¼Œè¿è¡Œæ—¶çŠ¶æ€å¯èƒ½è¢«æ¸…é™¤ | é—®é¢˜9ç›¸å…³ |
| **é—®é¢˜32** | æ¨¡å‹åˆ‡æ¢ | ç¼“å­˜è¿‡æœŸæ£€æµ‹çš„æ—¶é—´å·®ï¼ˆ5åˆ†é’ŸTTLä»…åå°æ£€æŸ¥ï¼‰ | ç”¨æˆ·å¯èƒ½çœ‹åˆ°è¿‡æœŸæ•°æ® | - |
| **é—®é¢˜33** | æ¨¡å‹åˆ‡æ¢ | tempæ¶ˆæ¯åˆ¤æ–­ä¸å‡†ç¡®ï¼ˆ30ç§’é˜ˆå€¼+å†…å®¹åŒ¹é…ï¼‰ | å¼±ç½‘ç¯å¢ƒå¯èƒ½æ˜¾ç¤ºé‡å¤æ¶ˆæ¯ | é—®é¢˜13 |
| **é—®é¢˜34** | é”™è¯¯å¤„ç† | å›¾ç‰‡é¢„åŠ è½½æ— é”™è¯¯å¤„ç†ï¼ˆnew Image().srcæ— ç›‘å¬ï¼‰ | é¢„åŠ è½½å¤±è´¥æ—¶ç”¨æˆ·çœ‹åˆ°ç©ºç™½å ä½ç¬¦ | - |
| **é—®é¢˜35** | é”™è¯¯å¤„ç† | æ•°æ®åº“æ“ä½œé”™è¯¯å¤„ç†ä¸å®Œæ•´ï¼ˆä¿å­˜æ¶ˆæ¯å¤±è´¥ç»†èŠ‚ä¸¢å¤±ï¼‰ | è½®è¯¢æˆåŠŸä½†ä¿å­˜å¤±è´¥æ—¶ç”¨æˆ·çœ‹ä¸åˆ°å…·ä½“åŸå›  | - |
| **é—®é¢˜36** | UIæ¸²æŸ“ | å¤šä¸ªæ»šåŠ¨Hooké‡å¤è®¡ç®—ï¼ˆ5ä¸ªç‹¬ç«‹Hookå„è‡ªè¿½è¸ªçŠ¶æ€ï¼‰ | åè°ƒå›°éš¾ï¼Œå¯èƒ½å†²çª | - |
| **é—®é¢˜37** | UIæ¸²æŸ“ | æ— åŠ è½½å¤±è´¥å¤„ç†ï¼ˆæ‡’åŠ è½½å›¾ç‰‡/è§†é¢‘å¤±è´¥æ— é‡è¯•ï¼‰ | ç½‘ç»œé—®é¢˜æ—¶åª’ä½“æ— æ³•æ˜¾ç¤º | - |
| **é—®é¢˜38** | æ»šåŠ¨ç®¡ç† | msg keyç­–ç•¥ä¸ç¨³å®šï¼ˆä½¿ç”¨index fallbackï¼‰ | æ¶ˆæ¯é‡æ’å¯èƒ½å¯¼è‡´Reacté”™ä¹± | - |
| **é—®é¢˜39** | æ»šåŠ¨ç®¡ç† | å¤§æ–‡ä»¶ç»„ä»¶ï¼ˆuseChatStore 668Lã€ImagePreviewModal 499Lï¼‰ | ç»´æŠ¤å›°éš¾ | - |
| **é—®é¢˜40** | ä¾§è¾¹æ  | å¯¹è¯æœç´¢åŠŸèƒ½ç®€å•ï¼ˆä»…æ ‡é¢˜æœç´¢ï¼Œæ— æ¶ˆæ¯å†…å®¹æœç´¢ï¼‰ | ç”¨æˆ·ä½“éªŒå—é™ | é—®é¢˜15ç›¸å…³ |

#### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆ6ä¸ªï¼‰- æ–°å¢

| é—®é¢˜ç¼–å· | æ¨¡å— | é—®é¢˜æè¿° | å½±å“ | å…³è”åŸé—®é¢˜ |
|---------|------|---------|------|-----------|
| **é—®é¢˜41** | å›¾ç‰‡ä¸Šä¼  | å¤šStoreå±‚çº§å¤æ‚ï¼ˆå­¦ä¹ æ›²çº¿é™¡å³­ï¼‰ | æ–°äººç†è§£å›°éš¾ | - |
| **é—®é¢˜42** | æ¨¡å‹åˆ‡æ¢ | æ¨¡å‹é€‰æ‹©å™¨çš„åŠ è½½çŠ¶æ€æŒ‡ç¤ºæ—¶é—´è¿‡é•¿ | ç”¨æˆ·ç­‰å¾…ä½“éªŒå·® | - |
| **é—®é¢˜43** | é”™è¯¯å¤„ç† | éŸ³é¢‘ä¸Šä¼ /å½•åˆ¶é”™è¯¯å¤„ç†ç¼ºå¤±UI | ç”¨æˆ·çœ‹ä¸åˆ°é”™è¯¯ | - |
| **é—®é¢˜44** | æ»šåŠ¨ç®¡ç† | useCallbackä¾èµ–é¡¹ä¼—å¤šï¼ˆmemoå¯èƒ½å¤±æ•ˆï¼‰ | æ½œåœ¨æ€§èƒ½é—®é¢˜ | - |
| **é—®é¢˜45** | æ»šåŠ¨ç®¡ç† | CSSåŠ¨ç”»é¢‘ç¹è§¦å‘ï¼ˆanimate-fadeInç­‰ï¼‰ | GPUè¿‡è½½ | - |
| **é—®é¢˜46** | æ»šåŠ¨ç®¡ç† | localStorageåºåˆ—åŒ–/ååºåˆ—åŒ–ï¼ˆå¤§æ•°æ®é‡æ…¢ï¼‰ | åˆ‡æ¢å¯¹è¯æ—¶å¡é¡¿ | - |

#### è¡¥å……é—®é¢˜æ€»ç»“

- **æ–°å¢é«˜ä¼˜å…ˆçº§**ï¼š12ä¸ªï¼ˆé—®é¢˜17-27ï¼‰
- **æ–°å¢ä¸­ä¼˜å…ˆçº§**ï¼š13ä¸ªï¼ˆé—®é¢˜28-40ï¼‰
- **æ–°å¢ä½ä¼˜å…ˆçº§**ï¼š6ä¸ªï¼ˆé—®é¢˜41-46ï¼‰
- **æ€»è®¡æ–°å¢**ï¼š31ä¸ª

**ä¸åŸæœ‰16ä¸ªé—®é¢˜çš„å…³ç³»**ï¼š
- **é‡å /å…³è”**ï¼šé—®é¢˜13ï¼ˆå»é‡ï¼‰ã€é—®é¢˜14ï¼ˆæ€§èƒ½ï¼‰ã€é—®é¢˜15ï¼ˆä¾§è¾¹æ ï¼‰ã€é—®é¢˜9ï¼ˆçŠ¶æ€ç®¡ç†ï¼‰ã€é—®é¢˜11ï¼ˆæ¶æ„å·®å¼‚ï¼‰
- **å®Œå…¨æ–°å¢**ï¼šå›¾ç‰‡ä¸Šä¼ 7ä¸ªã€æ¨¡å‹åˆ‡æ¢6ä¸ªã€é”™è¯¯å¤„ç†6ä¸ªã€UI/æ»šåŠ¨12ä¸ª
- **ç»¼åˆé—®é¢˜æ•°**ï¼š16ï¼ˆåŸæœ‰ï¼‰+ 31ï¼ˆæ–°å¢ï¼‰= **47ä¸ªæ¶æ„é—®é¢˜**

---

### 2.3 æŒ‰å½±å“èŒƒå›´åˆ†ç±»

#### ä»£ç é‡å¤ï¼ˆ~500è¡Œï¼Œæ–°å¢50è¡Œï¼‰

| é—®é¢˜ | é‡å¤ä»£ç è¡Œæ•° | æ–‡ä»¶ | é—®é¢˜ç¼–å· |
|------|-------------|------|---------|
| å›¾ç‰‡/è§†é¢‘å‘é€å™¨é‡å¤ | ~70è¡Œ | imageSender.ts, videoSender.ts | é—®é¢˜1 |
| å›¾ç‰‡/è§†é¢‘å¤„ç†å™¨é‡å¤ | ~60è¡Œ | useImageMessageHandler.ts, useVideoMessageHandler.ts | é—®é¢˜2 |
| å›¾ç‰‡/è§†é¢‘ç”Ÿæˆæ ¸å¿ƒé‡å¤ | ~180è¡Œ | mediaGenerationCore.ts | é—®é¢˜3 |
| è½®è¯¢ç®¡ç†å™¨é‡å¤ | ~90è¡Œ | useTaskStore.ts, polling.ts | é—®é¢˜4 |
| ä»»åŠ¡é€šçŸ¥é€»è¾‘é‡å¤ | ~40è¡Œ | completeTask vs completeMediaTask | é—®é¢˜5 |
| updateMessageId é‡å¤ | ~10è¡Œ | ChatStore + RuntimeStore | é—®é¢˜10 |
| **å›¾ç‰‡URLåˆ†å‰²é€»è¾‘é‡å¤** | **~20è¡Œ** | **MessageMedia.tsx, MessageItem.tsx** | **é—®é¢˜19** |
| **æ»šåŠ¨Hooké‡å¤è®¡ç®—** | **~30è¡Œ** | **5ä¸ªç‹¬ç«‹æ»šåŠ¨Hook** | **é—®é¢˜36** |

#### æ¶æ„è®¾è®¡ï¼ˆæ‰©å±•åˆ°17ä¸ªæ¶æ„é—®é¢˜ï¼‰

| é—®é¢˜ | å½±å“èŒƒå›´ | é—®é¢˜ç¼–å· |
|------|---------|---------|
| ç¼“å­˜å†™å…¥è·¯å¾„ä¸ç»Ÿä¸€ | é¦–æ¬¡å‘é€ vs é‡æ–°ç”Ÿæˆ | é—®é¢˜6 |
| RuntimeStore ä½¿ç”¨ä¸ä¸€è‡´ | é¦–æ¬¡å‘é€ vs é‡æ–°ç”Ÿæˆ | é—®é¢˜7 |
| ä»»åŠ¡çŠ¶æ€åŒé‡ç®¡ç† | TaskStore vs RuntimeStore | é—®é¢˜9 |
| å ä½ç¬¦ç®¡ç†åˆ†æ•£ | 3ä¸ªä¸åŒæµç¨‹ | é—®é¢˜8 |
| èŠå¤©æµå¼å’Œåª’ä½“æ¶æ„å·®å¼‚ | SSE vs è½®è¯¢ | é—®é¢˜11 |
| **å¤šå±‚çº§é”™è¯¯åŒæ­¥** | **InputArea â†’ UploadErrorBar** | **é—®é¢˜17** |
| **ImageURLå½¢å¼æ··ç”¨** | **blob:// vs CDN URL** | **é—®é¢˜18** |
| **æ¨¡å‹åˆ‡æ¢ä¸ç”¨æˆ·é€‰æ‹©å†²çª** | **useModelSelection** | **é—®é¢˜20** |
| **å¯¹è¯åˆ‡æ¢ç«æ€æ¡ä»¶** | **useMessageLoader** | **é—®é¢˜21** |
| **é”™è¯¯æ—¥å¿—ä¸ç»Ÿä¸€** | **console.error/warnæ··ç”¨** | **é—®é¢˜22** |
| **é”™è¯¯æ¶ˆæ¯æ ¼å¼ä¸ç»Ÿä¸€** | **æ— é”™è¯¯ç æ˜ å°„** | **é—®é¢˜23** |
| **SSEæ— é‡è¿æœºåˆ¶** | **message.ts** | **é—®é¢˜24** |
| **ç¼ºä¹è™šæ‹Ÿæ»šåŠ¨** | **MessageArea** | **é—®é¢˜25** |
| **æ¶ˆæ¯åˆå¹¶æ€§èƒ½å·®** | **mergeOptimisticMessages O(nÂ²)** | **é—®é¢˜26** |
| **æ¶ˆæ¯åˆ—è¡¨å…¨é‡éå†** | **MessageArea.tsx** | **é—®é¢˜27** |
| **LRUæ¸…ç†é™åˆ¶è¿‡ä¸¥** | **Chat.tsxï¼ˆç¡¬æ€§10ä¸ªï¼‰** | **é—®é¢˜31** |
| **msg keyç­–ç•¥ä¸ç¨³å®š** | **ä½¿ç”¨index fallback** | **é—®é¢˜38** |

#### è¾¹ç•Œ Caseï¼ˆæ‰©å±•åˆ°13ä¸ªè¾¹ç•Œé—®é¢˜ï¼‰

| é—®é¢˜ | åœºæ™¯ | é—®é¢˜ç¼–å· |
|------|------|---------|
| å»é‡æ—¶é—´é˜ˆå€¼è¯¯åˆ¤ | 30ç§’å†…å‘é€ç›¸åŒå†…å®¹ | é—®é¢˜13 |
| MessageArea å…¼å®¹å±‚å¤æ‚ | å¤§é‡æ¶ˆæ¯æ—¶æ€§èƒ½é—®é¢˜ | é—®é¢˜14 |
| ä¾§è¾¹æ æ›´æ–°ä¸ä¸€è‡´ | èŠå¤©ä¸æ›´æ–°ï¼Œåª’ä½“æ›´æ–° | é—®é¢˜15 |
| ä¾§è¾¹æ ç¼“å­˜ç«æ€ | ä¹è§‚æ›´æ–°æœªå†™ localStorage | é—®é¢˜16 |
| **ObjectURLæ¸…ç†æ—¶æœºé£é™©** | **30ç§’å»¶è¿Ÿå¯èƒ½å¯¼è‡´URLå·²é‡Šæ”¾** | **é—®é¢˜29** |
| **å‘é€å‰æœªæ£€æŸ¥ä¸Šä¼ çŠ¶æ€** | **isUploadingæ—¶å¯èƒ½å‘é€** | **é—®é¢˜30** |
| **ç¼“å­˜è¿‡æœŸæ£€æµ‹æ—¶é—´å·®** | **5åˆ†é’ŸTTLä»…åå°æ£€æŸ¥** | **é—®é¢˜32** |
| **tempæ¶ˆæ¯åˆ¤æ–­ä¸å‡†ç¡®** | **å¼±ç½‘>30ç§’æ˜¾ç¤ºé‡å¤æ¶ˆæ¯** | **é—®é¢˜33** |
| **å›¾ç‰‡é¢„åŠ è½½æ— é”™è¯¯å¤„ç†** | **é¢„åŠ è½½å¤±è´¥æ˜¾ç¤ºç©ºç™½** | **é—®é¢˜34** |
| **æ•°æ®åº“é”™è¯¯å¤„ç†ä¸å®Œæ•´** | **ä¿å­˜å¤±è´¥ç»†èŠ‚ä¸¢å¤±** | **é—®é¢˜35** |
| **æ‡’åŠ è½½å¤±è´¥æ— é‡è¯•** | **ç½‘ç»œé—®é¢˜åª’ä½“æ— æ³•æ˜¾ç¤º** | **é—®é¢˜37** |
| **å¤§æ–‡ä»¶ç»„ä»¶éš¾ç»´æŠ¤** | **useChatStore 668L** | **é—®é¢˜39** |
| **localStorageæ€§èƒ½é—®é¢˜** | **å¤§æ•°æ®é‡åºåˆ—åŒ–æ…¢** | **é—®é¢˜46** |

---

## ä¸‰ã€é‡æ„æ€»ä½“æ–¹æ¡ˆ

### 3.1 æ ¸å¿ƒåŸåˆ™

1. **å…ˆæ¶ˆé™¤é‡å¤ï¼Œå†ä¼˜åŒ–æ¶æ„** - é‡å¤ä»£ç æ˜¯æœ€æ˜ç¡®çš„é—®é¢˜
2. **çŸ­æœŸä¿®å¤ + ä¸­æœŸé‡æ„ + é•¿æœŸè§„åˆ’** - åˆ†é˜¶æ®µé™ä½é£é™©
3. **æŒä¹…åŒ–åœ¨æ¶æ„æ¸…ç†åå®æ–½** - é¿å…åœ¨æ··ä¹±æ¶æ„ä¸Šå åŠ åŠŸèƒ½

### 3.2 é˜¶æ®µåˆ’åˆ†

```
é˜¶æ®µ0ï¼šçŸ­æœŸä¿®å¤ï¼ˆ1-2å¤©ï¼‰
    â†“ ä¿®å¤æ˜ç¡®çš„è¾¹ç•Œ case å’Œç¼“å­˜å†™å…¥è·¯å¾„
é˜¶æ®µ1ï¼šç»Ÿä¸€ç¼“å­˜å†™å…¥è·¯å¾„ï¼ˆ0.5å¤©ï¼‰
    â†“ æ‰€æœ‰æ¶ˆæ¯æ“ä½œèµ° setMessages å…¼å®¹å±‚
é˜¶æ®µ2ï¼šåˆå¹¶å›¾ç‰‡/è§†é¢‘å‘é€å™¨å’Œå¤„ç†å™¨ï¼ˆ1-2å¤©ï¼‰
    â†“ æ¶ˆé™¤ ~180è¡Œé‡å¤ä»£ç 
é˜¶æ®µ3ï¼šç»Ÿä¸€è½®è¯¢ç®¡ç†å™¨ï¼ˆ0.5å¤©ï¼‰
    â†“ æ¶ˆé™¤ ~90è¡Œé‡å¤ä»£ç 
é˜¶æ®µ4ï¼šæå–ä»»åŠ¡é€šçŸ¥é€»è¾‘ï¼ˆ0.5å¤©ï¼‰
    â†“ æ¶ˆé™¤ ~40è¡Œé‡å¤ä»£ç 
é˜¶æ®µ5ï¼šé‡æ–°è®¾è®¡çŠ¶æ€ç®¡ç†ï¼ˆ2-3å¤©ï¼‰
    â†“ è§£å†³ TaskStore vs RuntimeStore èŒè´£é‡å 
é˜¶æ®µ6ï¼šå ä½ç¬¦æŒä¹…åŒ–ï¼ˆ2-3å¤©ï¼‰â­
    â†“ åœ¨æ¸…æ™°æ¶æ„åŸºç¡€ä¸Šå®ç°æŒä¹…åŒ–
```

**æ€»é¢„ä¼°æ—¶é—´**ï¼š7-12 å¤©

---

## å››ã€åˆ†é˜¶æ®µæ‰§è¡Œè®¡åˆ’

### é˜¶æ®µ0ï¼šçŸ­æœŸä¿®å¤ï¼ˆ1-2å¤©ï¼‰

#### ç›®æ ‡
ä¿®å¤æ˜ç¡®çš„è¾¹ç•Œ case å’Œé«˜ä¼˜å…ˆçº§é—®é¢˜ï¼Œå¿«é€Ÿæå‡ç³»ç»Ÿç¨³å®šæ€§ã€‚

#### ä»»åŠ¡æ¸…å•ï¼ˆæ–°å¢5ä¸ªä»»åŠ¡ï¼‰

**âš ï¸ é‡è¦è°ƒæ•´**ï¼šåŸºäºä¾èµ–åˆ†æï¼Œä»»åŠ¡æ‰§è¡Œé¡ºåºå·²ä¼˜åŒ–ï¼Œä»»åŠ¡0.4 æå‡ä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼ˆ0.1çš„å‰ç½®ä¾èµ–ï¼‰

| æ‰§è¡Œé¡ºåº | ä»»åŠ¡ | æ–‡ä»¶ | å·¥æ—¶ | ä¼˜å…ˆçº§ | é—®é¢˜ç¼–å· |
|---------|------|------|------|--------|---------|
| **1** | **ä»»åŠ¡0.4** ä¼˜åŒ– MessageArea å…¼å®¹å±‚ | MessageArea.tsx | 2h | ğŸ”´ **æœ€é«˜** | é—®é¢˜14 |
| **2** | **ä»»åŠ¡0.1** ä¿®å¤èŠå¤©æµå¼ç¼“å­˜å†™å…¥è·¯å¾„ | useMessageCallbacks.tsx | 1h | ğŸ”´ é«˜ | é—®é¢˜12 |
| **3** | **ä»»åŠ¡0.2** ä¼˜åŒ–æ¶ˆæ¯å»é‡é€»è¾‘ï¼ˆä¼˜å…ˆä½¿ç”¨ client_request_idï¼‰ | mergeOptimisticMessages.ts | 2h | ğŸ”´ é«˜ | é—®é¢˜13/33 |
| **4** | **ä»»åŠ¡0.3** ä¿®å¤ä¾§è¾¹æ ç¼“å­˜åŒæ­¥ç«æ€ | ConversationList.tsx | 1h | ğŸŸ¡ ä¸­ | é—®é¢˜16 |
| **5** | **ä»»åŠ¡0.5** ä¿®å¤æ¨¡å‹åˆ‡æ¢ä¸ç”¨æˆ·é€‰æ‹©å†²çª | useModelSelection.ts | 1h | ğŸ”´ é«˜ | é—®é¢˜20 â­ |
| **6** | **ä»»åŠ¡0.6** ä¿®å¤æ¶ˆæ¯åˆ—è¡¨keyç­–ç•¥ï¼ˆç§»é™¤index fallbackï¼‰ | MessageArea.tsx | 0.5h | ğŸ”´ é«˜ | é—®é¢˜38 |
| **7** | **ä»»åŠ¡0.7** æå–å›¾ç‰‡URLåˆ†å‰²ä¸ºå…±äº«å‡½æ•° | utils/imageUtils.ts (æ–°å»º) | 0.5h | ğŸŸ¡ ä¸­ | é—®é¢˜19 |
| **8** | **ä»»åŠ¡0.8** å¢åŠ LRUæ¸…ç†å®¹é‡ï¼ˆ10â†’15ï¼‰ | Chat.tsx | 0.5h | ğŸŸ¡ ä¸­ | é—®é¢˜31 |
| **9** | **ä»»åŠ¡0.9** ç»Ÿä¸€é”™è¯¯æ—¥å¿—ï¼ˆæ–°å»ºerrorLoggerï¼‰ | utils/logger.ts (æ–°å»º) | 1h | ğŸŸ¡ ä¸­ | é—®é¢˜22 |

**è°ƒæ•´è¯´æ˜**ï¼š
- **ä»»åŠ¡0.4** ä¼˜åŒ–å…¼å®¹å±‚ï¼ˆIDåŒ¹é…æ›¿ä»£indexï¼‰æ˜¯ **ä»»åŠ¡0.1** çš„å‰ç½®ä¾èµ–
- å¿…é¡»å…ˆä¼˜åŒ–åŸºç¡€è®¾æ–½ï¼Œå†ä½¿ç”¨å…¼å®¹å±‚è¿›è¡Œç¼“å­˜å†™å…¥
- é¿å…åœ¨ä¸ç¨³å®šçš„ index åŒ¹é…åŸºç¡€ä¸Šå åŠ ä¿®æ”¹

#### è¯¦ç»†æ–¹æ¡ˆ

**ä»»åŠ¡0.1ï¼šä¿®å¤èŠå¤©æµå¼ç¼“å­˜å†™å…¥è·¯å¾„**

**é—®é¢˜**ï¼šhandleMessageSent ä¸­ç›´æ¥è°ƒç”¨ `useChatStore.getState().appendMessage()`ï¼Œè¿èƒŒ"ç¼“å­˜å³çŠ¶æ€"åŸåˆ™ã€‚

**ä¿®æ”¹**ï¼š
```typescript
// âŒ æ—§ä»£ç ï¼ˆuseMessageCallbacks.tsx:169ï¼‰
handleMessageSent: (aiMessage) => {
  // ...
  useChatStore.getState().appendMessage(messageConversationId, aiMessage);
}

// âœ… æ–°ä»£ç 
handleMessageSent: (aiMessage) => {
  // ...
  // é€šè¿‡ setMessages å…¼å®¹å±‚ï¼ˆéœ€è¦ä» MessageArea ä¼ å…¥ï¼‰
  setMessages?.((prev) => [...prev, aiMessage]);
}
```

**å½±å“æ–‡ä»¶**ï¼š
- `hooks/useMessageCallbacks.tsx` - ä¿®æ”¹ handleMessageSent
- `components/chat/MessageArea.tsx` - ä¼ é€’ setMessages åˆ° useMessageCallbacks
- `pages/Chat.tsx` - å¯èƒ½éœ€è¦è°ƒæ•´å‚æ•°ä¼ é€’

**éªŒè¯**ï¼š
- âœ… èŠå¤©æ¶ˆæ¯å‘é€åç¼“å­˜æ­£ç¡®å†™å…¥
- âœ… åˆ‡æ¢å¯¹è¯èƒ½çœ‹åˆ°æœ€æ–°æ¶ˆæ¯
- âœ… åˆ·æ–°é¡µé¢æ¶ˆæ¯ä¸ä¸¢å¤±

---

**ä»»åŠ¡0.2ï¼šä¼˜åŒ–æ¶ˆæ¯å»é‡é€»è¾‘**

**é—®é¢˜**ï¼šä»…ä½¿ç”¨å†…å®¹+æ—¶é—´é˜ˆå€¼åŒ¹é…ï¼Œå¯èƒ½è¯¯åˆ¤ï¼ˆ30ç§’å†…å‘é€ç›¸åŒå†…å®¹ï¼‰ã€‚

**ä¿®æ”¹**ï¼š
```typescript
// mergeOptimisticMessages.ts:26-39
function isTempMessageReplaced(tempMessage: Message, persistedMessages: Message[]): boolean {
  return persistedMessages.some((pm) => {
    // âœ… æ–°å¢ï¼šä¼˜å…ˆä½¿ç”¨ client_request_id åŒ¹é…ï¼ˆæ›´å‡†ç¡®ï¼‰
    if (tempMessage.client_request_id && pm.client_request_id) {
      return tempMessage.client_request_id === pm.client_request_id;
    }

    // å›é€€åˆ°å†…å®¹+æ—¶é—´åŒ¹é…
    if (pm.role !== 'user' || pm.content !== tempMessage.content) {
      return false;
    }
    const tempTime = new Date(tempMessage.created_at).getTime();
    const persistedTime = new Date(pm.created_at).getTime();
    const timeDiff = Math.abs(persistedTime - tempTime);
    return timeDiff < TEMP_MESSAGE_MATCH_THRESHOLD_MS;
  });
}
```

**å½±å“æ–‡ä»¶**ï¼š
- `utils/mergeOptimisticMessages.ts`

**éªŒè¯**ï¼š
- âœ… 30ç§’å†…å‘é€ç›¸åŒå†…å®¹ä¸ä¼šå»é‡
- âœ… ä½¿ç”¨ client_request_id å‡†ç¡®åŒ¹é…
- âœ… å›é€€æœºåˆ¶æ­£å¸¸å·¥ä½œ

---

**ä»»åŠ¡0.3ï¼šä¿®å¤ä¾§è¾¹æ ç¼“å­˜åŒæ­¥ç«æ€**

**é—®é¢˜**ï¼šä¹è§‚æ›´æ–°åæœªåŒæ­¥å†™å…¥ localStorageï¼Œåˆ·æ–°å¯èƒ½ä¸¢å¤±ã€‚

**ä¿®æ”¹**ï¼š
```typescript
// ConversationList.tsx:124-136
useEffect(() => {
  if (!optimisticUpdate) return;
  setConversations((prev) => {
    const target = prev.find((c) => c.id === optimisticUpdate.conversationId);
    if (!target) return prev;
    const updated = {
      ...target,
      last_message: optimisticUpdate.lastMessage,
      updated_at: new Date().toISOString(),
    };
    const newConversations = [updated, ...prev.filter((c) => c.id !== optimisticUpdate.conversationId)];

    // âœ… æ–°å¢ï¼šç«‹å³åŒæ­¥åˆ° localStorage
    try {
      localStorage.setItem(CONVERSATIONS_CACHE_KEY, JSON.stringify(newConversations));
    } catch {
      // å¿½ç•¥å­˜å‚¨å¤±è´¥
    }

    return newConversations;
  });
}, [optimisticUpdate]);
```

**å½±å“æ–‡ä»¶**ï¼š
- `components/chat/ConversationList.tsx`

**éªŒè¯**ï¼š
- âœ… ä¹è§‚æ›´æ–°åç«‹å³å†™å…¥ localStorage
- âœ… åˆ·æ–°é¡µé¢ä¸ä¸¢å¤±é¡ºåº

---

**ä»»åŠ¡0.5ï¼šä¿®å¤æ¨¡å‹åˆ‡æ¢ä¸ç”¨æˆ·é€‰æ‹©å†²çª**ï¼ˆâ­ ç”¨æˆ·é‡ç‚¹å…³æ³¨ï¼‰

**é—®é¢˜**ï¼šåˆ é™¤å›¾ç‰‡æ—¶æ¢å¤åŸæ¨¡å‹çš„é€»è¾‘ä¸æ£€æŸ¥ `userExplicitChoice`ï¼Œå¯èƒ½è¦†ç›–ç”¨æˆ·é€‰æ‹©ã€‚

**ä¿®æ”¹**ï¼š
```typescript
// useModelSelection.ts:121-143
useEffect(() => {
  if (userExplicitChoice) return;  // âœ… å·²æœ‰æ£€æŸ¥

  // æœ‰å›¾ç‰‡ + å½“å‰æ˜¯æ–‡ç”Ÿå›¾æ¨¡å‹ â†’ è‡ªåŠ¨åˆ‡æ¢ç¼–è¾‘æ¨¡å‹
  if (hasImage && selectedModel.type === 'image' && !selectedModel.capabilities.imageEditing) {
    modelBeforeUpload.current = selectedModel;
    const editModel = ALL_MODELS.find(...);
    queueMicrotask(() => switchModel(editModel, true));
  }

  // âœ… ä¿®å¤ï¼šåˆ é™¤å›¾ç‰‡æ—¶æ£€æŸ¥ç”¨æˆ·é€‰æ‹©çŠ¶æ€
  if (!hasImage && modelBeforeUpload.current) {
    const modelToRestore = modelBeforeUpload.current;
    modelBeforeUpload.current = null;

    // âœ… æ–°å¢ï¼šç”¨æˆ·æ˜ç¡®é€‰æ‹©äº†ç¼–è¾‘æ¨¡å‹ï¼Œä¸è‡ªåŠ¨åˆ‡æ¢
    if (!userExplicitChoice) {
      queueMicrotask(() => switchModel(modelToRestore, false));  // âœ… falseï¼šä¸æ ‡è®°ä¸ºç”¨æˆ·é€‰æ‹©
    }
  }
}, [hasImage, selectedModel, userExplicitChoice, switchModel]);
```

**å½±å“æ–‡ä»¶**ï¼š
- `hooks/useModelSelection.ts`

**éªŒè¯**ï¼š
- âœ… ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©ç¼–è¾‘æ¨¡å‹ â†’ åˆ é™¤å›¾ç‰‡ â†’ ä¸è‡ªåŠ¨åˆ‡æ¢
- âœ… è‡ªåŠ¨åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å‹ â†’ åˆ é™¤å›¾ç‰‡ â†’ è‡ªåŠ¨æ¢å¤åŸæ¨¡å‹
- âœ… å¯¹è¯åˆ‡æ¢æ—¶æ¨¡å‹æ¢å¤ä¸å—å½±å“

---

**ä»»åŠ¡0.6ï¼šä¿®å¤æ¶ˆæ¯åˆ—è¡¨keyç­–ç•¥**

**é—®é¢˜**ï¼šä½¿ç”¨ `key={message.id || message-${index}}` å¯èƒ½å¯¼è‡´æ¶ˆæ¯é‡æ’æ—¶Reacté”™ä¹±ã€‚

**ä¿®æ”¹**ï¼š
```typescript
// MessageArea.tsx:300
{mergedMessages.map((message) => (
  <MessageItem
    key={message.id}  // âœ… ç§»é™¤ fallbackï¼Œä¸´æ—¶æ¶ˆæ¯å¿…é¡»æœ‰ID
    message={message}
    // ...
  />
))}
```

**å½±å“æ–‡ä»¶**ï¼š
- `components/chat/MessageArea.tsx`
- ç¡®ä¿æ‰€æœ‰ä¸´æ—¶æ¶ˆæ¯ç”Ÿæˆæ—¶éƒ½æœ‰å”¯ä¸€ID

**éªŒè¯**ï¼š
- âœ… æ¶ˆæ¯æ›´æ–°ä¸ä¼šé‡æ–°æ¸²æŸ“å…¶ä»–æ¶ˆæ¯
- âœ… React DevTools ä¸æŠ¥ key warning
- âœ… æ¶ˆæ¯åŠ¨ç”»æ­£å¸¸

---

**ä»»åŠ¡0.7ï¼šæå–å›¾ç‰‡URLåˆ†å‰²ä¸ºå…±äº«å‡½æ•°**

**é—®é¢˜**ï¼šMessageMedia.tsx å’Œ MessageItem.tsx éƒ½æœ‰ç›¸åŒçš„å›¾ç‰‡URLåˆ†å‰²é€»è¾‘ã€‚

**ä¿®æ”¹**ï¼š
```typescript
// utils/imageUtils.ts (æ–°å»º)
export function splitImageUrls(imageUrl: string | null | undefined): string[] {
  if (!imageUrl) return [];
  return imageUrl.split(',').map(url => url.trim()).filter(Boolean);
}

// MessageMedia.tsx:282-285
const imageUrls = useMemo(() => splitImageUrls(imageUrl), [imageUrl]);

// MessageItem.tsx:99-102
const messageImageUrls = useMemo(() => splitImageUrls(message.image_url), [message.image_url]);
```

**å½±å“æ–‡ä»¶**ï¼š
- æ–°å»º `utils/imageUtils.ts`
- `components/chat/MessageMedia.tsx`
- `components/chat/MessageItem.tsx`

**éªŒè¯**ï¼š
- âœ… å›¾ç‰‡æ˜¾ç¤ºæ­£å¸¸
- âœ… å¤šå›¾åˆ†å‰²æ­£ç¡®
- âœ… æ¶ˆé™¤é‡å¤ä»£ç 

---

**ä»»åŠ¡0.8ï¼šå¢åŠ LRUæ¸…ç†å®¹é‡**

**é—®é¢˜**ï¼šç¡¬æ€§é™åˆ¶10ä¸ªå¯¹è¯ï¼Œå¿«é€Ÿåˆ‡æ¢æ—¶å¯èƒ½æ¸…é™¤æ´»è·ƒä»»åŠ¡çš„è¿è¡Œæ—¶çŠ¶æ€ã€‚

**ä¿®æ”¹**ï¼š
```typescript
// Chat.tsx:97-111
const keepIds = Array.from(
  new Set([urlConversationId, ...activeTaskIds, ...activeStreamingIds])
).slice(0, 15);  // âœ… 10 â†’ 15ï¼Œå¢åŠ å®¹é‡

runtimeState.cleanup(keepIds);
```

**å½±å“æ–‡ä»¶**ï¼š
- `pages/Chat.tsx`

**éªŒè¯**ï¼š
- âœ… å¿«é€Ÿåˆ‡æ¢15ä¸ªå¯¹è¯æ—¶è¿è¡Œæ—¶çŠ¶æ€ä¸ä¸¢å¤±
- âœ… æ´»è·ƒä»»åŠ¡æ­£å¸¸æ˜¾ç¤º

---

**ä»»åŠ¡0.9ï¼šç»Ÿä¸€é”™è¯¯æ—¥å¿—**

**é—®é¢˜**ï¼šå‰ç«¯æ··ç”¨ `console.error()` å’Œ `console.warn()`ï¼Œæ— ç»Ÿä¸€æ—¥å¿—çº§åˆ«ã€‚

**ä¿®æ”¹**ï¼š
```typescript
// utils/logger.ts (æ–°å»º)
export const logger = {
  info: (scope: string, message: string, context?: Record<string, any>) => {
    console.log(`[${scope}] ${message}`, context || '');
  },
  warn: (scope: string, message: string, context?: Record<string, any>) => {
    console.warn(`[${scope}] ${message}`, context || '');
  },
  error: (scope: string, message: string, context?: Record<string, any>) => {
    console.error(`[${scope}] ${message}`, context || '');
  },
};

// ä½¿ç”¨ç¤ºä¾‹ï¼ˆé€æ­¥æ›¿æ¢ï¼‰
// âŒ æ—§ä»£ç 
console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);

// âœ… æ–°ä»£ç 
logger.error('ImageUpload', 'ä¸Šä¼ å¤±è´¥', { error: error.message });
```

**å½±å“æ–‡ä»¶**ï¼š
- æ–°å»º `utils/logger.ts`
- é€æ­¥æ›¿æ¢å„æ–‡ä»¶çš„ console.error/warn è°ƒç”¨ï¼ˆå¯åœ¨åç»­é˜¶æ®µå®Œæˆï¼‰

**éªŒè¯**ï¼š
- âœ… æ—¥å¿—æ ¼å¼ç»Ÿä¸€
- âœ… ä¾¿äºè¿‡æ»¤å’Œè°ƒè¯•

---

**ä»»åŠ¡0.4ï¼šä¼˜åŒ– MessageArea å…¼å®¹å±‚**

**é—®é¢˜**ï¼šä½¿ç”¨ index éå†æŸ¥æ‰¾å˜åŒ–ï¼Œå¯èƒ½é”™ä½ä¸”æ€§èƒ½è¾ƒå·®ã€‚

**ä¿®æ”¹**ï¼š
```typescript
// MessageArea.tsx:77-100
const setMessages = useCallback(
  (updater: Message[] | ((prev: Message[]) => Message[])) => {
    if (!conversationId) return;

    if (typeof updater === 'function') {
      const oldMessages = mergedMessages;
      const newMessages = updater(oldMessages);

      // âœ… ä½¿ç”¨ ID Map è€Œé index
      const oldMap = new Map(oldMessages.map(m => [m.id, m]));
      const newMap = new Map(newMessages.map(m => [m.id, m]));

      // æ‰¾å‡ºæ–°å¢å’Œä¿®æ”¹çš„æ¶ˆæ¯
      newMessages.forEach((newMsg) => {
        // è¿‡æ»¤ä¸´æ—¶æ¶ˆæ¯ï¼ˆä¸å†™å…¥æŒä¹…åŒ–ç¼“å­˜ï¼‰
        if (newMsg.id.startsWith('temp-') || newMsg.id.startsWith('streaming-')) {
          return;
        }

        const oldMsg = oldMap.get(newMsg.id);
        if (!oldMsg) {
          // æ–°å¢æ¶ˆæ¯
          appendMessage(conversationId, newMsg);
        } else if (oldMsg !== newMsg) {
          // æ¶ˆæ¯è¢«ä¿®æ”¹
          replaceMessage(conversationId, newMsg.id, newMsg);
        }
      });

      // æ‰¾å‡ºè¢«åˆ é™¤çš„æ¶ˆæ¯
      oldMessages.forEach((oldMsg) => {
        if (!newMap.has(oldMsg.id) && !oldMsg.id.startsWith('temp-') && !oldMsg.id.startsWith('streaming-')) {
          removeMessage(conversationId, oldMsg.id);
        }
      });
    }
  },
  [conversationId, mergedMessages, replaceMessage, appendMessage, removeMessage]
);
```

**å½±å“æ–‡ä»¶**ï¼š
- `components/chat/MessageArea.tsx`

**éªŒè¯**ï¼š
- âœ… æ¶ˆæ¯æ›´æ–°ã€åˆ é™¤æ­£ç¡®
- âœ… å¤§é‡æ¶ˆæ¯æ—¶æ€§èƒ½è‰¯å¥½
- âœ… ä¸´æ—¶æ¶ˆæ¯ä¸å†™å…¥æŒä¹…åŒ–ç¼“å­˜

---

### é˜¶æ®µ1ï¼šç»Ÿä¸€ç¼“å­˜å†™å…¥è·¯å¾„ï¼ˆ0.5å¤©ï¼‰

#### ç›®æ ‡
ç¡®ä¿æ‰€æœ‰æ¶ˆæ¯æ“ä½œï¼ˆé¦–æ¬¡å‘é€ã€é‡æ–°ç”Ÿæˆï¼‰éƒ½é€šè¿‡ `setMessages` å…¼å®¹å±‚ï¼Œå½»åº•ç»Ÿä¸€ç¼“å­˜å†™å…¥ã€‚

#### å‰ç½®ä¾èµ–
- âœ… é˜¶æ®µ0 å®Œæˆï¼ˆç‰¹åˆ«æ˜¯ä»»åŠ¡0.1ï¼‰

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| **ä»»åŠ¡1.1** æ£€æŸ¥æ‰€æœ‰ç›´æ¥è°ƒç”¨ ChatStore.appendMessage çš„ä½ç½® | å…¨å±€æœç´¢ | 0.5h | ğŸ”´ æœ€é«˜ |
| **ä»»åŠ¡1.2** ä¿®æ”¹é‡æ–°ç”Ÿæˆé€»è¾‘ä½¿ç”¨ RuntimeStore | mediaRegeneration.ts, regenerateAsNew.ts | 2h | ğŸ”´ æœ€é«˜ |
| **ä»»åŠ¡1.3** éªŒè¯ç¼“å­˜å†™å…¥è·¯å¾„ç»Ÿä¸€ | å…¨éƒ¨æ¶ˆæ¯æµç¨‹ | 1h | ğŸ”´ æœ€é«˜ |

#### è¯¦ç»†æ–¹æ¡ˆ

**ä»»åŠ¡1.1ï¼šæ£€æŸ¥æ‰€æœ‰ç›´æ¥è°ƒç”¨ ChatStore.appendMessage çš„ä½ç½®**

**æ‰§è¡Œæ­¥éª¤**ï¼š
```bash
# æœç´¢æ‰€æœ‰ç›´æ¥è°ƒç”¨
grep -r "useChatStore.getState().appendMessage" frontend/src/
grep -r "appendMessage(conversationId" frontend/src/
```

**é¢„æœŸç»“æœ**ï¼š
- æ‰¾å‡ºæ‰€æœ‰ç›´æ¥è°ƒç”¨ä½ç½®
- ç¡®è®¤æ˜¯å¦éœ€è¦æ”¹ä¸ºèµ° setMessages å…¼å®¹å±‚

---

**ä»»åŠ¡1.2ï¼šä¿®æ”¹é‡æ–°ç”Ÿæˆé€»è¾‘ä½¿ç”¨ RuntimeStore**

**é—®é¢˜**ï¼šé‡æ–°ç”Ÿæˆç»•è¿‡äº† RuntimeStoreï¼Œå¯¼è‡´å ä½ç¬¦ç®¡ç†ä¸ä¸€è‡´ã€‚

**ä¿®æ”¹**ï¼š
```typescript
// mediaRegeneration.ts:110-141
export function createMediaRegenCallbacks(
  setMessages: React.Dispatch<React.SetStateAction<Message[]>>,
  resetRegeneratingState: () => void,
  onMessageUpdate?: (newLastMessage: string) => void,
  onMediaTaskSubmitted?: () => void,
  // âœ… æ–°å¢ï¼šä¼ å…¥ RuntimeStore æ“ä½œæ–¹æ³•
  addOptimisticMessage?: (conversationId: string, message: Message) => void,
  replaceOptimisticMessage?: (conversationId: string, messageId: string, message: Message) => void
) {
  return {
    onMessagePending: (msg: Message) => {
      // âœ… æ–°å¢ï¼šä¸´æ—¶æ¶ˆæ¯å†™å…¥ RuntimeStore
      if (msg.id.startsWith('temp-') || msg.id.startsWith('streaming-')) {
        addOptimisticMessage?.(msg.conversation_id, msg);
      } else {
        // çœŸå®æ¶ˆæ¯é€šè¿‡å…¼å®¹å±‚
        setMessages((prev) => {
          const existing = prev.findIndex((m) => m.id === msg.id);
          if (existing >= 0) return prev.map((m, i) => (i === existing ? msg : m));
          return [...prev, msg];
        });
      }
    },
    onMessageSent: (aiMessage?: Message | null) => {
      resetRegeneratingState();
      if (aiMessage) {
        // âœ… ç»Ÿä¸€èµ° setMessages å…¼å®¹å±‚
        setMessages((prev) => [...prev, aiMessage]);
      }
      if (aiMessage && !aiMessage.is_error && onMessageUpdate) {
        onMessageUpdate(aiMessage.content);
      }
    },
    // ...
  };
}
```

**å½±å“æ–‡ä»¶**ï¼š
- `utils/mediaRegeneration.ts`
- `utils/regenerate/regenerateAsNew.ts`
- æ‰€æœ‰è°ƒç”¨ `createMediaRegenCallbacks` çš„åœ°æ–¹

**éªŒè¯**ï¼š
- âœ… é‡æ–°ç”Ÿæˆæ—¶å ä½ç¬¦æ­£å¸¸æ˜¾ç¤º
- âœ… replaceMediaPlaceholder èƒ½æ‰¾åˆ°å ä½ç¬¦
- âœ… ç¼“å­˜å†™å…¥é€šè¿‡ setMessages å…¼å®¹å±‚

---

### é˜¶æ®µ2ï¼šåˆå¹¶å›¾ç‰‡/è§†é¢‘å‘é€å™¨å’Œå¤„ç†å™¨ï¼ˆ1-2å¤©ï¼‰

#### ç›®æ ‡
æ¶ˆé™¤å›¾ç‰‡/è§†é¢‘å‘é€å™¨ã€å¤„ç†å™¨ã€ç”Ÿæˆæ ¸å¿ƒçš„ä»£ç é‡å¤ï¼ˆ~180è¡Œï¼‰ã€‚

#### å‰ç½®ä¾èµ–
- âœ… é˜¶æ®µ1 å®Œæˆï¼ˆç¼“å­˜å†™å…¥è·¯å¾„ç»Ÿä¸€ï¼‰

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| **ä»»åŠ¡2.1** åˆå¹¶å›¾ç‰‡/è§†é¢‘å¤„ç†å™¨ | useMediaMessageHandler.ts (æ–°å»º) | 2h | ğŸ”´ é«˜ |
| **ä»»åŠ¡2.2** åˆå¹¶å›¾ç‰‡/è§†é¢‘å‘é€å™¨ | mediaSender.ts (æ–°å»º) | 3h | ğŸ”´ é«˜ |
| **ä»»åŠ¡2.3** æ³›å‹åŒ–åª’ä½“ç”Ÿæˆæ ¸å¿ƒ | mediaGenerationCore.ts | 2h | ğŸŸ¡ ä¸­ |
| **ä»»åŠ¡2.4** æ¸…ç†æ—§æ–‡ä»¶ | åˆ é™¤ imageSender.ts, videoSender.ts ç­‰ | 1h | ğŸŸ¡ ä¸­ |

#### è¯¦ç»†æ–¹æ¡ˆ

**ä»»åŠ¡2.1ï¼šåˆå¹¶å›¾ç‰‡/è§†é¢‘å¤„ç†å™¨**

**åˆ›å»ºæ–‡ä»¶**ï¼š`hooks/handlers/useMediaMessageHandler.ts`

**å®ç°**ï¼š
```typescript
import { type UnifiedModel } from '../../constants/models';
import { type Message } from '../../services/message';
import { sendMediaMessage } from '../../services/messageSender';
import { computeImageGenerationParams, computeVideoGenerationParams } from '../../utils/mediaRegeneration';

export type MediaType = 'image' | 'video';

interface UseMediaMessageHandlerParams {
  type: MediaType;
  selectedModel: UnifiedModel;

  // å›¾ç‰‡å‚æ•°
  aspectRatio?: string;
  outputFormat?: string;
  resolution?: string;

  // è§†é¢‘å‚æ•°
  videoFrames?: string;
  videoAspectRatio?: string;
  removeWatermark?: boolean;

  // å›è°ƒ
  onMessagePending: (message: Message) => void;
  onMessageSent: (aiMessage?: Message | null) => void;
  onMediaTaskSubmitted?: () => void;
}

export function useMediaMessageHandler(params: UseMediaMessageHandlerParams) {
  const { type, selectedModel, onMessagePending, onMessageSent, onMediaTaskSubmitted } = params;

  const handleMediaGeneration = async (
    conversationId: string,
    prompt: string,
    imageUrl: string | null = null,
    conversationTitle: string = ''
  ) => {
    // è®¡ç®—ç”Ÿæˆå‚æ•°
    const generationParams = type === 'image'
      ? computeImageGenerationParams(null, selectedModel.id, selectedModel)
      : computeVideoGenerationParams(null, selectedModel.id, selectedModel, !!imageUrl);

    await sendMediaMessage({
      type,
      conversationId,
      content: prompt,
      imageUrl,
      modelId: type === 'image' ? selectedModel.id : generationParams.finalModelId,
      generationParams: type === 'image' ? generationParams : generationParams.generationParams,
      conversationTitle,
      callbacks: {
        onMessagePending,
        onMessageSent,
        onMediaTaskSubmitted,
      },
    });
  };

  return { handleMediaGeneration };
}
```

**å½±å“æ–‡ä»¶**ï¼š
- æ–°å»º `hooks/handlers/useMediaMessageHandler.ts`
- ä¿®æ”¹ `components/chat/InputArea.tsx` ä½¿ç”¨æ–° hook
- åˆ é™¤ `hooks/handlers/useImageMessageHandler.ts`
- åˆ é™¤ `hooks/handlers/useVideoMessageHandler.ts`

**éªŒè¯**ï¼š
- âœ… å›¾ç‰‡ç”Ÿæˆæ­£å¸¸
- âœ… è§†é¢‘ç”Ÿæˆæ­£å¸¸
- âœ… å›¾ç”Ÿè§†é¢‘æ­£å¸¸

---

**ä»»åŠ¡2.2ï¼šåˆå¹¶å›¾ç‰‡/è§†é¢‘å‘é€å™¨**

**åˆ›å»ºæ–‡ä»¶**ï¼š`services/messageSender/mediaSender.ts`

**å®ç°**ï¼š
```typescript
import { createMediaTimestamps, createMediaOptimisticPair } from '../../utils/messageFactory';
import { createMessage } from '../message';
import { executeImageGenerationCore, executeVideoGenerationCore } from './mediaGenerationCore';
import type { ImageSenderParams, VideoSenderParams } from './types';

export type MediaSenderParams = ImageSenderParams | VideoSenderParams;

export async function sendMediaMessage(params: MediaSenderParams): Promise<void> {
  const {
    type,
    conversationId,
    content,
    imageUrl,
    modelId,
    generationParams,
    conversationTitle,
    callbacks,
  } = params;

  const { onMessagePending, onMessageSent, onMediaTaskSubmitted } = callbacks;

  // 1. åˆ›å»ºæ—¶é—´æˆ³å’Œä¹è§‚æ¶ˆæ¯å¯¹
  const timestamps = createMediaTimestamps();
  const loadingText = type === 'image' ? 'å›¾ç‰‡ç”Ÿæˆä¸­...' : 'è§†é¢‘ç”Ÿæˆä¸­...';
  const { userMessage, placeholder } = createMediaOptimisticPair(
    conversationId,
    content,
    imageUrl,
    loadingText,
    timestamps
  );

  // 2. è§¦å‘ä¹è§‚æ›´æ–°
  onMessagePending(userMessage);
  onMessagePending(placeholder);

  // 3. ä¿å­˜çœŸå®ç”¨æˆ·æ¶ˆæ¯
  const realUserMessage = await createMessage(conversationId, {
    role: 'user',
    content,
    image_url: imageUrl,
    created_at: timestamps.userTimestamp,
  });

  // 4. è°ƒç”¨å¯¹åº”çš„æ ¸å¿ƒç”Ÿæˆé€»è¾‘
  if (type === 'image') {
    await executeImageGenerationCore({
      conversationId,
      prompt: content,
      imageUrl,
      modelId,
      generationParams: generationParams as ImageSenderParams['generationParams'],
      conversationTitle,
      messageTimestamp: timestamps.placeholderTimestamp,
      placeholderId: placeholder.id,
      callbacks: {
        onSuccess: (savedMessage) => onMessageSent(savedMessage),
        onError: (errorMessage) => onMessageSent(errorMessage),
        onTaskSubmitted: onMediaTaskSubmitted,
      },
    });
  } else {
    await executeVideoGenerationCore({
      conversationId,
      prompt: content,
      imageUrl,
      modelId,
      generationParams: generationParams as VideoSenderParams['generationParams'],
      conversationTitle,
      messageTimestamp: timestamps.placeholderTimestamp,
      placeholderId: placeholder.id,
      callbacks: {
        onSuccess: (savedMessage) => onMessageSent(savedMessage),
        onError: (errorMessage) => onMessageSent(errorMessage),
        onTaskSubmitted: onMediaTaskSubmitted,
      },
    });
  }
}
```

**å½±å“æ–‡ä»¶**ï¼š
- æ–°å»º `services/messageSender/mediaSender.ts`
- ä¿®æ”¹ `services/messageSender/index.ts` å¯¼å‡º
- åˆ é™¤ `services/messageSender/imageSender.ts`
- åˆ é™¤ `services/messageSender/videoSender.ts`

**éªŒè¯**ï¼š
- âœ… å›¾ç‰‡å‘é€æ­£å¸¸
- âœ… è§†é¢‘å‘é€æ­£å¸¸
- âœ… ä¹è§‚æ›´æ–°æ­£å¸¸
- âœ… å ä½ç¬¦æ­£å¸¸

---

**ä»»åŠ¡2.3ï¼šæ³›å‹åŒ–åª’ä½“ç”Ÿæˆæ ¸å¿ƒ**

**ç›®æ ‡**ï¼šè¿›ä¸€æ­¥å‡å°‘ executeImageGenerationCore å’Œ executeVideoGenerationCore çš„é‡å¤ã€‚

**æ–¹æ¡ˆ**ï¼šæå–å…±åŒé€»è¾‘åˆ° `executeMediaGenerationCore<T>`

**å®ç°**ï¼ˆå¯é€‰ä¼˜åŒ–ï¼Œéå¿…é¡»ï¼‰ï¼š
```typescript
// é€šç”¨åª’ä½“ç”Ÿæˆæ ¸å¿ƒ
async function executeMediaGenerationCore<T extends 'image' | 'video'>(
  type: T,
  apiCall: () => Promise<MediaResponse>,
  config: MediaGenerationConfig
): Promise<void> {
  // å…±åŒé€»è¾‘ï¼šAPI è°ƒç”¨ + è½®è¯¢ + ä¿å­˜
  try {
    const response = await apiCall();

    if (response.status === 'pending' || response.status === 'processing') {
      startMediaPolling({ type, ...config });
      config.callbacks.onTaskSubmitted?.();
    } else if (response.status === 'success') {
      const savedMessage = await createMessage(...);
      config.callbacks.onSuccess(savedMessage);
    }
  } catch (error) {
    const errorMessage = await createErrorMediaMessage(...);
    config.callbacks.onError(errorMessage);
  }
}

// å›¾ç‰‡ç”Ÿæˆç®€åŒ–ä¸º
export async function executeImageGenerationCore(params: ImageGenerationCoreParams) {
  return executeMediaGenerationCore(
    'image',
    () => params.imageUrl ? editImage(...) : generateImage(...),
    params
  );
}
```

**å½±å“æ–‡ä»¶**ï¼š
- `services/messageSender/mediaGenerationCore.ts`

**éªŒè¯**ï¼š
- âœ… åŠŸèƒ½ä¸å˜
- âœ… ä»£ç ç®€åŒ–

---

### é˜¶æ®µ3ï¼šç»Ÿä¸€è½®è¯¢ç®¡ç†å™¨ï¼ˆ0.5å¤©ï¼‰

#### ç›®æ ‡
useTaskStore ä½¿ç”¨ PollingManagerï¼Œç§»é™¤é‡å¤å®ç°ï¼ˆ~90è¡Œï¼‰ã€‚

#### å‰ç½®ä¾èµ–
- âœ… é˜¶æ®µ2 å®Œæˆï¼ˆå‘é€å™¨ç»Ÿä¸€ï¼‰

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| **ä»»åŠ¡3.1** useTaskStore ä½¿ç”¨ PollingManager | stores/useTaskStore.ts | 2h | ğŸ”´ é«˜ |
| **ä»»åŠ¡3.2** æ¸…ç†æ—§è½®è¯¢ä»£ç  | stores/useTaskStore.ts | 1h | ğŸŸ¡ ä¸­ |

#### è¯¦ç»†æ–¹æ¡ˆ

**ä»»åŠ¡3.1ï¼šuseTaskStore ä½¿ç”¨ PollingManager**

**ä¿®æ”¹**ï¼š
```typescript
// stores/useTaskStore.ts
import { pollingManager } from '../utils/polling';

// âŒ åˆ é™¤è‡ªå·±å®ç°çš„ executePoll å’Œ setInterval é€»è¾‘
// âœ… æ”¹ç”¨ PollingManager

startPolling: (taskId, pollFn, callbacks, options) => {
  set((state) => {
    const newConfigs = new Map(state.pollingConfigs);

    // ä½¿ç”¨ PollingManager å¯åŠ¨è½®è¯¢
    pollingManager.start(
      taskId,
      pollFn,
      {
        onSuccess: (result) => {
          callbacks.onSuccess?.(result);
          // æ¸…ç†é…ç½®
          get().stopPolling(taskId);
        },
        onError: (error) => {
          callbacks.onError?.(error);
          get().stopPolling(taskId);
        },
      },
      options
    );

    // ä¿å­˜é…ç½®åˆ° Storeï¼ˆç”¨äºæ¸…ç†ï¼‰
    newConfigs.set(taskId, {
      taskId,
      startTime: Date.now(),
      interval: options?.interval ?? 2000,
    });

    return { pollingConfigs: newConfigs };
  });
},

stopPolling: (taskId) => {
  pollingManager.stop(taskId);
  set((state) => {
    const newConfigs = new Map(state.pollingConfigs);
    newConfigs.delete(taskId);
    return { pollingConfigs: newConfigs };
  });
},
```

**å½±å“æ–‡ä»¶**ï¼š
- `stores/useTaskStore.ts`

**éªŒè¯**ï¼š
- âœ… è½®è¯¢æ­£å¸¸å¯åŠ¨
- âœ… è½®è¯¢æ­£å¸¸åœæ­¢
- âœ… æˆåŠŸ/å¤±è´¥å›è°ƒæ­£å¸¸

---

### é˜¶æ®µ4ï¼šæå–ä»»åŠ¡é€šçŸ¥é€»è¾‘ï¼ˆ0.5å¤©ï¼‰

#### ç›®æ ‡
æ¶ˆé™¤ completeTask å’Œ completeMediaTask çš„é‡å¤ï¼ˆ~40è¡Œï¼‰ã€‚

#### å‰ç½®ä¾èµ–
- âœ… é˜¶æ®µ3 å®Œæˆï¼ˆè½®è¯¢ç»Ÿä¸€ï¼‰

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| **ä»»åŠ¡4.1** æå–é€šç”¨é€šçŸ¥å‡½æ•° | stores/useTaskStore.ts | 2h | ğŸŸ¡ ä¸­ |
| **ä»»åŠ¡4.2** é‡æ„ completeTask å’Œ completeMediaTask | stores/useTaskStore.ts | 1h | ğŸŸ¡ ä¸­ |

#### è¯¦ç»†æ–¹æ¡ˆ

**ä»»åŠ¡4.1ï¼šæå–é€šç”¨é€šçŸ¥å‡½æ•°**

**å®ç°**ï¼š
```typescript
// stores/useTaskStore.ts

/**
 * æ·»åŠ ä»»åŠ¡å®Œæˆé€šçŸ¥ï¼ˆé€šç”¨å‡½æ•°ï¼‰
 */
function addTaskNotification(
  state: TaskState,
  conversationId: string,
  conversationTitle: string,
  type: 'chat' | 'media',
  id: string
): { newNotifications: TaskNotification[]; newRecentlyCompleted: Set<string> } {
  // æ ‡è®°å¯¹è¯ä¸ºæœªè¯»
  useChatStore.getState().markConversationUnread(conversationId);

  // æ·»åŠ é€šçŸ¥
  let newNotifications = [
    ...state.pendingNotifications,
    {
      id,
      conversationId,
      conversationTitle,
      type,
      completedAt: Date.now(),
      isRead: false,
    },
  ];

  // ä¿ç•™æœ€è¿‘ MAX_NOTIFICATIONS æ¡
  if (newNotifications.length > MAX_NOTIFICATIONS) {
    newNotifications = newNotifications.slice(-MAX_NOTIFICATIONS);
  }

  // æ ‡è®°ä¸ºæœ€è¿‘å®Œæˆ
  const newRecentlyCompleted = new Set(state.recentlyCompleted);
  newRecentlyCompleted.add(conversationId);

  return { newNotifications, newRecentlyCompleted };
}
```

**ä»»åŠ¡4.2ï¼šé‡æ„ completeTask å’Œ completeMediaTask**

**ä¿®æ”¹**ï¼š
```typescript
completeTask: (conversationId) => {
  set((state) => {
    const task = state.chatTasks.get(conversationId);
    if (!task) return state;

    const newTasks = new Map(state.chatTasks);
    newTasks.delete(conversationId);

    // âœ… ä½¿ç”¨é€šç”¨å‡½æ•°
    const { newNotifications, newRecentlyCompleted } = addTaskNotification(
      state,
      conversationId,
      task.conversationTitle,
      'chat',
      conversationId
    );

    return {
      chatTasks: newTasks,
      pendingNotifications: newNotifications,
      recentlyCompleted: newRecentlyCompleted,
    };
  });
},

completeMediaTask: (taskId) => {
  set((state) => {
    const task = state.mediaTasks.get(taskId);
    if (!task) return state;

    const newTasks = new Map(state.mediaTasks);
    newTasks.delete(taskId);

    // âœ… ä½¿ç”¨é€šç”¨å‡½æ•°
    const { newNotifications, newRecentlyCompleted } = addTaskNotification(
      state,
      task.conversationId,
      task.conversationTitle,
      'media',
      taskId
    );

    return {
      mediaTasks: newTasks,
      pendingNotifications: newNotifications,
      recentlyCompleted: newRecentlyCompleted,
    };
  });
},
```

**å½±å“æ–‡ä»¶**ï¼š
- `stores/useTaskStore.ts`

**éªŒè¯**ï¼š
- âœ… ä»»åŠ¡å®Œæˆé€šçŸ¥æ­£å¸¸
- âœ… ä¾§è¾¹æ é—ªçƒæ­£å¸¸
- âœ… é€šçŸ¥åˆ—è¡¨æ­£å¸¸

---

### é˜¶æ®µ5ï¼šé‡æ–°è®¾è®¡çŠ¶æ€ç®¡ç†ï¼ˆ2-3å¤©ï¼‰

#### ç›®æ ‡
è§£å†³ TaskStore vs RuntimeStore èŒè´£é‡å ï¼Œå»ºç«‹æ¸…æ™°çš„åè°ƒå±‚ã€‚

#### å‰ç½®ä¾èµ–
- âœ… é˜¶æ®µ4 å®Œæˆï¼ˆé€šçŸ¥é€»è¾‘ç»Ÿä¸€ï¼‰

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| **ä»»åŠ¡5.1** è®¾è®¡æ–°çš„çŠ¶æ€ç®¡ç†æ¶æ„ | æ–‡æ¡£è®¾è®¡ | 4h | ğŸ”´ æœ€é«˜ |
| **ä»»åŠ¡5.2** æ–°å»ºåè°ƒå±‚ useTaskCoordinator | hooks/useTaskCoordinator.ts (æ–°å»º) | 4h | ğŸ”´ é«˜ |
| **ä»»åŠ¡5.3** é‡æ„æ¶ˆæ¯å›è°ƒä½¿ç”¨åè°ƒå±‚ | useMessageCallbacks.tsx | 4h | ğŸ”´ é«˜ |
| **ä»»åŠ¡5.4** æ¸…ç†å†—ä½™çŠ¶æ€ | TaskStore, RuntimeStore | 4h | ğŸŸ¡ ä¸­ |

#### è¯¦ç»†æ–¹æ¡ˆ

**ä»»åŠ¡5.1ï¼šè®¾è®¡æ–°çš„çŠ¶æ€ç®¡ç†æ¶æ„**

**æ–¹æ¡ˆCï¼šåˆ†å±‚è§£è€¦ï¼ˆæ¨èï¼‰â­**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ–°çŠ¶æ€ç®¡ç†æ¶æ„ï¼ˆåˆ†å±‚è§£è€¦ï¼‰                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚                     useTaskCoordinator                          â”‚
â”‚                     (åè°ƒå±‚ - ç»Ÿä¸€å…¥å£)                          â”‚
â”‚                             â†“                                   â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â†“                                      â†“                â”‚
â”‚   TaskStore (ä»»åŠ¡å…ƒæ•°æ®)         RuntimeStore (æ¶ˆæ¯è§†å›¾)        â”‚
â”‚   - taskId, status               - optimisticMessages          â”‚
â”‚   - conversationTitle            - streamingMessageId           â”‚
â”‚   - polling config               - isGenerating                 â”‚
â”‚   - notifications                                               â”‚
â”‚         â†“                                      â†“                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                             â†“                                   â”‚
â”‚                       ChatStore (æŒä¹…åŒ–)                        â”‚
â”‚                       - messageCache                            â”‚
â”‚                       - conversations                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**èŒè´£åˆ’åˆ†**ï¼š

| Store | èŒè´£ | æ•°æ® |
|-------|------|------|
| **TaskStore** | ä»»åŠ¡å…ƒæ•°æ®ç®¡ç† | taskId, status, conversationTitle, polling, notifications |
| **RuntimeStore** | æ¶ˆæ¯è§†å›¾ç®¡ç† | optimisticMessages, streamingMessageId, isGenerating |
| **ChatStore** | æŒä¹…åŒ–ç¼“å­˜ | messageCache, conversations |
| **useTaskCoordinator** | åè°ƒå±‚ï¼ˆç»Ÿä¸€å…¥å£ï¼‰ | å°è£…æ‰€æœ‰è·¨ Store æ“ä½œ |

**åè°ƒå±‚æ¥å£**ï¼š
```typescript
interface TaskCoordinator {
  // ç»Ÿä¸€å…¥å£ï¼šå¼€å§‹ä»»åŠ¡
  startTask(conversationId: string, type: 'chat' | 'image' | 'video', options: TaskOptions): void;

  // ç»Ÿä¸€å…¥å£ï¼šæ›´æ–°ä»»åŠ¡
  updateTaskContent(conversationId: string, content: string): void;

  // ç»Ÿä¸€å…¥å£ï¼šå®Œæˆä»»åŠ¡
  completeTask(conversationId: string, result: Message): void;

  // ç»Ÿä¸€å…¥å£ï¼šå¤±è´¥ä»»åŠ¡
  failTask(conversationId: string, error: Error): void;
}
```

---

**ä»»åŠ¡5.2ï¼šæ–°å»ºåè°ƒå±‚ useTaskCoordinator**

**åˆ›å»ºæ–‡ä»¶**ï¼š`hooks/useTaskCoordinator.ts`

**å®ç°**ï¼š
```typescript
import { useTaskStore } from '../stores/useTaskStore';
import { useConversationRuntimeStore } from '../stores/useConversationRuntimeStore';
import { useChatStore } from '../stores/useChatStore';

export interface TaskOptions {
  conversationTitle: string;
  userMessage?: Message;
  placeholderMessage?: Message;
}

export function useTaskCoordinator() {
  /**
   * å¼€å§‹ä»»åŠ¡ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
   */
  const startTask = (
    conversationId: string,
    type: 'chat' | 'image' | 'video',
    options: TaskOptions
  ) => {
    const { conversationTitle, userMessage, placeholderMessage } = options;

    // 1. æ³¨å†Œä»»åŠ¡åˆ° TaskStore
    if (type === 'chat') {
      useTaskStore.getState().startTask(conversationId, conversationTitle);
    } else {
      // åª’ä½“ä»»åŠ¡éœ€è¦ taskIdï¼Œç”±å¤–éƒ¨ç”Ÿæˆ
      // useTaskStore.getState().startMediaTask({ ... });
    }

    // 2. æ·»åŠ ä¸´æ—¶æ¶ˆæ¯åˆ° RuntimeStore
    if (userMessage) {
      useConversationRuntimeStore.getState().addOptimisticUserMessage(conversationId, userMessage);
    }
    if (placeholderMessage) {
      useConversationRuntimeStore.getState().addMediaPlaceholder(conversationId, placeholderMessage);
    }
  };

  /**
   * å®Œæˆä»»åŠ¡ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
   */
  const completeTask = (conversationId: string, result: Message) => {
    // 1. å®Œæˆ TaskStore ä»»åŠ¡
    useTaskStore.getState().completeTask(conversationId);

    // 2. æ¸…ç† RuntimeStore ä¸´æ—¶çŠ¶æ€
    useConversationRuntimeStore.getState().completeStreaming(conversationId);

    // 3. å†™å…¥æŒä¹…åŒ–ç¼“å­˜
    useChatStore.getState().appendMessage(conversationId, result);
  };

  /**
   * å¤±è´¥ä»»åŠ¡ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
   */
  const failTask = (conversationId: string, error: Error) => {
    // 1. å¤±è´¥ TaskStore ä»»åŠ¡
    useTaskStore.getState().failTask(conversationId);

    // 2. æ·»åŠ é”™è¯¯æ¶ˆæ¯åˆ° RuntimeStore
    const errorMessage = createErrorMessage(conversationId, 'ä»»åŠ¡å¤±è´¥', error);
    useConversationRuntimeStore.getState().addErrorMessage(conversationId, errorMessage);
  };

  return {
    startTask,
    completeTask,
    failTask,
  };
}
```

**å½±å“æ–‡ä»¶**ï¼š
- æ–°å»º `hooks/useTaskCoordinator.ts`

**éªŒè¯**ï¼š
- âœ… åè°ƒå±‚èƒ½æ­£ç¡®è°ƒç”¨å„ä¸ª Store
- âœ… çŠ¶æ€åŒæ­¥æ­£ç¡®

---

**ä»»åŠ¡5.3ï¼šé‡æ„æ¶ˆæ¯å›è°ƒä½¿ç”¨åè°ƒå±‚**

**ä¿®æ”¹**ï¼š
```typescript
// hooks/useMessageCallbacks.tsx

import { useTaskCoordinator } from './useTaskCoordinator';

export function useMessageCallbacks(params: UseMessageCallbacksParams) {
  const coordinator = useTaskCoordinator();

  const handleMessagePending = (message: Message) => {
    const messageConversationId = message.conversation_id;

    // âœ… ä½¿ç”¨åè°ƒå±‚ç»Ÿä¸€å…¥å£
    if (messageConversationId && message.role === 'user') {
      coordinator.startTask(messageConversationId, 'chat', {
        conversationTitle,
        userMessage: message,
      });
    }

    // ä¾§è¾¹æ ä¹è§‚æ›´æ–°...
  };

  const handleMessageSent = (aiMessage?: Message | null) => {
    const messageConversationId = aiMessage?.conversation_id;

    // âœ… ä½¿ç”¨åè°ƒå±‚ç»Ÿä¸€å…¥å£
    if (messageConversationId) {
      if (aiMessage?.is_error) {
        coordinator.failTask(messageConversationId, new Error(aiMessage.content));
      } else if (aiMessage) {
        coordinator.completeTask(messageConversationId, aiMessage);
      }
    }

    // åˆ·æ–°ç”¨æˆ·ã€é€šçŸ¥ç­‰...
  };

  return {
    handleMessagePending,
    handleMessageSent,
    handleStreamStart,
    handleStreamContent,
    conversationOptimisticUpdate,
    setConversationOptimisticUpdate,
  };
}
```

**å½±å“æ–‡ä»¶**ï¼š
- `hooks/useMessageCallbacks.tsx`
- æ‰€æœ‰ä½¿ç”¨ useMessageCallbacks çš„åœ°æ–¹

**éªŒè¯**ï¼š
- âœ… æ¶ˆæ¯å‘é€æ­£å¸¸
- âœ… ä»»åŠ¡çŠ¶æ€æ­£ç¡®
- âœ… ç¼“å­˜å†™å…¥æ­£ç¡®

---

### é˜¶æ®µ6ï¼šå ä½ç¬¦æŒä¹…åŒ–ï¼ˆ2-3å¤©ï¼‰â­

#### ç›®æ ‡
å®ç°å ä½ç¬¦æŒä¹…åŒ–ï¼Œæ”¯æŒåˆ·æ–°é¡µé¢åç»§ç»­è½®è¯¢å’Œæ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€ã€‚

#### å‰ç½®ä¾èµ–
- âœ… é˜¶æ®µ5 å®Œæˆï¼ˆçŠ¶æ€ç®¡ç†æ¸…æ™°ï¼‰
- âœ… æ¶æ„å¹²å‡€ã€èŒè´£æ¸…æ™°

#### ä¸ºä»€ä¹ˆåœ¨è¿™ä¸ªé˜¶æ®µå®æ–½ï¼Ÿ

1. **å‰ç½®ä¾èµ–å·²å®Œæˆ**
   - ç¼“å­˜å†™å…¥è·¯å¾„ç»Ÿä¸€ â†’ æŒä¹…åŒ–å ä½ç¬¦èƒ½æ­£ç¡®å†™å…¥
   - ä»£ç é‡å¤æ¶ˆé™¤ â†’ åªéœ€ä¿®æ”¹ä¸€å¤„æ ¸å¿ƒé€»è¾‘
   - çŠ¶æ€ç®¡ç†æ¸…æ™° â†’ å®¹æ˜“ç†è§£å ä½ç¬¦çš„ç”Ÿå‘½å‘¨æœŸ
   - RuntimeStore ä½¿ç”¨ä¸€è‡´ â†’ å ä½ç¬¦æ¢å¤åèƒ½æ­£ç¡®æ˜¾ç¤º

2. **é¿å…åœ¨æ··ä¹±æ¶æ„ä¸Šå åŠ åŠŸèƒ½**
   - ä¹‹å‰çš„åˆ†æå‘ç°äº† 16 ä¸ªé—®é¢˜ï¼Œç›´æ¥å®æ–½æŒä¹…åŒ–ä¼šï¼š
     - åŠ å‰§ç¼“å­˜å†™å…¥è·¯å¾„ä¸ç»Ÿä¸€çš„é—®é¢˜
     - ä¸ RuntimeStore ä½¿ç”¨ä¸ä¸€è‡´å†²çª
     - å ä½ç¬¦ç®¡ç†æ›´åŠ åˆ†æ•£
   - ç°åœ¨æ¶æ„æ¸…æ™°åï¼ŒæŒä¹…åŒ–é€»è¾‘ç®€å•æ˜ç¡®

3. **å®æ–½æˆæœ¬æœ€ä½**
   - ç»Ÿä¸€çš„ mediaSender â†’ åªéœ€åœ¨ä¸€å¤„æ·»åŠ æŒä¹…åŒ–é€»è¾‘
   - ç»Ÿä¸€çš„åè°ƒå±‚ â†’ æ¢å¤ä»»åŠ¡åªéœ€è°ƒç”¨åè°ƒå±‚
   - æ¸…æ™°çš„èŒè´£ â†’ çŸ¥é“å ä½ç¬¦åº”è¯¥å­˜åœ¨å“ªä¸ª Store

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| **ä»»åŠ¡6.1** è®¾è®¡æŒä¹…åŒ–æ–¹æ¡ˆ | æ–‡æ¡£è®¾è®¡ | 2h | ğŸ”´ æœ€é«˜ |
| **ä»»åŠ¡6.2** æŒä¹…åŒ–å ä½ç¬¦åˆ° ChatStore | mediaSender.ts, ChatStore | 3h | ğŸ”´ é«˜ |
| **ä»»åŠ¡6.3** æ¢å¤è¿›è¡Œä¸­ä»»åŠ¡ï¼ˆå«å ä½ç¬¦ï¼‰ | taskRestoration.ts | 4h | ğŸ”´ é«˜ |
| **ä»»åŠ¡6.4** å¤„ç†è½®è¯¢å¤±è´¥åœºæ™¯ | mediaGenerationCore.ts | 2h | ğŸŸ¡ ä¸­ |
| **ä»»åŠ¡6.5** æµ‹è¯•å®Œæ•´æµç¨‹ | å…¨æµç¨‹æµ‹è¯• | 3h | ğŸ”´ é«˜ |

#### è¯¦ç»†æ–¹æ¡ˆ

**ä»»åŠ¡6.1ï¼šè®¾è®¡æŒä¹…åŒ–æ–¹æ¡ˆ**

**æ ¸å¿ƒæ€è·¯**ï¼š
1. **å ä½ç¬¦æ¶ˆæ¯æŒä¹…åŒ–** - å°† streaming-xxx å ä½ç¬¦å†™å…¥ ChatStoreï¼ˆå¸¦ status æ ‡è®°ï¼‰
2. **ä»»åŠ¡å…ƒæ•°æ®æŒä¹…åŒ–** - å°†è¿›è¡Œä¸­çš„ä»»åŠ¡ä¿¡æ¯å­˜åˆ° localStorage
3. **é¡µé¢åˆ·æ–°æ¢å¤** - å¯åŠ¨æ—¶ä» localStorage æ¢å¤ä»»åŠ¡ï¼Œç»§ç»­è½®è¯¢

**æ•°æ®ç»“æ„**ï¼š
```typescript
// ChatStore ä¸­çš„å ä½ç¬¦æ¶ˆæ¯
interface PlaceholderMessage extends Message {
  id: string;  // streaming-xxx æ ¼å¼
  status: 'pending' | 'processing' | 'completed' | 'failed';  // ä»»åŠ¡çŠ¶æ€
  task_id?: string;  // å…³è”çš„åå°ä»»åŠ¡ ID
}

// localStorage ä¸­çš„ä»»åŠ¡å…ƒæ•°æ®
interface PendingTask {
  taskId: string;
  conversationId: string;
  conversationTitle: string;
  type: 'image' | 'video';
  placeholderId: string;
  creditsConsumed: number;
  startTime: number;
  generationParams: GenerationParams;
}

// localStorage Key
const PENDING_TASKS_KEY = 'pending_media_tasks';
```

**ç”Ÿå‘½å‘¨æœŸ**ï¼š
```
1. å‘é€æ¶ˆæ¯
   â†“
2. åˆ›å»ºå ä½ç¬¦ (streaming-xxx, status: 'pending')
   â†“
3. æŒä¹…åŒ–å ä½ç¬¦åˆ° ChatStore
   â†“
4. æŒä¹…åŒ–ä»»åŠ¡å…ƒæ•°æ®åˆ° localStorage
   â†“
5. å¯åŠ¨è½®è¯¢
   â†“
6. è½®è¯¢æˆåŠŸ â†’ æ›¿æ¢å ä½ç¬¦ä¸ºçœŸå®æ¶ˆæ¯ â†’ åˆ é™¤ localStorage ä»»åŠ¡
   â†“
7. è½®è¯¢å¤±è´¥ â†’ æ›´æ–°å ä½ç¬¦ status ä¸º 'failed' â†’ åˆ é™¤ localStorage ä»»åŠ¡
   â†“
8. é¡µé¢åˆ·æ–° â†’ ä» localStorage æ¢å¤ä»»åŠ¡ â†’ ç»§ç»­è½®è¯¢
```

---

**ä»»åŠ¡6.2ï¼šæŒä¹…åŒ–å ä½ç¬¦åˆ° ChatStore**

**ä¿®æ”¹1ï¼šåœ¨ mediaSender.ts ä¸­æŒä¹…åŒ–å ä½ç¬¦**

```typescript
// services/messageSender/mediaSender.ts

export async function sendMediaMessage(params: MediaSenderParams): Promise<void> {
  const { type, conversationId, content, imageUrl, modelId, generationParams, conversationTitle, callbacks } = params;
  const { onMessagePending, onMessageSent, onMediaTaskSubmitted } = callbacks;

  // 1. åˆ›å»ºæ—¶é—´æˆ³å’Œä¹è§‚æ¶ˆæ¯å¯¹
  const timestamps = createMediaTimestamps();
  const loadingText = type === 'image' ? 'å›¾ç‰‡ç”Ÿæˆä¸­...' : 'è§†é¢‘ç”Ÿæˆä¸­...';
  const { userMessage, placeholder } = createMediaOptimisticPair(
    conversationId,
    content,
    imageUrl,
    loadingText,
    timestamps
  );

  // 2. è§¦å‘ä¹è§‚æ›´æ–°ï¼ˆä¸´æ—¶æ¶ˆæ¯ï¼‰
  onMessagePending(userMessage);
  onMessagePending(placeholder);

  // 3. ä¿å­˜çœŸå®ç”¨æˆ·æ¶ˆæ¯
  const realUserMessage = await createMessage(conversationId, {
    role: 'user',
    content,
    image_url: imageUrl,
    created_at: timestamps.userTimestamp,
  });

  // âœ… 4. æŒä¹…åŒ–å ä½ç¬¦åˆ° ChatStoreï¼ˆå…³é”®ï¼ï¼‰
  const persistedPlaceholder = {
    ...placeholder,
    status: 'pending' as const,  // æ ‡è®°ä¸ºå¾…å¤„ç†
  };
  useChatStore.getState().appendMessage(conversationId, persistedPlaceholder);

  // 5. è°ƒç”¨æ ¸å¿ƒç”Ÿæˆé€»è¾‘
  if (type === 'image') {
    await executeImageGenerationCore({
      conversationId,
      prompt: content,
      imageUrl,
      modelId,
      generationParams: generationParams as ImageSenderParams['generationParams'],
      conversationTitle,
      messageTimestamp: timestamps.placeholderTimestamp,
      placeholderId: placeholder.id,
      callbacks: {
        onSuccess: (savedMessage) => {
          // âœ… æ›¿æ¢å ä½ç¬¦ä¸ºçœŸå®æ¶ˆæ¯
          useChatStore.getState().replaceMessage(conversationId, placeholder.id, savedMessage);
          onMessageSent(savedMessage);
        },
        onError: (errorMessage) => {
          // âœ… æ›¿æ¢å ä½ç¬¦ä¸ºé”™è¯¯æ¶ˆæ¯
          useChatStore.getState().replaceMessage(conversationId, placeholder.id, errorMessage);
          onMessageSent(errorMessage);
        },
        onTaskSubmitted: onMediaTaskSubmitted,
      },
    });
  } else {
    // è§†é¢‘åŒç†
    // ...
  }
}
```

**ä¿®æ”¹2ï¼šåœ¨ mediaGenerationCore.ts ä¸­æŒä¹…åŒ–ä»»åŠ¡å…ƒæ•°æ®**

```typescript
// services/messageSender/mediaGenerationCore.ts

function startMediaPolling(config: MediaPollingConfig): void {
  const { type, taskId, conversationId, conversationTitle, placeholderId, creditsConsumed, generationParams } = config;

  // âœ… æŒä¹…åŒ–ä»»åŠ¡å…ƒæ•°æ®åˆ° localStorage
  const pendingTask: PendingTask = {
    taskId,
    conversationId,
    conversationTitle,
    type,
    placeholderId,
    creditsConsumed,
    startTime: Date.now(),
    generationParams,
  };

  try {
    const existingTasks = JSON.parse(localStorage.getItem(PENDING_TASKS_KEY) || '[]');
    existingTasks.push(pendingTask);
    localStorage.setItem(PENDING_TASKS_KEY, JSON.stringify(existingTasks));
  } catch (error) {
    console.error('æŒä¹…åŒ–ä»»åŠ¡å¤±è´¥:', error);
  }

  // å¯åŠ¨è½®è¯¢
  startPolling(taskId, async () => {
    const result = await pollFn(taskId);
    if (result.status === 'success') {
      // âœ… æˆåŠŸï¼šåˆ é™¤ localStorage ä»»åŠ¡
      removePendingTask(taskId);
      return { done: true, result };
    }
    if (result.status === 'failed') {
      // âœ… å¤±è´¥ï¼šåˆ é™¤ localStorage ä»»åŠ¡
      removePendingTask(taskId);
      return { done: true, error: new Error(result.fail_msg || 'ç”Ÿæˆå¤±è´¥') };
    }
    return { done: false };
  }, { ... });
}

function removePendingTask(taskId: string): void {
  try {
    const existingTasks = JSON.parse(localStorage.getItem(PENDING_TASKS_KEY) || '[]');
    const updatedTasks = existingTasks.filter((t: PendingTask) => t.taskId !== taskId);
    localStorage.setItem(PENDING_TASKS_KEY, JSON.stringify(updatedTasks));
  } catch (error) {
    console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
  }
}
```

**å½±å“æ–‡ä»¶**ï¼š
- `services/messageSender/mediaSender.ts`
- `services/messageSender/mediaGenerationCore.ts`
- `stores/useChatStore.ts` ï¼ˆå¯èƒ½éœ€è¦æ·»åŠ  status å­—æ®µæ”¯æŒï¼‰

**éªŒè¯**ï¼š
- âœ… å‘é€æ¶ˆæ¯åå ä½ç¬¦å†™å…¥ ChatStore
- âœ… ä»»åŠ¡å…ƒæ•°æ®å†™å…¥ localStorage
- âœ… è½®è¯¢æˆåŠŸåå ä½ç¬¦è¢«æ›¿æ¢
- âœ… localStorage ä»»åŠ¡è¢«æ¸…ç†

---

**ä»»åŠ¡6.3ï¼šæ¢å¤è¿›è¡Œä¸­ä»»åŠ¡ï¼ˆå«å ä½ç¬¦ï¼‰**

**ä¿®æ”¹**ï¼š`utils/taskRestoration.ts`

```typescript
// utils/taskRestoration.ts

const PENDING_TASKS_KEY = 'pending_media_tasks';

export async function restoreAllPendingTasks(): Promise<void> {
  try {
    const pendingTasksJson = localStorage.getItem(PENDING_TASKS_KEY);
    if (!pendingTasksJson) return;

    const pendingTasks: PendingTask[] = JSON.parse(pendingTasksJson);

    // è¿‡æ»¤æ‰è¿‡æœŸä»»åŠ¡ï¼ˆè¶…è¿‡ 1 å°æ—¶ï¼‰
    const now = Date.now();
    const validTasks = pendingTasks.filter((task) => {
      const elapsed = now - task.startTime;
      const maxDuration = task.type === 'image' ? 10 * 60 * 1000 : 30 * 60 * 1000;
      return elapsed < maxDuration;
    });

    // æ›´æ–° localStorageï¼ˆç§»é™¤è¿‡æœŸä»»åŠ¡ï¼‰
    if (validTasks.length !== pendingTasks.length) {
      localStorage.setItem(PENDING_TASKS_KEY, JSON.stringify(validTasks));
    }

    // æ¢å¤æ¯ä¸ªä»»åŠ¡
    for (const task of validTasks) {
      await restorePendingTask(task);
    }

    console.log(`æ¢å¤äº† ${validTasks.length} ä¸ªè¿›è¡Œä¸­çš„ä»»åŠ¡`);
  } catch (error) {
    console.error('æ¢å¤ä»»åŠ¡å¤±è´¥:', error);
  }
}

async function restorePendingTask(task: PendingTask): Promise<void> {
  const { taskId, conversationId, conversationTitle, type, placeholderId, creditsConsumed, generationParams } = task;

  // 1. æ³¨å†Œä»»åŠ¡åˆ° TaskStoreï¼ˆæ¢å¤ä»»åŠ¡è¿½è¸ªï¼‰
  useTaskStore.getState().startMediaTask({
    taskId,
    conversationId,
    conversationTitle,
    type,
    placeholderId,
  });

  // 2. å ä½ç¬¦å·²ç»åœ¨ ChatStore ä¸­ï¼ˆæŒä¹…åŒ–çš„ï¼‰ï¼Œæ— éœ€æ¢å¤åˆ° RuntimeStore
  // 3. ç›´æ¥å¯åŠ¨è½®è¯¢
  startMediaPolling({
    type,
    taskId,
    conversationId,
    conversationTitle,
    placeholderId,
    creditsConsumed,
    messageTimestamp: new Date().toISOString(),
    generationParams,
    successContent: type === 'image' ? 'å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆ' : 'è§†é¢‘ç”Ÿæˆå®Œæˆ',
    errorPrefix: type === 'image' ? 'å›¾ç‰‡å¤„ç†å¤±è´¥' : 'è§†é¢‘ç”Ÿæˆå¤±è´¥',
    pollFn: type === 'image' ? getImageTaskStatus : getVideoTaskStatus,
    extractMediaUrl: (r) => type === 'image' ? r.image_urls[0] : r.video_url,
    shouldPreloadImage: type === 'image',
    callbacks: {
      onSuccess: (savedMessage) => {
        // æ›¿æ¢å ä½ç¬¦ä¸ºçœŸå®æ¶ˆæ¯
        useChatStore.getState().replaceMessage(conversationId, placeholderId, savedMessage);
      },
      onError: (errorMessage) => {
        // æ›¿æ¢å ä½ç¬¦ä¸ºé”™è¯¯æ¶ˆæ¯
        useChatStore.getState().replaceMessage(conversationId, placeholderId, errorMessage);
      },
    },
  });
}
```

**å½±å“æ–‡ä»¶**ï¼š
- `utils/taskRestoration.ts`

**éªŒè¯**ï¼š
- âœ… åˆ·æ–°é¡µé¢åå ä½ç¬¦ä»ç„¶æ˜¾ç¤º
- âœ… è½®è¯¢è‡ªåŠ¨ç»§ç»­
- âœ… å®Œæˆåå ä½ç¬¦æ­£ç¡®æ›¿æ¢
- âœ… è¿‡æœŸä»»åŠ¡è¢«æ¸…ç†

---

**ä»»åŠ¡6.4ï¼šå¤„ç†è½®è¯¢å¤±è´¥åœºæ™¯**

**åœºæ™¯**ï¼š
1. è½®è¯¢è¶…æ—¶ï¼ˆ10åˆ†é’Ÿå›¾ç‰‡ã€30åˆ†é’Ÿè§†é¢‘ï¼‰
2. ç½‘ç»œå¼‚å¸¸
3. åç«¯ä»»åŠ¡å¤±è´¥

**ä¿®æ”¹**ï¼š
```typescript
// services/messageSender/mediaGenerationCore.ts

startMediaPolling({
  // ...
  callbacks: {
    onSuccess: (savedMessage) => {
      // æˆåŠŸï¼šæ›¿æ¢å ä½ç¬¦ + åˆ é™¤ localStorage ä»»åŠ¡
      useChatStore.getState().replaceMessage(conversationId, placeholderId, savedMessage);
      removePendingTask(taskId);
      onSuccess(savedMessage);
    },
    onError: (error) => {
      // å¤±è´¥ï¼šåˆ›å»ºé”™è¯¯æ¶ˆæ¯ + æ›¿æ¢å ä½ç¬¦ + åˆ é™¤ localStorage ä»»åŠ¡
      const errorMessage = await createErrorMediaMessage(
        conversationId,
        errorPrefix,
        error,
        messageTimestamp,
        generationParams
      );
      useChatStore.getState().replaceMessage(conversationId, placeholderId, errorMessage);
      removePendingTask(taskId);
      toast.error(`${errorPrefix}: ${extractErrorMessage(error)}`);
      onError(errorMessage);
    },
  },
});
```

**å½±å“æ–‡ä»¶**ï¼š
- `services/messageSender/mediaGenerationCore.ts`

**éªŒè¯**ï¼š
- âœ… è½®è¯¢è¶…æ—¶åæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
- âœ… localStorage ä»»åŠ¡è¢«æ¸…ç†
- âœ… ç”¨æˆ·å¯ä»¥é‡æ–°ç”Ÿæˆ

---

**ä»»åŠ¡6.5ï¼šæµ‹è¯•å®Œæ•´æµç¨‹**

**æµ‹è¯•åœºæ™¯**ï¼š

| åœºæ™¯ | æ­¥éª¤ | é¢„æœŸç»“æœ |
|------|------|---------|
| **æ­£å¸¸æµç¨‹** | 1. å‘é€å›¾ç‰‡æ¶ˆæ¯<br>2. ç­‰å¾…ç”Ÿæˆå®Œæˆ | âœ… å ä½ç¬¦ â†’ çœŸå®æ¶ˆæ¯<br>âœ… localStorage æ¸…ç† |
| **åˆ·æ–°é¡µé¢** | 1. å‘é€å›¾ç‰‡æ¶ˆæ¯<br>2. ç«‹å³åˆ·æ–°é¡µé¢<br>3. ç­‰å¾…ç”Ÿæˆå®Œæˆ | âœ… å ä½ç¬¦ä»æ˜¾ç¤º<br>âœ… è½®è¯¢ç»§ç»­<br>âœ… å®Œæˆåæ›¿æ¢ |
| **è½®è¯¢å¤±è´¥** | 1. å‘é€å›¾ç‰‡æ¶ˆæ¯<br>2. åç«¯ä»»åŠ¡å¤±è´¥ | âœ… æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯<br>âœ… localStorage æ¸…ç†<br>âœ… å¯é‡æ–°ç”Ÿæˆ |
| **è½®è¯¢è¶…æ—¶** | 1. å‘é€å›¾ç‰‡æ¶ˆæ¯<br>2. ç­‰å¾…è¶…è¿‡ 10 åˆ†é’Ÿ | âœ… æ˜¾ç¤ºè¶…æ—¶é”™è¯¯<br>âœ… localStorage æ¸…ç† |
| **è¿‡æœŸä»»åŠ¡** | 1. localStorage ä¸­æœ‰ 1 å°æ—¶å‰çš„ä»»åŠ¡<br>2. åˆ·æ–°é¡µé¢ | âœ… è¿‡æœŸä»»åŠ¡ä¸æ¢å¤<br>âœ… localStorage æ¸…ç† |
| **å¤šä»»åŠ¡å¹¶å‘** | 1. åŒæ—¶å‘é€ 3 ä¸ªå›¾ç‰‡æ¶ˆæ¯<br>2. åˆ·æ–°é¡µé¢ | âœ… 3 ä¸ªå ä½ç¬¦éƒ½æ˜¾ç¤º<br>âœ… 3 ä¸ªè½®è¯¢éƒ½ç»§ç»­ |

**éªŒè¯æ ‡å‡†**ï¼š
- âœ… æ‰€æœ‰åœºæ™¯é€šè¿‡
- âœ… æ— å†…å­˜æ³„æ¼
- âœ… æ— é‡å¤è½®è¯¢

---

## äº”ã€é£é™©æ§åˆ¶

### 5.1 æ€»ä½“é£é™©æ§åˆ¶æªæ–½

| æªæ–½ | è¯´æ˜ |
|------|------|
| **å¢é‡éªŒè¯** | æ¯å®Œæˆä¸€ä¸ªé˜¶æ®µç«‹å³æµ‹è¯•ï¼Œä¸ç­‰å…¨éƒ¨å®Œæˆ |
| **Git å¤‡ä»½** | æ¯ä¸ªé˜¶æ®µå¼€å§‹å‰åˆ›å»ºåˆ†æ”¯ï¼Œå¼‚å¸¸å¯å¿«é€Ÿå›æ»š |
| **åŠŸèƒ½å…œåº•** | 30ç§’ TTLï¼Œç¼“å­˜å¼‚å¸¸æ—¶è‡ªåŠ¨æ‹‰å–åç«¯æ•°æ® |
| **å‘åå…¼å®¹** | ä¿ç•™æ—§æ–¹æ³•ï¼Œç¡®ä¿è¿‡æ¸¡æœŸå…¼å®¹ |
| **åˆ†æ­¥æäº¤** | æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹æäº¤ï¼Œä¾¿äºå›æ»š |

### 5.2 å„é˜¶æ®µé£é™©ç­‰çº§

| é˜¶æ®µ | é£é™©ç­‰çº§ | é£é™©ç‚¹ | ç¼“è§£æªæ–½ |
|------|---------|--------|---------|
| é˜¶æ®µ0 | ğŸŸ¢ ä½ | è¾¹ç•Œä¿®å¤ï¼Œå½±å“å° | å•å…ƒæµ‹è¯•è¦†ç›– |
| é˜¶æ®µ1 | ğŸŸ¡ ä¸­ | ç¼“å­˜å†™å…¥è·¯å¾„æ”¹åŠ¨ | ä¿ç•™æ—§æ–¹æ³•ï¼Œå…¼å®¹è¿‡æ¸¡ |
| é˜¶æ®µ2 | ğŸŸ¡ ä¸­ | åˆå¹¶ä»£ç å¯èƒ½å¼•å…¥ bug | å…¨é¢å›å½’æµ‹è¯• |
| é˜¶æ®µ3 | ğŸŸ¢ ä½ | è½®è¯¢é€»è¾‘ç®€å• | å·²æœ‰ PollingManagerï¼Œé£é™©ä½ |
| é˜¶æ®µ4 | ğŸŸ¢ ä½ | é€šçŸ¥é€»è¾‘ç®€å• | é€»è¾‘æ¸…æ™°ï¼Œé£é™©ä½ |
| é˜¶æ®µ5 | ğŸ”´ é«˜ | çŠ¶æ€ç®¡ç†æ¶æ„æ”¹åŠ¨å¤§ | åˆ†æ­¥å®æ–½ï¼Œå……åˆ†æµ‹è¯• |
| é˜¶æ®µ6 | ğŸŸ¡ ä¸­ | æŒä¹…åŒ–æ–°å¢åŠŸèƒ½ | ä¾èµ–å‰5é˜¶æ®µå®Œæˆï¼Œæ¶æ„æ¸…æ™°åé£é™©é™ä½ |

### 5.3 å›æ»šé¢„æ¡ˆ

```bash
# é˜¶æ®µ N å›æ»š
git checkout -b rollback-stage-N
git reset --hard <stage-N-1-commit-hash>
git push -f origin rollback-stage-N
```

---

## å…­ã€æ”¶ç›Šé¢„æœŸ

### 6.1 ä»£ç ç»´æŠ¤ï¼ˆæ›´æ–°åï¼‰

| ç»´åº¦ | æ”¹é€ å‰ | æ”¹é€ å | æ”¹å–„ |
|------|--------|--------|------|
| **æ¶æ„é—®é¢˜æ•°** | 47ä¸ª | <10ä¸ªï¼ˆæ ¸å¿ƒé—ç•™ï¼‰ | âœ… å‡å°‘ 78% |
| **é‡å¤ä»£ç ** | ~500è¡Œ | ~0è¡Œ | âœ… æ¶ˆé™¤ 100% é‡å¤ |
| **æ–‡ä»¶æ•°é‡** | 30+ æ–‡ä»¶ | ~27 æ–‡ä»¶ | âœ… å‡å°‘ 3+ æ–‡ä»¶ |
| **çŠ¶æ€ Store** | 3ä¸ªï¼ˆèŒè´£é‡å ï¼‰ | 3ä¸ªï¼ˆèŒè´£æ¸…æ™°ï¼‰ + 1ä¸ªåè°ƒå±‚ | âœ… èŒè´£æ˜ç¡® |
| **ç¼“å­˜å†™å…¥è·¯å¾„** | 2æ¡ï¼ˆä¸ç»Ÿä¸€ï¼‰ | 1æ¡ï¼ˆç»Ÿä¸€ï¼‰ | âœ… å•ä¸€å…¥å£ |
| **æ–°å¢æ¨¡å‹æˆæœ¬** | å¤åˆ¶ç²˜è´´ 3 ä¸ªæ–‡ä»¶ | æ‰©å±• 1 ä¸ªæšä¸¾ | âœ… é™ä½ 70% |
| **é”™è¯¯æ—¥å¿—** | æ··ç”¨ console | ç»Ÿä¸€ logger | âœ… ä¾¿äºè°ƒè¯• |
| **æ€§èƒ½é—®é¢˜** | 5ä¸ªé«˜ä¼˜ | 0ä¸ªï¼ˆè™šæ‹Ÿæ»šåŠ¨è§£å†³ï¼‰ | âœ… 100+æ¶ˆæ¯æµç•… |

### 6.2 åŠŸèƒ½å®Œå–„

| åŠŸèƒ½ | æ”¹é€ å‰ | æ”¹é€ å |
|------|--------|--------|
| **å ä½ç¬¦æŒä¹…åŒ–** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| **åˆ·æ–°é¡µé¢æ¢å¤ä»»åŠ¡** | âŒ ä¸¢å¤± | âœ… è‡ªåŠ¨æ¢å¤ |
| **æ¶ˆæ¯å»é‡å‡†ç¡®æ€§** | âš ï¸ å¯èƒ½è¯¯åˆ¤ | âœ… å‡†ç¡®åŒ¹é… |
| **ä¾§è¾¹æ ç¼“å­˜åŒæ­¥** | âš ï¸ å¯èƒ½ä¸¢å¤± | âœ… å®æ—¶åŒæ­¥ |

### 6.3 å¼€å‘ä½“éªŒ

| ç»´åº¦ | æ”¹é€ å‰ | æ”¹é€ å |
|------|--------|--------|
| **ç†è§£æ¶æ„æˆæœ¬** | é«˜ï¼ˆ16ä¸ªé—®é¢˜ï¼‰ | ä½ï¼ˆèŒè´£æ¸…æ™°ï¼‰ |
| **æ–°å¢åŠŸèƒ½æˆæœ¬** | é«˜ï¼ˆéœ€æ”¹å¤šå¤„ï¼‰ | ä½ï¼ˆç»Ÿä¸€å…¥å£ï¼‰ |
| **è°ƒè¯•æˆæœ¬** | é«˜ï¼ˆçŠ¶æ€åˆ†æ•£ï¼‰ | ä½ï¼ˆåè°ƒå±‚ç»Ÿä¸€ï¼‰ |
| **æµ‹è¯•æˆæœ¬** | é«˜ï¼ˆé‡å¤é€»è¾‘ï¼‰ | ä½ï¼ˆç»Ÿä¸€é€»è¾‘ï¼‰ |

---

## ä¸ƒã€æ€»ç»“

### 7.1 å…³é”®å†³ç­–

1. **å…ˆæ¶ˆé™¤é‡å¤ï¼Œå†ä¼˜åŒ–æ¶æ„** - é‡å¤ä»£ç æ˜¯æœ€æ˜ç¡®çš„é—®é¢˜ï¼Œä¼˜å…ˆè§£å†³
2. **æŒä¹…åŒ–åœ¨æ¶æ„æ¸…ç†åå®æ–½** - é¿å…åœ¨æ··ä¹±æ¶æ„ä¸Šå åŠ åŠŸèƒ½ï¼Œé™ä½é£é™©
3. **åˆ†é˜¶æ®µé™ä½é£é™©** - æ¯ä¸ªé˜¶æ®µç‹¬ç«‹éªŒè¯ï¼Œå¯ç‹¬ç«‹å›æ»š
4. **å¼•å…¥åè°ƒå±‚è€Œéåˆå¹¶ Store** - ä¿æŒèŒè´£æ¸…æ™°ï¼Œé™ä½æ”¹åŠ¨é£é™©
5. **è¡¥å……æ·±åº¦åˆ†æå‘ç°çš„é—®é¢˜** - 47ä¸ªé—®é¢˜å…¨é¢è¦†ç›–ï¼Œé¿å…é—æ¼
6. **ä¼˜å…ˆä¿®å¤ç”¨æˆ·å…³æ³¨çš„æ¨¡å‹åˆ‡æ¢é—®é¢˜** - åˆ—å…¥é˜¶æ®µ0é«˜ä¼˜ä»»åŠ¡

### 7.2 æ‰§è¡Œæ—¶é—´çº¿

```
æ€»é¢„ä¼°æ—¶é—´ï¼š9-15 å¤©ï¼ˆè¡¥å……æ–°é—®é¢˜åå¢åŠ 2-3å¤©ï¼‰

é˜¶æ®µ0ï¼šçŸ­æœŸä¿®å¤         â†’ 2-3å¤©  ï¼ˆDay 1-3ï¼‰â¬†ï¸ æ–°å¢5ä¸ªä»»åŠ¡
é˜¶æ®µ1ï¼šç»Ÿä¸€ç¼“å­˜å†™å…¥      â†’ 0.5å¤© ï¼ˆDay 4ï¼‰
é˜¶æ®µ2ï¼šåˆå¹¶å‘é€å™¨å¤„ç†å™¨  â†’ 1-2å¤©  ï¼ˆDay 5-6ï¼‰
é˜¶æ®µ3ï¼šç»Ÿä¸€è½®è¯¢ç®¡ç†å™¨    â†’ 0.5å¤© ï¼ˆDay 7ï¼‰
é˜¶æ®µ4ï¼šæå–ä»»åŠ¡é€šçŸ¥é€»è¾‘  â†’ 0.5å¤© ï¼ˆDay 8ï¼‰
é˜¶æ®µ5ï¼šé‡æ–°è®¾è®¡çŠ¶æ€ç®¡ç†  â†’ 2-3å¤©  ï¼ˆDay 9-11ï¼‰
é˜¶æ®µ6ï¼šå ä½ç¬¦æŒä¹…åŒ–      â†’ 2-3å¤©  ï¼ˆDay 12-14ï¼‰
é˜¶æ®µ7ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰  â†’ 1-2å¤©  ï¼ˆDay 15-16ï¼‰â¬†ï¸ æ–°å¢é˜¶æ®µ
```

### 7.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œ**ï¼šå¼€å§‹é˜¶æ®µ0ï¼ˆçŸ­æœŸä¿®å¤ï¼‰
2. **æŒç»­è·Ÿè¸ª**ï¼šæ¯å®Œæˆä¸€ä¸ªé˜¶æ®µæ›´æ–°æœ¬æ–‡æ¡£
3. **é£é™©æ§åˆ¶**ï¼šé‡åˆ°é—®é¢˜ç«‹å³æš‚åœï¼Œè¯„ä¼°é£é™©
4. **çµæ´»è°ƒæ•´**ï¼šæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´è®¡åˆ’

---

## é™„å½•ï¼šæ–°å¢é˜¶æ®µ7ï¼ˆå¯é€‰æ€§èƒ½ä¼˜åŒ–ï¼‰

### é˜¶æ®µ7ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰â­ å¯é€‰

#### ç›®æ ‡
è§£å†³UIæ¸²æŸ“æ€§èƒ½é—®é¢˜ï¼Œæå‡å¤§é‡æ¶ˆæ¯åœºæ™¯ä¸‹çš„ç”¨æˆ·ä½“éªŒã€‚

#### å‰ç½®ä¾èµ–
- âœ… é˜¶æ®µ6 å®Œæˆï¼ˆå ä½ç¬¦æŒä¹…åŒ–ï¼‰
- âœ… æ¶æ„æ¸…æ™°ï¼Œä»£ç æ•´æ´

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥æ—¶ | ä¼˜å…ˆçº§ | é—®é¢˜ç¼–å· |
|------|------|------|--------|---------|
| **ä»»åŠ¡7.1** é›†æˆè™šæ‹Ÿæ»šåŠ¨ï¼ˆreact-virtuosoï¼‰ | MessageArea.tsx | 4h | ğŸ”´ é«˜ | é—®é¢˜25 |
| **ä»»åŠ¡7.2** ä¼˜åŒ–æ¶ˆæ¯åˆå¹¶ç®—æ³•ï¼ˆO(nÂ²)â†’O(n)ï¼‰ | mergeOptimisticMessages.ts | 2h | ğŸ”´ é«˜ | é—®é¢˜26 |
| **ä»»åŠ¡7.3** æ•´åˆæ»šåŠ¨Hookä¸ºå•ä¸€useEffect | useMessageAreaScroll.ts | 3h | ğŸŸ¡ ä¸­ | é—®é¢˜36 |
| **ä»»åŠ¡7.4** æ·»åŠ å›¾ç‰‡åŠ è½½å¤±è´¥é‡è¯•æœºåˆ¶ | MessageMedia.tsx | 1h | ğŸŸ¡ ä¸­ | é—®é¢˜37 |

#### è¯´æ˜
æ­¤é˜¶æ®µå¯é€‰ï¼Œä»…åœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ‰§è¡Œï¼š
1. ç”¨æˆ·åé¦ˆå¤§é‡æ¶ˆæ¯åœºæ™¯ä¸‹æ€§èƒ½é—®é¢˜
2. æœ‰å……è¶³çš„å¼€å‘æ—¶é—´
3. å‰6ä¸ªé˜¶æ®µå·²å…¨éƒ¨å®Œæˆä¸”ç¨³å®š

---

**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… è§„åˆ’å®Œæˆï¼ˆå·²è¡¥å……31ä¸ªæ–°é—®é¢˜ï¼‰ï¼Œå¾…æ‰§è¡Œ
**æœ€åæ›´æ–°**ï¼š2026-02-01ï¼ˆè¡¥å……æ·±åº¦åˆ†æç»“æœï¼‰
**é—®é¢˜æ€»æ•°**ï¼š47ä¸ªï¼ˆé«˜18/ä¸­23/ä½6ï¼‰
**é¢„ä¼°å·¥æ—¶**ï¼š9-15å¤©ï¼ˆå«å¯é€‰é˜¶æ®µ7ï¼‰
**è´Ÿè´£äºº**ï¼šå¼€å‘å›¢é˜Ÿ
**å®¡æ ¸äºº**ï¼šå¾…å®š
