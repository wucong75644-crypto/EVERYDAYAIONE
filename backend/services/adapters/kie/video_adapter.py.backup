"""
KIE 视频模型适配器

适配 Sora 2 系列视频生成模型
"""

from typing import List, Optional, Dict, Any
from decimal import Decimal

from loguru import logger

from .client import KieClient, KieAPIError, KieTaskFailedError, KieTaskTimeoutError
from .models import (
    CreateTaskRequest,
    QueryTaskResponse,
    Sora2TextToVideoInput,
    Sora2ImageToVideoInput,
    Sora2ProStoryboardInput,
    AspectRatio,
    VideoFrames,
    CostEstimate,
    UsageRecord,
    KieModelType,
    TaskState,
)


class KieVideoAdapter:
    """
    KIE 视频生成适配器

    支持模型:
    - sora-2-text-to-video: 文本生成视频
    - sora-2-image-to-video: 图片生成视频 (需要输入图片作为首帧)
    - sora-2-pro-storyboard: 故事板视频生成 (支持25秒)

    特性:
    - 异步任务模式
    - 支持 10/15/25 秒视频
    - 支持横屏/竖屏
    - 支持去水印
    """

    # 模型配置
    MODEL_CONFIGS = {
        "sora-2-text-to-video": {
            "model_id": "sora-2-text-to-video",
            "description": "文本生成视频",
            "requires_image_input": False,
            "requires_prompt": True,
            "max_prompt_length": 10000,
            "supported_frames": ["10", "15"],
            "supports_watermark_removal": True,
            "cost_per_second": Decimal("0.015"),
            "credits_per_second": 4,
        },
        "sora-2-image-to-video": {
            "model_id": "sora-2-image-to-video",
            "description": "图片生成视频",
            "requires_image_input": True,
            "requires_prompt": True,
            "max_prompt_length": 10000,
            "max_image_size_mb": 10,
            "supported_frames": ["10", "15"],
            "supports_watermark_removal": True,
            "cost_per_second": Decimal("0.015"),
            "credits_per_second": 4,
        },
        "sora-2-pro-storyboard": {
            "model_id": "sora-2-pro-storyboard",
            "description": "故事板视频生成 (专业版)",
            "requires_image_input": False,  # 可选
            "requires_prompt": False,  # 无 prompt
            "supported_frames": ["10", "15", "25"],
            "supports_watermark_removal": False,
            "cost_per_second": Decimal("0.045"),
            "credits_per_second": 10,
        },
    }

    def __init__(self, client: KieClient, model: str):
        """
        初始化适配器

        Args:
            client: KIE HTTP 客户端
            model: 模型名称
        """
        if model not in self.MODEL_CONFIGS:
            raise ValueError(
                f"Unsupported model: {model}. "
                f"Supported: {list(self.MODEL_CONFIGS.keys())}"
            )

        self.client = client
        self.model = model
        self.config = self.MODEL_CONFIGS[model]

    @property
    def model_type(self) -> KieModelType:
        return KieModelType.VIDEO

    @property
    def model_id(self) -> str:
        return self.config["model_id"]

    @property
    def requires_image_input(self) -> bool:
        return self.config["requires_image_input"]

    @property
    def requires_prompt(self) -> bool:
        return self.config["requires_prompt"]

    @property
    def supports_watermark_removal(self) -> bool:
        return self.config["supports_watermark_removal"]

    # ============================================================
    # 参数验证
    # ============================================================

    def validate_prompt(self, prompt: Optional[str]) -> None:
        """验证 prompt"""
        if self.requires_prompt:
            if not prompt:
                raise ValueError(f"Model {self.model} requires prompt")
            max_length = self.config["max_prompt_length"]
            if len(prompt) > max_length:
                raise ValueError(f"Prompt too long: {len(prompt)} > {max_length}")

    def validate_image_urls(self, image_urls: Optional[List[str]]) -> None:
        """验证图片 URL"""
        if self.requires_image_input and not image_urls:
            raise ValueError(f"Model {self.model} requires image_urls")

    def validate_frames(self, n_frames: str) -> None:
        """验证视频时长"""
        supported = self.config["supported_frames"]
        if n_frames not in supported:
            raise ValueError(
                f"Unsupported n_frames: {n_frames}. Supported: {supported}"
            )

    def validate_aspect_ratio(self, aspect_ratio: str) -> None:
        """验证宽高比"""
        if aspect_ratio not in ["portrait", "landscape"]:
            raise ValueError(
                f"Unsupported aspect_ratio: {aspect_ratio}. "
                f"Supported: portrait, landscape"
            )

    # ============================================================
    # 视频生成
    # ============================================================

    async def generate(
        self,
        prompt: Optional[str] = None,
        image_urls: Optional[List[str]] = None,
        n_frames: str = "10",
        aspect_ratio: str = "landscape",
        remove_watermark: bool = True,
        callback_url: Optional[str] = None,
        wait_for_result: bool = True,
        poll_interval: float = 5.0,  # 视频生成较慢，间隔长一些
        max_wait_time: float = 600.0,  # 最多等待10分钟
    ) -> Dict[str, Any]:
        """
        生成视频

        Args:
            prompt: 视频描述 (sora-2-pro-storyboard 不需要)
            image_urls: 输入图片 URL (sora-2-image-to-video 必填)
            n_frames: 视频时长 ("10"/"15"/"25")
            aspect_ratio: 宽高比 ("portrait"/"landscape")
            remove_watermark: 是否去水印
            callback_url: 回调 URL
            wait_for_result: 是否等待结果
            poll_interval: 轮询间隔
            max_wait_time: 最大等待时间

        Returns:
            {
                "task_id": "xxx",
                "status": "success",
                "video_url": "https://...",
                "duration_seconds": 10,
                "cost_usd": 0.15,
                "credits_consumed": 40,
            }
        """
        # 参数验证
        self.validate_prompt(prompt)
        self.validate_image_urls(image_urls)
        self.validate_frames(n_frames)
        self.validate_aspect_ratio(aspect_ratio)

        duration = int(n_frames)

        try:
            # 构建输入参数
            input_params = self._build_input_params(
                prompt=prompt,
                image_urls=image_urls,
                n_frames=n_frames,
                aspect_ratio=aspect_ratio,
                remove_watermark=remove_watermark,
            )

            # 创建任务请求
            request = CreateTaskRequest(
                model=self.model_id,
                input=input_params,
                callBackUrl=callback_url,
            )

            logger.info(
                f"Creating video task: model={self.model}, duration={duration}s, "
                f"aspect_ratio={aspect_ratio}"
            )

            if wait_for_result:
                result = await self.client.create_and_wait(
                    request,
                    poll_interval=poll_interval,
                    max_wait_time=max_wait_time,
                )
                return self._format_result(result, duration)
            else:
                create_response = await self.client.create_task(request)
                return {
                    "task_id": create_response.task_id,
                    "status": "pending",
                    "video_url": None,
                    "duration_seconds": duration,
                    "cost_usd": 0,
                    "credits_consumed": 0,
                }
        except (KieAPIError, KieTaskFailedError, KieTaskTimeoutError, ValueError):
            raise
        except Exception as e:
            logger.error(
                f"Video generate failed: model={self.model}, "
                f"duration={duration}s, error={e}"
            )
            raise KieAPIError(f"Video generate failed: {e}") from e

    def _build_input_params(
        self,
        prompt: Optional[str],
        image_urls: Optional[List[str]],
        n_frames: str,
        aspect_ratio: str,
        remove_watermark: bool,
    ) -> Dict[str, Any]:
        """构建输入参数"""

        # 转换宽高比枚举
        ar = AspectRatio.PORTRAIT if aspect_ratio == "portrait" else AspectRatio.LANDSCAPE
        frames = VideoFrames(n_frames)

        if self.model == "sora-2-text-to-video":
            return Sora2TextToVideoInput(
                prompt=prompt,
                aspect_ratio=ar,
                n_frames=frames,
                remove_watermark=remove_watermark,
            ).model_dump()

        elif self.model == "sora-2-image-to-video":
            return Sora2ImageToVideoInput(
                prompt=prompt,
                image_urls=image_urls,
                aspect_ratio=ar,
                n_frames=frames,
                remove_watermark=remove_watermark,
            ).model_dump()

        elif self.model == "sora-2-pro-storyboard":
            return Sora2ProStoryboardInput(
                n_frames=frames,
                image_urls=image_urls or [],
                aspect_ratio=ar,
            ).model_dump()

        else:
            raise ValueError(f"Unknown model: {self.model}")

    def _format_result(
        self,
        result: QueryTaskResponse,
        duration_seconds: int,
    ) -> Dict[str, Any]:
        """格式化结果"""
        cost_estimate = self.estimate_cost(duration_seconds)

        # 获取视频 URL (通常只有一个)
        video_url = result.result_urls[0] if result.result_urls else None

        return {
            "task_id": result.task_id,
            "status": result.state.value if result.state else "unknown",
            "video_url": video_url,
            "duration_seconds": duration_seconds,
            "cost_usd": float(cost_estimate.estimated_cost_usd),
            "credits_consumed": cost_estimate.estimated_credits,
            "cost_time_ms": result.cost_time,
        }

    # ============================================================
    # 任务查询
    # ============================================================

    async def query_task(self, task_id: str) -> Dict[str, Any]:
        """
        查询任务状态

        Args:
            task_id: 任务 ID

        Returns:
            任务状态
        """
        try:
            result = await self.client.query_task(task_id)

            video_url = None
            if result.state == TaskState.SUCCESS and result.result_urls:
                video_url = result.result_urls[0]

            return {
                "task_id": result.task_id,
                "status": result.state.value if result.state else "unknown",
                "video_url": video_url,
                "fail_code": result.fail_code,
                "fail_msg": result.fail_msg,
            }
        except KieAPIError:
            raise
        except Exception as e:
            logger.error(f"Query video task failed: task_id={task_id}, error={e}")
            raise KieAPIError(f"Query video task failed: {e}") from e

    # ============================================================
    # 成本计算
    # ============================================================

    def estimate_cost(self, duration_seconds: int) -> CostEstimate:
        """
        估算成本

        Args:
            duration_seconds: 视频时长 (秒)

        Returns:
            成本估算
        """
        cost_per_second = self.config["cost_per_second"]
        credits_per_second = self.config["credits_per_second"]

        total_cost = cost_per_second * duration_seconds
        total_credits = credits_per_second * duration_seconds

        return CostEstimate(
            model=self.model,
            estimated_cost_usd=total_cost,
            estimated_credits=total_credits,
            breakdown={
                "duration_seconds": duration_seconds,
                "cost_per_second": float(cost_per_second),
                "credits_per_second": credits_per_second,
            },
        )

    def calculate_usage(self, duration_seconds: int) -> UsageRecord:
        """计算实际使用量"""
        estimate = self.estimate_cost(duration_seconds)

        return UsageRecord(
            model=self.model,
            model_type=KieModelType.VIDEO,
            video_seconds=duration_seconds,
            cost_usd=estimate.estimated_cost_usd,
            credits_consumed=estimate.estimated_credits,
        )


# ============================================================
# 便捷函数
# ============================================================

async def text_to_video(
    api_key: str,
    prompt: str,
    duration: int = 10,
    aspect_ratio: str = "landscape",
    remove_watermark: bool = True,
    **kwargs,
) -> Dict[str, Any]:
    """
    文本生成视频

    Args:
        api_key: KIE API 密钥
        prompt: 视频描述
        duration: 时长 (10/15 秒)
        aspect_ratio: 宽高比
        remove_watermark: 是否去水印
        **kwargs: 其他参数

    Returns:
        生成结果
    """
    try:
        async with KieClient(api_key) as client:
            adapter = KieVideoAdapter(client, "sora-2-text-to-video")
            return await adapter.generate(
                prompt=prompt,
                n_frames=str(duration),
                aspect_ratio=aspect_ratio,
                remove_watermark=remove_watermark,
                **kwargs,
            )
    except (KieAPIError, KieTaskFailedError, KieTaskTimeoutError, ValueError):
        raise
    except Exception as e:
        logger.error(f"text_to_video failed: duration={duration}s, error={e}")
        raise KieAPIError(f"text_to_video failed: {e}") from e


async def image_to_video(
    api_key: str,
    prompt: str,
    image_url: str,
    duration: int = 10,
    aspect_ratio: str = "landscape",
    remove_watermark: bool = True,
    **kwargs,
) -> Dict[str, Any]:
    """
    图片生成视频

    Args:
        api_key: KIE API 密钥
        prompt: 视频描述
        image_url: 首帧图片 URL
        duration: 时长
        aspect_ratio: 宽高比
        remove_watermark: 是否去水印
        **kwargs: 其他参数

    Returns:
        生成结果
    """
    try:
        async with KieClient(api_key) as client:
            adapter = KieVideoAdapter(client, "sora-2-image-to-video")
            return await adapter.generate(
                prompt=prompt,
                image_urls=[image_url],
                n_frames=str(duration),
                aspect_ratio=aspect_ratio,
                remove_watermark=remove_watermark,
                **kwargs,
            )
    except (KieAPIError, KieTaskFailedError, KieTaskTimeoutError, ValueError):
        raise
    except Exception as e:
        logger.error(f"image_to_video failed: duration={duration}s, error={e}")
        raise KieAPIError(f"image_to_video failed: {e}") from e


async def storyboard_video(
    api_key: str,
    duration: int = 15,
    storyboard_images: Optional[List[str]] = None,
    aspect_ratio: str = "landscape",
    **kwargs,
) -> Dict[str, Any]:
    """
    故事板视频生成

    Args:
        api_key: KIE API 密钥
        duration: 时长 (10/15/25 秒)
        storyboard_images: 故事板图片列表
        aspect_ratio: 宽高比
        **kwargs: 其他参数

    Returns:
        生成结果
    """
    try:
        async with KieClient(api_key) as client:
            adapter = KieVideoAdapter(client, "sora-2-pro-storyboard")
            return await adapter.generate(
                image_urls=storyboard_images,
                n_frames=str(duration),
                aspect_ratio=aspect_ratio,
                **kwargs,
            )
    except (KieAPIError, KieTaskFailedError, KieTaskTimeoutError, ValueError):
        raise
    except Exception as e:
        logger.error(f"storyboard_video failed: duration={duration}s, error={e}")
        raise KieAPIError(f"storyboard_video failed: {e}") from e
