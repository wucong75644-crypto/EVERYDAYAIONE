# å ä½ç¬¦æŒä¹…åŒ–æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¥æœŸ**ï¼š2026-02-01
**çŠ¶æ€**ï¼šè®¾è®¡ä¸­

---

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜èƒŒæ™¯](#é—®é¢˜èƒŒæ™¯)
2. [æ ¸å¿ƒæ–¹æ¡ˆ](#æ ¸å¿ƒæ–¹æ¡ˆ)
3. [æŠ€æœ¯ç»†èŠ‚](#æŠ€æœ¯ç»†èŠ‚)
4. [ä¼˜åŒ–å»ºè®®](#ä¼˜åŒ–å»ºè®®)
5. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
6. [å½±å“æ–‡ä»¶](#å½±å“æ–‡ä»¶)

---

## é—®é¢˜èƒŒæ™¯

### å½“å‰é—®é¢˜

**åˆ·æ–°é¡µé¢åå ä½ç¬¦ä¸¢å¤±**ï¼š

```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
1. å‘èµ·å›¾ç‰‡ç”Ÿæˆè¯·æ±‚
2. çœ‹åˆ°å ä½ç¬¦ï¼šæ–‡å­— "å›¾ç‰‡ç”Ÿæˆä¸­" + ç°è‰²å›¾ç‰‡æ¡†
3. åˆ·æ–°é¡µé¢ï¼ˆæˆ–å…³é—­æ ‡ç­¾é¡µåé‡æ–°æ‰“å¼€ï¼‰
4. âŒ å ä½ç¬¦æ¶ˆå¤±ï¼Œç”¨æˆ·ä¸çŸ¥é“ä»»åŠ¡æ˜¯å¦è¿˜åœ¨è¿›è¡Œä¸­
```

### æ ¹æœ¬åŸå› 

**å ä½ç¬¦åŸºäºä¹è§‚æ›´æ–°ï¼ˆéæŒä¹…åŒ–ï¼‰**ï¼š

```typescript
// å½“å‰å®ç°ï¼šå ä½ç¬¦æ¶ˆæ¯ä¿å­˜åœ¨ useConversationRuntimeStore
const optimisticMessage = {
  id: "streaming-xxx",  // ä¸´æ—¶ID
  content: "å›¾ç‰‡ç”Ÿæˆä¸­",
  image_url: null,
  role: 'assistant'
};

// âŒ é—®é¢˜ï¼šåˆ·æ–°é¡µé¢åï¼ŒRuntimeStore æ¸…ç©ºï¼Œå ä½ç¬¦æ¶ˆå¤±
```

**æ•°æ®å­˜å‚¨ä½ç½®**ï¼š

| æ•°æ® | å­˜å‚¨ä½ç½® | æŒä¹…åŒ– | åˆ·æ–°å |
|-----|---------|-------|--------|
| **å ä½ç¬¦æ¶ˆæ¯** | `useConversationRuntimeStore.optimisticMessages` | âŒ | ä¸¢å¤± |
| **ä»»åŠ¡åˆ—è¡¨** | `useTaskStore.tasks` | âœ… localStorage | ä¿ç•™ |
| **å¯¹è¯æ¶ˆæ¯** | `useChatStore.cache` | âœ… localStorage | ä¿ç•™ |

---

## æ ¸å¿ƒæ–¹æ¡ˆ

### è®¾è®¡æ€è·¯ï¼šåˆ†é˜¶æ®µæŒä¹…åŒ–

**æ ¸å¿ƒç†å¿µ**ï¼š
- **æ–‡å­—å ä½ç¬¦**ï¼šç«‹å³æ˜¾ç¤ºï¼ˆä¹è§‚æ›´æ–°ï¼‰ â†’ æä¾›å³æ—¶åé¦ˆ
- **åª’ä½“å ä½ç¬¦**ï¼šå»¶è¿Ÿæ˜¾ç¤ºï¼ˆæŒä¹…åŒ–ï¼‰ â†’ ä¿è¯åˆ·æ–°åä¸ä¸¢å¤±

### æ–¹æ¡ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·å‘é€å›¾ç‰‡ç”Ÿæˆè¯·æ±‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ1ï¼šç«‹å³åé¦ˆï¼ˆ0msï¼‰ã€‘                                      â”‚
â”‚                                                             â”‚
â”‚  å‰ç«¯åˆ›å»ºï¼šstreaming-xxx æ¶ˆæ¯ï¼ˆä¹è§‚æ›´æ–°ï¼‰                        â”‚
â”‚    {                                                        â”‚
â”‚      id: "streaming-xxx",                                   â”‚
â”‚      content: "å›¾ç‰‡ç”Ÿæˆä¸­",                                   â”‚
â”‚      image_url: null                                        â”‚
â”‚    }                                                        â”‚
â”‚                                                             â”‚
â”‚  æ˜¾ç¤ºï¼š                                                      â”‚
â”‚    âœ… æ–‡å­—å ä½ç¬¦ï¼ˆæ°”æ³¡å†…ï¼‰ï¼š"å›¾ç‰‡ç”Ÿæˆä¸­"                         â”‚
â”‚    âŒ åª’ä½“å ä½ç¬¦ï¼ˆæ°”æ³¡å¤–ï¼‰ï¼šä¸æ˜¾ç¤º                              â”‚
â”‚                                                             â”‚
â”‚  åˆ·æ–°é¡µé¢ â†’ âŒ æ–‡å­—å ä½ç¬¦æ¶ˆå¤±ï¼ˆä¹è§‚æ›´æ–°ä¸¢å¤±ï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ2ï¼šæŒä¹…åŒ–ï¼ˆ~200-500msï¼‰ã€‘                                â”‚
â”‚                                                             â”‚
â”‚  åç«¯åˆ›å»ºï¼šæŒä¹…åŒ–å ä½ç¬¦æ¶ˆæ¯                                     â”‚
â”‚    {                                                        â”‚
â”‚      id: "real-id",                                         â”‚
â”‚      content: "å›¾ç‰‡ç”Ÿæˆä¸­",                                   â”‚
â”‚      image_url: null,          â† âœ… æ— URL = æœªå®Œæˆ            â”‚
â”‚      generation_params: {      â† âœ… æœ‰å‚æ•° = æ­£åœ¨ç”Ÿæˆ         â”‚
â”‚        image: {                                             â”‚
â”‚          aspectRatio: "16:9",                               â”‚
â”‚          outputFormat: "webp",                              â”‚
â”‚          model: "flux-1.1-pro"                              â”‚
â”‚        }                                                    â”‚
â”‚      },                                                     â”‚
â”‚      task_id: "task-xxx"       â† âœ… å…³è”ä»»åŠ¡ID               â”‚
â”‚    }                                                        â”‚
â”‚                                                             â”‚
â”‚  å‰ç«¯å¤„ç†ï¼š                                                   â”‚
â”‚    1. ç§»é™¤ streaming-xxx æ¶ˆæ¯ï¼ˆå»é‡ï¼‰                          â”‚
â”‚    2. æ·»åŠ æŒä¹…åŒ–æ¶ˆæ¯                                          â”‚
â”‚    3. åˆ¤æ–­ï¼šgeneration_params å­˜åœ¨ && image_url === null     â”‚
â”‚                                                             â”‚
â”‚  æ˜¾ç¤ºï¼š                                                      â”‚
â”‚    âœ… æ–‡å­—å ä½ç¬¦ï¼ˆåŸºäºæŒä¹…åŒ–æ¶ˆæ¯ï¼‰                              â”‚
â”‚    âœ… åª’ä½“å ä½ç¬¦ï¼ˆåŸºäºæŒä¹…åŒ–æ¶ˆæ¯ï¼‰                              â”‚
â”‚                                                             â”‚
â”‚  åˆ·æ–°é¡µé¢ â†’ âœ…âœ… ä¸¤ä¸ªå ä½ç¬¦éƒ½ä¿ç•™ï¼ï¼ˆä» localStorage åŠ è½½ï¼‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã€é˜¶æ®µ3ï¼šä»»åŠ¡å®Œæˆï¼ˆ~5-30sï¼‰ã€‘                                  â”‚
â”‚                                                             â”‚
â”‚  åç«¯æ›´æ–°ï¼šæŒä¹…åŒ–æ¶ˆæ¯                                          â”‚
â”‚    {                                                        â”‚
â”‚      id: "real-id",                                         â”‚
â”‚      content: "å›¾ç‰‡ç”Ÿæˆå®Œæˆ",                                 â”‚
â”‚      image_url: "https://..."  â† âœ… æœ‰URL = å·²å®Œæˆ            â”‚
â”‚      generation_params: { image: {...} }                    â”‚
â”‚    }                                                        â”‚
â”‚                                                             â”‚
â”‚  æ˜¾ç¤ºï¼š                                                      â”‚
â”‚    âŒ æ–‡å­—å ä½ç¬¦ï¼ˆcontent ä¸å†æ˜¯ "å›¾ç‰‡ç”Ÿæˆä¸­"ï¼‰                 â”‚
â”‚    âŒ åª’ä½“å ä½ç¬¦ï¼ˆimage_url å­˜åœ¨ï¼‰                             â”‚
â”‚    âœ… å®é™…å›¾ç‰‡                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æŠ€æœ¯ç»†èŠ‚

### 1. å ä½ç¬¦åˆ¤æ–­é€»è¾‘ä¼˜åŒ–

#### å½“å‰é€»è¾‘ï¼ˆMessageItem.tsx:60-78ï¼‰

```typescript
// âŒ é—®é¢˜ï¼šåªåˆ¤æ–­ streaming- æ¶ˆæ¯ï¼Œåˆ·æ–°åæ¶ˆå¤±
const mediaPlaceholderInfo = useMemo(() => {
  if (
    !message.id.startsWith('streaming-') ||
    message.role !== 'assistant' ||
    message.image_url ||
    message.video_url
  ) {
    return null;
  }

  if (message.content.includes(PLACEHOLDER_TEXT.IMAGE_GENERATING)) {
    return { type: 'image', text: PLACEHOLDER_TEXT.IMAGE_GENERATING };
  }
  if (message.content.includes(PLACEHOLDER_TEXT.VIDEO_GENERATING)) {
    return { type: 'video', text: PLACEHOLDER_TEXT.VIDEO_GENERATING };
  }
  return null;
}, [message.id, message.role, message.content, message.image_url, message.video_url]);
```

#### æ”¹è¿›é€»è¾‘

```typescript
// âœ… æ”¹è¿›ï¼šåˆ†ç¦»æ–‡å­—å ä½ç¬¦å’Œåª’ä½“å ä½ç¬¦
const placeholderInfo = useMemo(() => {
  // 1. æ–‡å­—å ä½ç¬¦ï¼šstreaming- æ¶ˆæ¯ï¼ˆä¹è§‚æ›´æ–°ï¼‰
  const isStreamingPlaceholder =
    message.id.startsWith('streaming-') &&
    message.role === 'assistant' &&
    !message.image_url &&
    !message.video_url;

  // 2. åª’ä½“å ä½ç¬¦ï¼šæŒä¹…åŒ–æ¶ˆæ¯ï¼ˆæœ‰ generation_params ä½†æ— åª’ä½“URLï¼‰
  const isPersistentPlaceholder =
    !message.id.startsWith('streaming-') &&  // âœ… éä¸´æ—¶æ¶ˆæ¯
    message.role === 'assistant' &&
    !message.image_url &&
    !message.video_url &&
    (message.generation_params?.image || message.generation_params?.video);  // âœ… æœ‰ç”Ÿæˆå‚æ•°

  // åˆ¤æ–­å ä½ç¬¦ç±»å‹
  if (!isStreamingPlaceholder && !isPersistentPlaceholder) {
    return null;
  }

  // æ ¹æ®å†…å®¹æˆ–å‚æ•°åˆ¤æ–­ç±»å‹
  if (message.content.includes(PLACEHOLDER_TEXT.IMAGE_GENERATING) || message.generation_params?.image) {
    return {
      type: 'image' as const,
      text: PLACEHOLDER_TEXT.IMAGE_GENERATING,
      isStreaming: isStreamingPlaceholder,  // âœ¨ æ–°å¢ï¼šæ ‡è®°æ˜¯å¦ä¸ºæµå¼å ä½ç¬¦
      isPersistent: isPersistentPlaceholder  // âœ¨ æ–°å¢ï¼šæ ‡è®°æ˜¯å¦ä¸ºæŒä¹…åŒ–å ä½ç¬¦
    };
  }
  if (message.content.includes(PLACEHOLDER_TEXT.VIDEO_GENERATING) || message.generation_params?.video) {
    return {
      type: 'video' as const,
      text: PLACEHOLDER_TEXT.VIDEO_GENERATING,
      isStreaming: isStreamingPlaceholder,
      isPersistent: isPersistentPlaceholder
    };
  }
  return null;
}, [message.id, message.role, message.content, message.image_url, message.video_url, message.generation_params]);
```

### 2. å ä½ç¬¦æ˜¾ç¤ºé€»è¾‘

#### æ–‡å­—å ä½ç¬¦ï¼ˆMessageItem.tsx:222-226ï¼‰

```typescript
// âœ… æ–‡å­—å ä½ç¬¦ï¼šstreaming- æˆ–æŒä¹…åŒ–éƒ½æ˜¾ç¤º
{((isRegenerating || isStreaming) && !message.content) ? (
  <LoadingPlaceholder text={PLACEHOLDER_TEXT.CHAT_THINKING} />
) : placeholderInfo ? (
  <LoadingPlaceholder text={placeholderInfo.text} />
) : (
  message.content
)}
```

#### åª’ä½“å ä½ç¬¦ï¼ˆMessageMedia.tsxï¼‰

```typescript
// âœ… åª’ä½“å ä½ç¬¦ï¼šåªæœ‰æŒä¹…åŒ–å ä½ç¬¦æ‰æ˜¾ç¤ºç°è‰²æ¡†
<MessageMedia
  isGenerating={!!placeholderInfo?.isPersistent}  // âœ¨ æ”¹ï¼šåªæœ‰æŒä¹…åŒ–å ä½ç¬¦æ‰æ˜¾ç¤ºåª’ä½“æ¡†
  generatingType={placeholderInfo?.type}
  imageAspectRatio={actualImageAspectRatio}
  videoAspectRatio={actualVideoAspectRatio}
/>
```

### 3. åç«¯åˆ›å»ºæŒä¹…åŒ–å ä½ç¬¦

#### å›¾ç‰‡ç”Ÿæˆï¼ˆbackend/api/routes/image.pyï¼‰

```python
# åˆ›å»ºå›¾ç‰‡ç”Ÿæˆä»»åŠ¡åï¼Œç«‹å³åˆ›å»ºæŒä¹…åŒ–å ä½ç¬¦æ¶ˆæ¯
placeholder_message = await create_message(
    conversation_id=conversation_id,
    content="å›¾ç‰‡ç”Ÿæˆä¸­",
    image_url=None,  # âœ… æ— URLè¡¨ç¤ºæœªå®Œæˆ
    generation_params={
        "image": {
            "aspectRatio": aspect_ratio,
            "outputFormat": output_format,
            "model": model
        }
    },
    task_id=response.task_id,  # âœ¨ å…³è”ä»»åŠ¡ID
    role='assistant'
)

# è¿”å›ç»™å‰ç«¯
return {
    "task_id": response.task_id,
    "placeholder_message": placeholder_message,  # âœ¨ è¿”å›å ä½ç¬¦æ¶ˆæ¯
    "status": "pending"
}
```

#### è§†é¢‘ç”Ÿæˆï¼ˆbackend/api/routes/video.pyï¼‰

```python
# åŒå›¾ç‰‡ç”Ÿæˆé€»è¾‘
placeholder_message = await create_message(
    conversation_id=conversation_id,
    content="è§†é¢‘ç”Ÿæˆä¸­",
    video_url=None,  # âœ… æ— URLè¡¨ç¤ºæœªå®Œæˆ
    generation_params={
        "video": {
            "frames": frames,
            "aspectRatio": aspect_ratio,
            "removeWatermark": remove_watermark,
            "model": model
        }
    },
    task_id=response.task_id,  # âœ¨ å…³è”ä»»åŠ¡ID
    role='assistant'
)
```

### 4. æ•°æ®åº“Schemaå˜åŒ–

#### æ¶ˆæ¯è¡¨ï¼ˆmessagesï¼‰

```typescript
// æ·»åŠ  task_id å­—æ®µï¼ˆå¯é€‰ï¼‰
interface Message {
  id: string;
  conversation_id: string;
  role: 'user' | 'assistant';
  content: string;
  image_url?: string | null;
  video_url?: string | null;
  generation_params?: GenerationParams;
  task_id?: string;  // âœ¨ æ–°å¢ï¼šå…³è”å¼‚æ­¥ä»»åŠ¡
  created_at: string;
}
```

#### è¿ç§»è„šæœ¬

```sql
-- æ·»åŠ  task_id å­—æ®µ
ALTER TABLE messages ADD COLUMN task_id VARCHAR(100);

-- åˆ›å»ºç´¢å¼•ï¼ˆä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼‰
CREATE INDEX idx_messages_task_id ON messages(task_id);
```

---

## ä¼˜åŒ–å»ºè®®

### âœ… ä¼˜åŒ–1ï¼šä»»åŠ¡çŠ¶æ€å…³è”ï¼ˆå¼ºçƒˆæ¨èï¼‰

#### é—®é¢˜

å½“å‰å ä½ç¬¦æ— æ³•åŒºåˆ†ï¼š
- ç”Ÿæˆä¸­ï¼ˆæ­£å¸¸è¿›è¡Œï¼‰
- ç”Ÿæˆå¤±è´¥ï¼ˆéœ€è¦é‡è¯•ï¼‰
- ä»»åŠ¡æš‚åœï¼ˆç­‰å¾…æ¢å¤ï¼‰

#### è§£å†³æ–¹æ¡ˆ

**åˆ©ç”¨ç°æœ‰ `useTaskStore` çš„ä»»åŠ¡çŠ¶æ€**ï¼š

```typescript
// useTaskStore.ts å·²æœ‰ä»»åŠ¡çŠ¶æ€
export type TaskStatus = 'pending' | 'streaming' | 'polling' | 'completed' | 'error';

export interface MediaTask {
  taskId: string;
  status: TaskStatus;  // âœ… å·²æœ‰ï¼
  placeholderId: string;
  // ...
}
```

**å‰ç«¯å…³è”ä»»åŠ¡çŠ¶æ€**ï¼š

```typescript
// MessageItem.tsx - æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
const task = useTaskStore.getState().mediaTasks.get(message.task_id);
const taskStatus = task?.status;  // 'pending' | 'polling' | 'completed' | 'error'

// æ ¹æ®ä»»åŠ¡çŠ¶æ€æ˜¾ç¤ºä¸åŒå ä½ç¬¦
{taskStatus === 'error' ? (
  <ErrorPlaceholder
    text="å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œç‚¹å‡»é‡è¯•"
    onRetry={() => onRegenerate?.(message.id)}
  />
) : taskStatus === 'pending' || taskStatus === 'polling' ? (
  <>
    <LoadingPlaceholder text="å›¾ç‰‡ç”Ÿæˆä¸­" />
    <MediaPlaceholder type="image" {...placeholderSize} />
  </>
) : null}
```

**æ–°å»º ErrorPlaceholder ç»„ä»¶**ï¼š

```typescript
// frontend/src/components/chat/ErrorPlaceholder.tsx
interface ErrorPlaceholderProps {
  text: string;
  onRetry?: () => void;
}

export default function ErrorPlaceholder({ text, onRetry }: ErrorPlaceholderProps) {
  return (
    <div className="flex items-center space-x-2 text-red-500">
      <AlertCircle className="w-4 h-4" />
      <span className="text-sm">{text}</span>
      {onRetry && (
        <button
          onClick={onRetry}
          className="text-sm text-blue-600 hover:text-blue-700 underline"
        >
          é‡è¯•
        </button>
      )}
    </div>
  );
}
```

#### ä¼˜å…ˆçº§

â­â­â­â­â­ **å¿…é¡»åš**ï¼ˆè¦†ç›–å¼‚å¸¸åœºæ™¯ï¼Œç”¨æˆ·ä½“éªŒå…³é”®ï¼‰

---

### âš ï¸ ä¼˜åŒ–2ï¼šlocalStorageä¸´æ—¶å…œåº•ï¼ˆä¸æ¨èï¼‰

#### é—®é¢˜

ç”¨æˆ·ç‚¹å‡»å‘é€å0-500mså†…åˆ·æ–°é¡µé¢ï¼Œæ–‡å­—å ä½ç¬¦æ¶ˆå¤±ã€‚

#### æ¦‚ç‡è¯„ä¼°

- ç”¨æˆ·åˆšç‚¹å‘é€å°±åˆ·æ–° < 0.1%ï¼ˆæå°æ¦‚ç‡ï¼‰
- å¤§å¤šæ•°ç”¨æˆ·ä¼šç­‰å¾…å“åº”
- 500msåæŒä¹…åŒ–æ¶ˆæ¯å·²åˆ›å»ºï¼Œå ä½ç¬¦ä¼šç«‹å³æ˜¾ç¤º

#### æˆæœ¬åˆ†æ

- âŒ å¢åŠ å¤æ‚åº¦ï¼šéœ€è¦ç®¡ç†è¿‡æœŸé€»è¾‘ã€æ¸…ç†é€»è¾‘
- âŒ åŒé‡å­˜å‚¨ï¼šlocalStorage + RuntimeStore å®¹æ˜“ä¸ä¸€è‡´
- âŒ è¾¹ç•Œé—®é¢˜ï¼š1åˆ†é’Ÿè¿‡æœŸæ—¶é—´ä¸ä¸€å®šåˆç†

#### æ›¿ä»£æ–¹æ¡ˆ

1. **ä¼˜åŒ–åç«¯å“åº”é€Ÿåº¦**ï¼šä»500msä¼˜åŒ–åˆ°200msï¼ˆæ›´æœ‰ä»·å€¼ï¼‰
2. **æ¥å—è¾¹ç¼˜åœºæ™¯**ï¼š0.1%æ¦‚ç‡ï¼Œæˆæœ¬æ”¶ç›Šæ¯”ä¸é«˜

#### ä¼˜å…ˆçº§

â­â­ **ä¸æ¨è**ï¼ˆè¾¹ç¼˜åœºæ™¯ï¼ŒæŠ•å…¥äº§å‡ºæ¯”ä½ï¼‰

---

### âœ… ä¼˜åŒ–3ï¼šå°ºå¯¸ç»‘å®šï¼ˆå·²å®Œæˆï¼‰

#### å½“å‰å®ç°

```typescript
// MessageItem.tsx:56-57
const actualImageAspectRatio = message.generation_params?.image?.aspectRatio ?? savedSettings.image.aspectRatio;
const actualVideoAspectRatio = message.generation_params?.video?.aspectRatio ?? savedSettings.video.aspectRatio;

// MessageMedia.tsx:288-295
const imagePlaceholderSize = useMemo(
  () => getImagePlaceholderSize(imageAspectRatio),  // âœ… æ ¹æ®å®½é«˜æ¯”è®¡ç®—å°ºå¯¸
  [imageAspectRatio]
);

// settingsStorage.ts:120-154
export function getImagePlaceholderSize(aspectRatio: AspectRatio): PlaceholderSize {
  const [w, h] = aspectRatio.split(':').map(Number);
  // è®¡ç®—ç²¾ç¡®å®½é«˜ï¼Œé¿å…å¸ƒå±€è·³åŠ¨
  if (w > h) {
    return {
      width: PLACEHOLDER_BASE_SIZE,
      height: Math.round(PLACEHOLDER_BASE_SIZE * (h / w)),
    };
  }
  // ...
}
```

#### ä¼˜å…ˆçº§

âœ… **å·²å®Œæˆ**ï¼Œæ— éœ€é¢å¤–å·¥ä½œ

---

## å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2å¤©ï¼‰ï¼šæ ¸å¿ƒåŠŸèƒ½

#### åç«¯ä¿®æ”¹

1. **æ·»åŠ  task_id å­—æ®µ**
   - [ ] `backend/schemas/message.py` - æ·»åŠ  `task_id: Optional[str]`
   - [ ] æ•°æ®åº“è¿ç§»è„šæœ¬

2. **åˆ›å»ºæŒä¹…åŒ–å ä½ç¬¦**
   - [ ] `backend/api/routes/image.py` - å›¾ç‰‡ç”Ÿæˆæ—¶åˆ›å»ºå ä½ç¬¦æ¶ˆæ¯
   - [ ] `backend/api/routes/video.py` - è§†é¢‘ç”Ÿæˆæ—¶åˆ›å»ºå ä½ç¬¦æ¶ˆæ¯

#### å‰ç«¯ä¿®æ”¹

3. **å ä½ç¬¦åˆ¤æ–­é€»è¾‘**
   - [ ] `frontend/src/components/chat/MessageItem.tsx` - åŒºåˆ† `isStreaming` å’Œ `isPersistent`
   - [ ] æ–‡å­—å ä½ç¬¦æ˜¾ç¤ºé€»è¾‘ï¼ˆ222-226è¡Œï¼‰
   - [ ] åª’ä½“å ä½ç¬¦ä¼ å‚ï¼ˆ265-268è¡Œï¼‰

4. **åª’ä½“å ä½ç¬¦æ˜¾ç¤º**
   - [ ] `frontend/src/components/chat/MessageMedia.tsx` - ä¿®æ”¹ `isGenerating` æ¡ä»¶

5. **ç±»å‹å®šä¹‰**
   - [ ] `frontend/src/services/message.ts` - æ·»åŠ  `task_id?: string`

6. **ç§»é™¤ä¹è§‚æ›´æ–°å ä½ç¬¦**
   - [ ] `frontend/src/hooks/handlers/useImageMessageHandler.ts` - ç§»é™¤ `addMediaPlaceholder`
   - [ ] `frontend/src/hooks/handlers/useVideoMessageHandler.ts` - ç§»é™¤ `addMediaPlaceholder`

#### æµ‹è¯•

7. **åŠŸèƒ½æµ‹è¯•**
   - [ ] å‘é€å›¾ç‰‡ç”Ÿæˆè¯·æ±‚ â†’ ç«‹å³çœ‹åˆ°æ–‡å­—å ä½ç¬¦
   - [ ] ~500mså â†’ çœ‹åˆ°åª’ä½“å ä½ç¬¦
   - [ ] åˆ·æ–°é¡µé¢ â†’ å ä½ç¬¦ä¾ç„¶å­˜åœ¨
   - [ ] ä»»åŠ¡å®Œæˆ â†’ å ä½ç¬¦æ¶ˆå¤±ï¼Œæ˜¾ç¤ºå®é™…å›¾ç‰‡

---

### ç¬¬äºŒé˜¶æ®µï¼ˆ1å¤©ï¼‰ï¼šä»»åŠ¡çŠ¶æ€å…³è”

8. **ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º**
   - [ ] `frontend/src/components/chat/ErrorPlaceholder.tsx` - æ–°å»ºå¤±è´¥å ä½ç¬¦ç»„ä»¶
   - [ ] `frontend/src/components/chat/MessageItem.tsx` - å…³è”ä»»åŠ¡çŠ¶æ€ï¼Œå·®å¼‚åŒ–æ˜¾ç¤º

9. **æµ‹è¯•**
   - [ ] å›¾ç‰‡ç”Ÿæˆå¤±è´¥ â†’ æ˜¾ç¤ºå¤±è´¥å ä½ç¬¦ + é‡è¯•æŒ‰é’®
   - [ ] ç‚¹å‡»é‡è¯• â†’ é‡æ–°ç”Ÿæˆ

---

## å½±å“æ–‡ä»¶

### å¿…é¡»ä¿®æ”¹

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | å·¥ä½œé‡ |
|-----|---------|-------|
| **backend/schemas/message.py** | æ·»åŠ  `task_id` å­—æ®µ | 5åˆ†é’Ÿ |
| **backend/api/routes/image.py** | åˆ›å»ºå ä½ç¬¦æ¶ˆæ¯æ—¶å…³è”ä»»åŠ¡ | 30åˆ†é’Ÿ |
| **backend/api/routes/video.py** | åˆ›å»ºå ä½ç¬¦æ¶ˆæ¯æ—¶å…³è”ä»»åŠ¡ | 30åˆ†é’Ÿ |
| **frontend/src/services/message.ts** | ç±»å‹å®šä¹‰æ·»åŠ  `task_id` | 5åˆ†é’Ÿ |
| **frontend/src/components/chat/MessageItem.tsx** | å ä½ç¬¦åˆ¤æ–­é€»è¾‘ï¼ˆ60-78è¡Œï¼‰ | 1å°æ—¶ |
| **frontend/src/components/chat/MessageMedia.tsx** | åª’ä½“å ä½ç¬¦æ˜¾ç¤ºæ¡ä»¶ | 15åˆ†é’Ÿ |
| **frontend/src/hooks/handlers/useImageMessageHandler.ts** | ç§»é™¤ `addMediaPlaceholder` | 15åˆ†é’Ÿ |
| **frontend/src/hooks/handlers/useVideoMessageHandler.ts** | ç§»é™¤ `addMediaPlaceholder` | 15åˆ†é’Ÿ |

### å¯é€‰ä¿®æ”¹ï¼ˆä¼˜åŒ–1ï¼‰

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | å·¥ä½œé‡ |
|-----|---------|-------|
| **frontend/src/components/chat/ErrorPlaceholder.tsx** | æ–°å»ºå¤±è´¥å ä½ç¬¦ç»„ä»¶ | 30åˆ†é’Ÿ |
| **frontend/src/components/chat/MessageItem.tsx** | å…³è”ä»»åŠ¡çŠ¶æ€ | 30åˆ†é’Ÿ |

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] **ç«‹å³åé¦ˆ**ï¼šå‘é€è¯·æ±‚åç«‹å³çœ‹åˆ°æ–‡å­—å ä½ç¬¦
- [ ] **æŒä¹…åŒ–**ï¼š~500msåçœ‹åˆ°åª’ä½“å ä½ç¬¦
- [ ] **åˆ·æ–°ä¿ç•™**ï¼šåˆ·æ–°é¡µé¢åä¸¤ä¸ªå ä½ç¬¦éƒ½åœ¨
- [ ] **ä»»åŠ¡å®Œæˆ**ï¼šä»»åŠ¡å®Œæˆåå ä½ç¬¦æ¶ˆå¤±ï¼Œæ˜¾ç¤ºå®é™…åª’ä½“
- [ ] **å¤±è´¥é‡è¯•**ï¼šä»»åŠ¡å¤±è´¥åæ˜¾ç¤ºå¤±è´¥å ä½ç¬¦ + é‡è¯•æŒ‰é’®

### æ€§èƒ½éªŒæ”¶

- [ ] **æ— å¸ƒå±€è·³åŠ¨**ï¼šå ä½ç¬¦å°ºå¯¸ä¸å®é™…åª’ä½“ä¸€è‡´
- [ ] **æ— å†…å­˜æ³„æ¼**ï¼šåˆ·æ–°é¡µé¢åå†…å­˜æ­£å¸¸
- [ ] **ç¼–è¯‘é€šè¿‡**ï¼š`npm run build` æ— é”™è¯¯

---

## æŠ€æœ¯å€ºåŠ¡

### å·²çŸ¥é™åˆ¶

1. **0-500msçª—å£æœŸ**ï¼šåˆ·æ–°é¡µé¢ä¼šä¸¢å¤±æ–‡å­—å ä½ç¬¦ï¼ˆæ¥å—è¾¹ç¼˜åœºæ™¯ï¼‰
2. **ä»»åŠ¡çŠ¶æ€åŒæ­¥**ï¼šéœ€è¦å®šæœŸæ¸…ç†å·²å®Œæˆä»»åŠ¡çš„ `task_id` å…³è”

### æœªæ¥ä¼˜åŒ–

1. **WebSocketæ¨é€**ï¼šä»»åŠ¡çŠ¶æ€å˜åŒ–å®æ—¶æ¨é€ï¼Œå‡å°‘è½®è¯¢
2. **ç¦»çº¿æ”¯æŒ**ï¼šServiceWorkerç¼“å­˜å ä½ç¬¦çŠ¶æ€

---

## å‚è€ƒæ–‡æ¡£

- [TECH_MEDIA_PLACEHOLDER.md](./TECH_MEDIA_PLACEHOLDER.md) - åª’ä½“å ä½ç¬¦æŠ€æœ¯æ–‡æ¡£
- [TECH_TASK_PERSISTENCE.md](./TECH_TASK_PERSISTENCE.md) - ä»»åŠ¡æŒä¹…åŒ–æŠ€æœ¯æ–‡æ¡£
- [CURRENT_ISSUES.md](../CURRENT_ISSUES.md#2026-02-01-ç»Ÿä¸€å¤±è´¥é‡æ–°ç”Ÿæˆé€»è¾‘å®Œæˆ) - å½“å‰é—®é¢˜è¿½è¸ª

---

## æ›´æ–°æ—¥å¿—

- **2026-02-01**ï¼šåˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆæ–¹æ¡ˆè®¾è®¡
