# 聊天系统重构执行清单

> **创建时间**：2026-02-01
> **关联文档**：[聊天系统综合重构与持久化总规划.md](./聊天系统综合重构与持久化总规划.md)
> **状态**：进行中
> **总进度**：21/35 任务完成（60%）

---

## 📊 整体进度仪表盘

### 阶段总览

| 阶段 | 状态 | 任务数 | 已完成 | 预估工时 | 实际工时 | 开始日期 | 完成日期 | 进度 |
|------|------|--------|--------|---------|---------|---------|---------|------|
| **阶段0：短期修复** | ✅ 已完成 | 9 | 9/9 | 9.5h | - | 2026-02-01 | 2026-02-01 | ![100%](https://progress-bar.dev/100) |
| **阶段1：统一缓存写入** | ✅ 已完成 | 3 | 3/3 | 4h | - | 2026-02-01 | 2026-02-01 | ![100%](https://progress-bar.dev/100) |
| **阶段2：合并发送器处理器** | ✅ 已完成 | 6 | 5/6 | 8-12h | - | 2026-02-01 | 2026-02-01 | ![83%](https://progress-bar.dev/83) |
| **阶段3：统一轮询管理器** | ✅ 已完成 | 2 | 2/2 | 4h | - | 2026-02-01 | 2026-02-01 | ![100%](https://progress-bar.dev/100) |
| **阶段4：提取任务通知逻辑** | ✅ 已完成 | 2 | 2/2 | 4h | - | 2026-02-01 | 2026-02-01 | ![100%](https://progress-bar.dev/100) |
| **阶段5：重新设计状态管理** | ❌ 待执行 | 4 | 0/4 | 16-24h | - | - | - | ![0%](https://progress-bar.dev/0) |
| **阶段6：占位符持久化** | ❌ 待执行 | 5 | 0/5 | 16-24h | - | - | - | ![0%](https://progress-bar.dev/0) |
| **阶段7：性能优化（可选）** | ⏸️ 可选 | 4 | 0/4 | 10h | - | - | - | ![0%](https://progress-bar.dev/0) |
| **总计** | - | **35** | **21/35** | **9-15天** | - | - | - | ![60%](https://progress-bar.dev/60) |

**状态图例**：
- ❌ 待执行 | 🔄 进行中 | ✅ 已完成 | ⚠️ 受阻 | ⏸️ 可选

---

## 🎯 关键里程碑

| 里程碑 | 目标 | 状态 | 目标日期 | 完成日期 | 备注 |
|-------|------|------|---------|---------|------|
| 🎯 **M1：短期问题修复** | 完成阶段0所有任务 | ✅ | Day 3 | 2026-02-01 | 快速修复高优问题 |
| 🎯 **M2：缓存架构统一** | 完成阶段1-2 | ✅ | Day 6 | 2026-02-01 | 阶段1-2已完成 |
| 🎯 **M3：状态管理清晰** | 完成阶段3-5 | 🔄 | Day 11 | - | 阶段3-4已完成，待阶段5 |
| 🎯 **M4：持久化功能完成** | 完成阶段6 | ❌ | Day 14 | - | 实现任务恢复 |
| 🎯 **M5：性能优化（可选）** | 完成阶段7 | ⏸️ | Day 16 | - | 提升用户体验 |

---

## 📝 详细任务清单

### 阶段0：短期修复（9个任务）

> **目标**：快速修复明确的边界 case 和高优先级问题
> **预估工时**：9.5小时
> **状态**：✅ 已完成
> **⚠️ 重要**：任务顺序已调整，0.4 是 0.1 的前置依赖

| 任务 | 状态 | 优先级 | 预估 | 实际 | 开始 | 完成 | 问题 | 文件 | 负责人 | 备注 |
|------|------|--------|------|------|------|------|------|------|-------|------|
| **0.4** 优化 MessageArea 兼容层 | ✅ | 🔴 **最高** | 2h | - | 2026-02-01 | 2026-02-01 | 问题14 | [MessageArea.tsx](../../frontend/src/components/chat/MessageArea.tsx) | - | **⚠️ 前置任务**：Map替代index，为0.1铺路 |
| **0.1** 修复聊天流式缓存写入路径 | ✅ | 🔴 高 | 1h | - | 2026-02-01 | 2026-02-01 | 问题12 | [useMessageCallbacks.tsx](../../frontend/src/hooks/useMessageCallbacks.tsx) | - | **依赖0.4**：通过优化后的兼容层 |
| **0.2** 优化消息去重逻辑 | ✅ | 🔴 高 | 2h | - | 2026-02-01 | 2026-02-01 | 问题13/33 | [mergeOptimisticMessages.ts](../../frontend/src/utils/mergeOptimisticMessages.ts) | - | 优先使用 client_request_id |
| **0.3** 修复侧边栏缓存同步竞态 | ✅ | 🟡 中 | 1h | - | 2026-02-01 | 2026-02-01 | 问题16 | [ConversationList.tsx](../../frontend/src/components/chat/ConversationList.tsx) | - | - |
| **0.5** 修复模型切换与用户选择冲突 | ✅ | 🔴 高 | 1h | - | 2026-02-01 | 2026-02-01 | 问题20 | [useModelSelection.ts](../../frontend/src/hooks/useModelSelection.ts) | - | ⭐ 用户重点关注 |
| **0.6** 修复消息列表key策略 | ✅ | 🔴 高 | 0.5h | - | 2026-02-01 | 2026-02-01 | 问题38 | [MessageArea.tsx](../../frontend/src/components/chat/MessageArea.tsx) | - | 移除index fallback |
| **0.7** 提取图片URL分割为共享函数 | ✅ | 🟡 中 | 0.5h | - | 2026-02-01 | 2026-02-01 | 问题19 | [imageUtils.ts](../../frontend/src/utils/imageUtils.ts) | - | parseImageUrls + getFirstImageUrl |
| **0.8** 增加LRU清理容量 | ✅ | 🟡 中 | 0.5h | - | 2026-02-01 | 2026-02-01 | 问题31 | [Chat.tsx](../../frontend/src/pages/Chat.tsx) | - | 10→15 |
| **0.9** 统一错误日志 | ✅ | 🟡 中 | 1h | - | 2026-02-01 | 2026-02-01 | 问题22 | [logger.ts](../../frontend/src/utils/logger.ts) | - | 已迁移 taskRestoration.ts、message.ts |

**完成标准**：
- ✅ 所有任务通过验证测试
- ✅ 无 TypeScript 编译错误
- ✅ 现有功能不受影响

---

### 阶段1：统一缓存写入（3个任务）

> **目标**：统一缓存写入路径，消除不一致问题
> **预估工时**：4小时
> **状态**：✅ 已完成
> **前置依赖**：阶段0完成

| 任务 | 状态 | 优先级 | 预估 | 实际 | 开始 | 完成 | 问题 | 文件 | 负责人 | 备注 |
|------|------|--------|------|------|------|------|------|------|-------|------|
| **1.1** 重新生成改用 RuntimeStore | ✅ | 🔴 高 | 2h | - | 2026-02-01 | 2026-02-01 | 问题7 | [mediaRegeneration.ts](../../frontend/src/utils/mediaRegeneration.ts) | - | createMediaRegenCallbacks 添加 RuntimeStore 参数 |
| **1.2** 首次发送改用兼容层 | ✅ | 🔴 高 | 1h | - | 2026-02-01 | 2026-02-01 | 问题6 | [useMessageCallbacks.tsx](../../frontend/src/hooks/useMessageCallbacks.tsx) | - | 媒体消息通过 setMessages 兼容层写入 |
| **1.3** 删除旧缓存写入方法 | ✅ | 🟡 中 | 1h | - | 2026-02-01 | 2026-02-01 | - | [useChatStore.ts](../../frontend/src/stores/useChatStore.ts) | - | 删除 4 个 deprecated 方法 |

**完成标准**：
- ✅ 所有缓存写入走统一入口
- ✅ 删除旧方法后无编译错误
- ✅ 发送、重新生成功能正常

---

### 阶段2：合并发送器处理器（6个任务）

> **目标**：消除图片/视频代码重复（~310行）
> **预估工时**：8-12小时
> **状态**：✅ 已完成
> **前置依赖**：阶段1完成

| 任务 | 状态 | 优先级 | 预估 | 实际 | 开始 | 完成 | 问题 | 文件 | 负责人 | 备注 |
|------|------|--------|------|------|------|------|------|------|-------|------|
| **2.1** 提取共享媒体发送器 | ✅ | 🔴 高 | 3h | - | 2026-02-01 | 2026-02-01 | 问题1 | [mediaSender.ts](../../frontend/src/services/messageSender/mediaSender.ts) | - | 统一发送器 |
| **2.2** 合并图片/视频处理器 | ✅ | 🔴 高 | 2h | - | 2026-02-01 | 2026-02-01 | 问题2 | [useMediaMessageHandler.ts](../../frontend/src/hooks/handlers/useMediaMessageHandler.ts) | - | 统一处理器 |
| **2.3** 统一生成核心逻辑 | ⏸️ | 🟡 中 | 4h | - | - | - | 问题3 | [mediaGenerationCore.ts](../../frontend/src/services/messageSender/mediaGenerationCore.ts) | - | 可选优化，暂跳过 |
| **2.4** 删除旧发送器/处理器 | ✅ | 🟡 中 | 1h | - | 2026-02-01 | 2026-02-01 | - | 删除 useImageMessageHandler.ts, useVideoMessageHandler.ts | - | 发送器标记 @deprecated |
| **2.5** 更新调用方 | ✅ | 🟡 中 | 2h | - | 2026-02-01 | 2026-02-01 | - | index.ts, useMessageHandlers.ts, mediaRegeneration.ts | - | 使用新的统一接口 |
| **2.6** 回归测试 | ✅ | 🔴 高 | 2h | - | 2026-02-01 | 2026-02-01 | - | TypeScript 编译通过 | - | 需手工验证媒体功能 |

**完成标准**：
- ✅ 消除 310 行重复代码
- ✅ 新增模型只需扩展枚举
- ✅ 图片/视频发送、重新生成功能正常

---

### 阶段3：统一轮询管理器（2个任务）

> **目标**：消除轮询逻辑重复（~90行）
> **预估工时**：4小时
> **状态**：✅ 已完成
> **前置依赖**：阶段2完成

| 任务 | 状态 | 优先级 | 预估 | 实际 | 开始 | 完成 | 问题 | 文件 | 负责人 | 备注 |
|------|------|--------|------|------|------|------|------|------|-------|------|
| **3.1** 删除 polling.ts 重复代码 | ✅ | 🔴 高 | 2h | - | 2026-02-01 | 2026-02-01 | 问题4 | [polling.ts](../../frontend/src/utils/polling.ts) | - | 精简147→22行，删除未使用的PollingManager |
| **3.2** 验证 useTaskStore 正常工作 | ✅ | 🔴 高 | 2h | - | 2026-02-01 | 2026-02-01 | 问题4 | [useTaskStore.ts](../../frontend/src/stores/useTaskStore.ts) | - | TypeScript编译通过 |

**完成标准**：
- ✅ 只保留一份轮询逻辑
- ✅ 任务轮询功能正常

---

### 阶段4：提取任务通知逻辑（2个任务）

> **目标**：消除任务通知重复（~40行）
> **预估工时**：4小时
> **状态**：✅ 已完成
> **前置依赖**：阶段3完成

| 任务 | 状态 | 优先级 | 预估 | 实际 | 开始 | 完成 | 问题 | 文件 | 负责人 | 备注 |
|------|------|--------|------|------|------|------|------|------|-------|------|
| **4.1** 提取 notifyTaskComplete 函数 | ✅ | 🔴 高 | 2h | - | 2026-02-01 | 2026-02-01 | 问题5 | [taskNotification.ts](../../frontend/src/utils/taskNotification.ts) | - | 新建统一通知函数 |
| **4.2** 更新调用方 | ✅ | 🟡 中 | 2h | - | 2026-02-01 | 2026-02-01 | 问题5 | [useTaskStore.ts](../../frontend/src/stores/useTaskStore.ts) | - | completeTask/completeMediaTask 使用统一函数 |

**完成标准**：
- ✅ 统一任务通知逻辑
- ✅ 任务完成通知正常显示

---

### 阶段5：重新设计状态管理（4个任务）

> **目标**：理清 TaskStore 和 RuntimeStore 职责
> **预估工时**：16-24小时
> **状态**：❌ 待执行
> **前置依赖**：阶段4完成

| 任务 | 状态 | 优先级 | 预估 | 实际 | 开始 | 完成 | 问题 | 文件 | 负责人 | 备注 |
|------|------|--------|------|------|------|------|------|------|-------|------|
| **5.1** 设计协调层 API | ❌ | 🔴 高 | 4h | - | - | - | 问题9 | - | - | 文档设计 |
| **5.2** 实现 useTaskCoordinator | ❌ | 🔴 高 | 8h | - | - | - | 问题9 | `hooks/useTaskCoordinator.ts` (新建) | - | - |
| **5.3** 迁移业务代码 | ❌ | 🔴 高 | 8h | - | - | - | 问题9 | 多个文件 | - | - |
| **5.4** 验证与回归测试 | ❌ | 🔴 高 | 4h | - | - | - | 问题9 | - | - | 所有任务功能 |

**完成标准**：
- ✅ 职责清晰，无重叠
- ✅ API 易用，降低学习成本
- ✅ 所有任务功能正常

---

### 阶段6：占位符持久化（5个任务）

> **目标**：实现刷新页面自动恢复任务
> **预估工时**：16-24小时
> **状态**：❌ 待执行
> **前置依赖**：阶段5完成

| 任务 | 状态 | 优先级 | 预估 | 实际 | 开始 | 完成 | 问题 | 文件 | 负责人 | 备注 |
|------|------|--------|------|------|------|------|------|------|-------|------|
| **6.1** 扩展 Message 类型 | ❌ | 🔴 高 | 2h | - | - | - | 问题8 | [types/](../../frontend/src/types/) | - | 新增 task_id 等字段 |
| **6.2** 修改占位符保存逻辑 | ❌ | 🔴 高 | 4h | - | - | - | 问题8 | 多个发送器 | - | - |
| **6.3** 实现任务恢复检测 | ❌ | 🔴 高 | 6h | - | - | - | 问题8 | `hooks/useTaskRestoration.ts` | - | - |
| **6.4** 实现轮询恢复机制 | ❌ | 🔴 高 | 6h | - | - | - | 问题8 | useTaskStore.ts | - | - |
| **6.5** 端到端测试 | ❌ | 🔴 高 | 4h | - | - | - | 问题8 | - | - | 刷新页面恢复 |

**完成标准**：
- ✅ 刷新页面任务不丢失
- ✅ 自动恢复轮询
- ✅ 任务完成后占位符正常替换

---

### 阶段7：性能优化（4个任务）⏸️ 可选

> **目标**：提升大量消息场景性能
> **预估工时**：10小时
> **状态**：⏸️ 可选
> **前置依赖**：阶段6完成

| 任务 | 状态 | 优先级 | 预估 | 实际 | 开始 | 完成 | 问题 | 文件 | 负责人 | 备注 |
|------|------|--------|------|------|------|------|------|------|-------|------|
| **7.1** 集成虚拟滚动 | ⏸️ | 🔴 高 | 4h | - | - | - | 问题25 | [MessageArea.tsx](../../frontend/src/components/chat/MessageArea.tsx) | - | react-virtuoso |
| **7.2** 优化消息合并算法 | ⏸️ | 🔴 高 | 2h | - | - | - | 问题26 | [mergeOptimisticMessages.ts](../../frontend/src/utils/mergeOptimisticMessages.ts) | - | O(n²)→O(n) |
| **7.3** 整合滚动Hook | ⏸️ | 🟡 中 | 3h | - | - | - | 问题36 | `hooks/useMessageAreaScroll.ts` | - | 5个Hook→1个 |
| **7.4** 图片加载失败重试 | ⏸️ | 🟡 中 | 1h | - | - | - | 问题37 | [MessageMedia.tsx](../../frontend/src/components/chat/MessageMedia.tsx) | - | - |

**执行条件**：
1. 用户反馈性能问题
2. 有充足开发时间
3. 前6阶段已完成且稳定

---

## 🚨 风险与阻塞跟踪

| 风险ID | 发现日期 | 描述 | 严重度 | 影响阶段 | 状态 | 解决方案 | 负责人 | 解决日期 |
|-------|---------|------|--------|---------|------|---------|-------|---------|
| - | - | 暂无风险 | - | - | - | - | - | - |

**严重度**：🔴 高 | 🟡 中 | 🟢 低

---

## 📈 每日进度记录

### 2026-02-01（Day 1）

**完成任务**：
- ✅ 0.4 优化 MessageArea 兼容层（Map替代index）
- ✅ 0.1 修复聊天流式缓存写入路径
- ✅ 0.2 优化消息去重逻辑（优先使用 client_request_id）
- ✅ 0.3 修复侧边栏缓存同步竞态
- ✅ 0.5 修复模型切换与用户选择冲突
- ✅ 0.6 修复消息列表key策略（移除index fallback）
- ✅ 0.7 提取图片URL分割为共享函数（imageUtils.ts）
- ✅ 0.8 增加LRU清理容量（10→15）
- ✅ 0.9 统一错误日志（创建 logger.ts，迁移 taskRestoration.ts、message.ts）

**阶段1完成**：
- ✅ 1.1 重新生成改用 RuntimeStore（createMediaRegenCallbacks 添加 RuntimeStore 参数）
- ✅ 1.2 首次发送改用兼容层（媒体消息通过 setMessages 写入）
- ✅ 1.3 删除旧缓存写入方法（删除 4 个 deprecated 方法）

**阶段2完成**：
- ✅ 2.1 创建统一媒体发送器（mediaSender.ts）
- ✅ 2.2 创建统一媒体处理器（useMediaMessageHandler.ts）
- ⏸️ 2.3 泛型化生成核心（可选优化，暂跳过）
- ✅ 2.4 删除旧处理器（useImageMessageHandler.ts, useVideoMessageHandler.ts）
- ✅ 2.5 更新调用方（index.ts, useMessageHandlers.ts, mediaRegeneration.ts）
- ✅ 2.6 回归测试（TypeScript 编译通过）

**阶段3完成**：
- ✅ 3.1 删除 polling.ts 重复代码（精简147→22行，删除未使用的PollingManager类）
- ✅ 3.2 验证 useTaskStore 正常工作（TypeScript编译通过）

**阶段4完成**：
- ✅ 4.1 提取 notifyTaskComplete 函数（新建 taskNotification.ts，统一通知逻辑）
- ✅ 4.2 更新调用方（useTaskStore.ts 的 completeTask/completeMediaTask 改用统一函数）

**里程碑完成**：
- ✅ **M1：短期问题修复** - 阶段0全部完成（9/9）
- ✅ **M2：缓存架构统一** - 阶段1-2完成（8/9）

**进行中任务**：无

**遇到问题**：无
**下一步计划**：进入阶段5（重新设计状态管理）

---

## 📋 使用说明

### 如何更新状态

1. **开始任务**：
   - 将状态从 ❌ 改为 🔄
   - 填写"开始"日期
   - 在"每日进度记录"中记录

2. **完成任务**：
   - 将状态改为 ✅
   - 填写"实际"工时和"完成"日期
   - 更新阶段的"已完成"计数
   - 在"每日进度记录"中记录

3. **遇到阻塞**：
   - 将状态改为 ⚠️
   - 在"风险与阻塞跟踪"中添加记录
   - 填写详细描述、影响、解决方案

4. **完成阶段**：
   - 检查所有任务都是 ✅
   - 更新阶段状态为 ✅
   - 更新"关键里程碑"状态
   - 在"每日进度记录"中记录

### 最佳实践

- **每日更新**：每天工作结束前更新进度
- **及时记录**：遇到问题立即记录，不要拖延
- **详细备注**：重要决策或变更记录在"备注"列
- **保持同步**：与团队成员保持沟通，避免重复工作

---

## 🔗 相关文档

- [聊天系统综合重构与持久化总规划](./聊天系统综合重构与持久化总规划.md) - 详细技术方案
- [缓存即状态重构方案](./缓存即状态重构方案.md) - 已完成的重构说明
- [CURRENT_ISSUES.md](../CURRENT_ISSUES.md) - 当前已知问题
- [PROJECT_OVERVIEW.md](../PROJECT_OVERVIEW.md) - 项目总览

---

**最后更新**：2026-02-01
**更新人**：用户
**版本**：v1.1
